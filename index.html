<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDS Foto</title>
  <link rel="manifest" href="manifest.json">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#777;
      --line:#e7e7e7;

      --yellow:#ffd400;
      --yellow2:#fff1a8;
      --grayCard:#f2f2f2;
      --green:#0a7a2f;
      --greenBg:#eefaf2;

      --red:#b00020;
    }

    body{
      font-family: Onest, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:14px;
      max-width:720px;
    }

    *{ border-radius:12px; }

    .card{
      border:1px solid var(--line);
      padding:12px;
      background:#fff;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }

    input, textarea{
      width:100%;
      padding:14px 14px;
      border:1px solid #cfcfcf;
      font-size:16px;
      background:#fff;
      font-family: inherit;
    }
    textarea{ min-height:64px; resize:vertical; }

    .btn{
      border:0;
      padding:14px 16px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      background:#111;
      color:#fff;
    }

    .btn.yellow{
      background:var(--yellow);
      color:#111;
      font-size:20px;
      padding:18px 16px;
    }

    .btn.gray{
      background:#efefef;
      color:#111;
      font-weight:900;
    }

    .btn.green{
      background:var(--green);
      color:#fff;
      font-size:18px;
      padding:18px 16px;
    }

    .btn.red{
      background:var(--red);
      color:#fff;
      font-size:18px;
      padding:18px 16px;
    }

    .sp{height:10px}
    .sp2{height:14px}

    /* Task rows */
    .task{
      border:1px solid var(--line);
      padding:14px 14px;
      display:flex;
      align-items:stretch;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      cursor:pointer;
    }
    .task .left{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
      flex:1 1 auto;
    }
    .task .title{
      font-weight:900;
      font-size:16px;
      line-height:1.1;
    }
    .task .code{
      font-weight:900;
      color:#222;
      background:#fff;
      border:1px solid var(--line);
      padding:10px 12px;
      display:inline-block;
      border-radius:12px;
      width:max-content;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .task.todo{ background:var(--yellow2); border-color:#dfc200; }
    .task.off{ background:var(--grayCard); color:#777; cursor:default; }
    .task.done{ background:var(--greenBg); border-color:var(--green); color:var(--green); }

    .task:active{ transform:scale(.995); }

    /* Suffix buttons */
    .suffixWrap{
      display:flex;
      gap:10px;
      flex-wrap:wrap;          /* ✅ nikdy mimo obrazovku */
      align-items:center;
      justify-content:flex-start;
    }
    .suffixBtn{
      border:1px solid var(--line);
      background:#fff;
      padding:12px 16px;
      font-weight:900;
      min-width:64px;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .suffixBtn.active{
      border-color:#111;
      box-shadow:0 0 0 2px rgba(0,0,0,.08) inset;
    }
    .suffixBtn:active{ transform:scale(.99); }

    /* After photo */
    #afterPhoto{ display:none; }
    .bigSave{ width:100%; }

    /* Express area */
    #expressBlock{ display:none; }
    .subcard{
      border:1px solid var(--line);
      padding:12px;
      background:#fff;
    }

    /* Bottom minimal icons */
    .bottomBar{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .miniIcon{
      flex:1;
      border:1px solid var(--line);
      background:#fff;
      padding:10px 10px;
      font-weight:900;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      color:#111;
    }
    .miniIcon span{ font-size:18px; }

    /* Hidden panels */
    #panelScan, #panelReport { display:none; margin-top:12px; }

    video{width:100%; background:#000; border:1px solid var(--line); }

    dialog{
      border:none;
      padding:14px;
      max-width:460px;
      width:92vw;
    }
    dialog::backdrop{ background:rgba(0,0,0,.45); }

    .muted{ color:var(--muted); font-size:12px; }
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;font-size:12.5px;vertical-align:top}
    th{text-align:left;font-size:11px;color:#666}

    @media (max-width: 380px){
      .task{ padding:12px; }
      .suffixBtn{ min-width:58px; padding:11px 14px; }
    }
  </style>
</head>
<body>

  <!-- TOP -->
  <div class="card">
    <!-- AP -->
    <div class="row">
      <input id="apInput" placeholder="Kód plochy" />
      <button id="btnLoad" class="btn gray" style="min-width:110px">Načítať</button>
    </div>

    <div class="sp"></div>

    <!-- MANUAL / SCAN CODE + CAMERA -->
    <div class="row">
      <input id="manualCode" placeholder="Kód (sken / ručne)" />
      <button id="btnCamera" class="btn gray" style="min-width:110px">Foto</button>
    </div>
  </div>

  <div class="sp2"></div>

  <!-- TASKS -->
  <div id="tasksCard" class="card" style="display:none">
    <div id="taskList" style="display:flex;flex-direction:column;gap:10px"></div>

    <div class="sp2"></div>

    <!-- EXPRESS -->
    <div id="expressBlock" class="subcard">
      <button id="btnExpressToggle" class="btn gray" style="width:100%">Express som odovzdal</button>
      <div id="expressArea" style="display:none;margin-top:10px">
        <textarea id="expressText" placeholder=""></textarea>
        <div class="sp"></div>
        <button id="btnSaveExpress" class="btn" style="width:100%">Uložiť</button>
      </div>
    </div>

    <div class="sp2"></div>

    <!-- FINISH -->
    <button id="btnFinish" class="btn red" style="width:100%">Ukončiť</button>
  </div>

  <!-- AFTER PHOTO -->
  <div id="afterPhoto" class="card">
    <button id="btnSavePhoto" class="btn yellow bigSave">Uložiť</button>
    <div class="sp"></div>
    <div class="row">
      <button id="btnRetake" class="btn gray" style="flex:1">Znova</button>
      <button id="btnBack" class="btn gray" style="flex:1">Späť</button>
    </div>
  </div>

  <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />

  <!-- Bottom icons -->
  <div class="bottomBar">
    <div id="btnMiniScan" class="miniIcon"><span>▣</span><div>Sken</div></div>
    <div id="btnMiniReport" class="miniIcon"><span>≡</span><div>Report</div></div>
  </div>

  <!-- Scan panel -->
  <div id="panelScan" class="card">
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <div class="sp"></div>
    <button id="btnStopScan" class="btn gray" style="width:100%">Stop</button>
  </div>

  <!-- Report panel -->
  <div id="panelReport" class="card">
    <div class="row">
      <input id="repName" placeholder="Kto" />
      <input id="repDate" type="date" />
    </div>
    <div class="sp"></div>
    <div class="row">
      <button id="btnToggleReport" class="btn gray" style="flex:1">Zobraziť</button>
      <button id="btnExportCsv" class="btn gray" style="flex:1">CSV</button>
    </div>
    <div id="reportWrap" style="display:none"></div>
  </div>

  <!-- Confirm finish -->
  <dialog id="dlgFinish">
    <div style="font-weight:900;font-size:18px">Ukončiť?</div>
    <div id="finishText" class="muted" style="margin-top:10px"></div>
    <div class="sp2"></div>
    <div class="row">
      <button id="btnFinishNo" class="btn gray" style="flex:1">Nie</button>
      <button id="btnFinishYes" class="btn red" style="flex:1">Áno</button>
    </div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // ===== DB config =====
  const COL_MAIN_AP = "AP";
  const CODE_COLUMNS = ["B","C","AO"];
  const COL_STAND_FROM = "AG", COL_STAND_TO = "AJ";
  const COL_B1 = "AK";
  const COL_STATIC = "AM";
  const COL_EXPRESS = "AL";

  // ===== Elements =====
  const apInput = document.getElementById('apInput');
  const btnLoad = document.getElementById('btnLoad');

  const manualCode = document.getElementById('manualCode');
  const btnCamera = document.getElementById('btnCamera');

  const tasksCard = document.getElementById('tasksCard');
  const taskList = document.getElementById('taskList');

  const expressBlock = document.getElementById('expressBlock');
  const btnExpressToggle = document.getElementById('btnExpressToggle');
  const expressArea = document.getElementById('expressArea');
  const expressTextEl = document.getElementById('expressText');
  const btnSaveExpress = document.getElementById('btnSaveExpress');

  const btnFinish = document.getElementById('btnFinish');

  const afterPhoto = document.getElementById('afterPhoto');
  const btnSavePhoto = document.getElementById('btnSavePhoto');
  const btnRetake = document.getElementById('btnRetake');
  const btnBack = document.getElementById('btnBack');
  const photoInput = document.getElementById('photoInput');

  const btnMiniScan = document.getElementById('btnMiniScan');
  const btnMiniReport = document.getElementById('btnMiniReport');
  const panelScan = document.getElementById('panelScan');
  const panelReport = document.getElementById('panelReport');

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const btnStopScan = document.getElementById('btnStopScan');

  const repName = document.getElementById('repName');
  const repDate = document.getElementById('repDate');
  const btnToggleReport = document.getElementById('btnToggleReport');
  const btnExportCsv = document.getElementById('btnExportCsv');
  const reportWrap = document.getElementById('reportWrap');

  const dlgFinish = document.getElementById('dlgFinish');
  const finishText = document.getElementById('finishText');
  const btnFinishNo = document.getElementById('btnFinishNo');
  const btnFinishYes = document.getElementById('btnFinishYes');

  // ===== Helpers =====
  function colToIndex(letter){
    let s = String(letter).toUpperCase().replace(/[^A-Z]/g,"");
    let n = 0;
    for (let i=0;i<s.length;i++) n = n*26 + (s.charCodeAt(i)-64);
    return n-1;
  }
  function norm(v){ return String(v ?? "").trim(); }
  function normCode(v){ return norm(v).toUpperCase(); }

  function stripSuffixABC(code){
    const s = normCode(code);
    if(!s) return "";
    if(/[A-Z]$/.test(s)) return s.slice(0, -1);
    return s;
  }
  function tokenizeCodes(cell){
    const raw = normCode(cell);
    if(!raw) return [];
    return raw.split(/[\s,;\/]+/).map(x=>x.trim()).filter(Boolean);
  }
  function safeName(s){ return norm(s).replace(/[\\/:*?"<>|]+/g, "_"); }
  function isoDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function fmtTime(ts){
    return String(ts||"").split("T")[1]?.slice(0,8) || "";
  }

  function refreshCameraButton(){
    const ok = manualCode.value.trim().length > 0;
    btnCamera.className = ok ? "btn red" : "btn gray";
  }

  // ===== DB index =====
  let dbRows=null, idx=null;
  const IDX_AP = colToIndex(COL_MAIN_AP);
  const IDX_CODE_COLS = CODE_COLUMNS.map(c => colToIndex(c));
  const IDX_STAND_FROM = colToIndex(COL_STAND_FROM);
  const IDX_STAND_TO = colToIndex(COL_STAND_TO);
  const IDX_B1 = colToIndex(COL_B1);
  const IDX_STATIC = colToIndex(COL_STATIC);
  const IDX_EXPRESS = colToIndex(COL_EXPRESS);

  async function loadDbXlsx(){
    try{
      const res = await fetch("./db.xlsx", { cache: "no-cache" });
      if(!res.ok) throw new Error("db.xlsx not found");
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      dbRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
      buildIndex();
    }catch(e){
      dbRows=null; idx=null;
    }
  }

  function buildIndex(){
    idx = { byAP:new Map(), byAny:new Map() };
    if(!dbRows) return;

    for(const row of dbRows){
      const ap = normCode(row[IDX_AP]);
      if(ap) idx.byAP.set(ap, row);

      for(const ci of IDX_CODE_COLS){
        const codes = tokenizeCodes(row[ci]);
        for(const c of codes){
          const cc = normCode(c);
          if(!cc) continue;
          idx.byAny.set(cc, row);
          const base = stripSuffixABC(cc);
          if(base) idx.byAny.set(base, row);
        }
      }
    }
  }

  function rowHasAnyText(row, fromIdx, toIdx){
    for(let i=fromIdx;i<=toIdx;i++){
      if(norm(row[i]) !== "") return true;
    }
    return false;
  }

  function getPostersFromRow(row){
    if(!row) return [];
    const from = colToIndex("AG");
    const to   = colToIndex("AM");
    const set = new Set();
    for(let i=from;i<=to;i++){
      const v = norm(row[i]);
      if(!v) continue;
      v.split(/[\s,;\/]+/).map(x=>x.trim()).filter(Boolean).forEach(x=>set.add(x));
    }
    return Array.from(set);
  }

  // ===== Session state =====
  let currentTasks=null;
  let currentPhotoCode="";
  let lastBlob=null;

  let staticSuffix="A"; // default, but card click = bez suffixu
  let expressSaved=false;

  // okamžitá pamäť (aby sa úloha hneď vyfarbila)
  let sessionDone = { stand:false, b1:false, stat:false };
  function resetSessionFlags(){
    sessionDone = { stand:false, b1:false, stat:false };
  }

  // ===== Log/report =====
  const LOG_KEY="ids_foto_log_v10";
  const REP_KEY="ids_rep_name_v10";

  function loadLog(){
    try { return JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); }
    catch { return []; }
  }
  function saveLog(arr){ localStorage.setItem(LOG_KEY, JSON.stringify(arr)); }

  function addLogEntry(ap, photoCode, posters, note, file){
    const now = new Date();
    const entry = {
      ts: now.toISOString().slice(0,19),
      day: isoDate(now),
      who: (repName.value || "").trim(),
      ap: ap || "",
      photoCode: photoCode || "",
      posters: posters || [],
      note: note || "",
      file: file || ""
    };
    const log = loadLog();
    log.push(entry);
    saveLog(log);
  }

  function renderReport(){
    const day = repDate.value || isoDate(new Date());
    const log = loadLog().filter(x => x.day === day);
    if(log.length === 0){
      reportWrap.innerHTML = "<div class='muted' style='margin-top:10px'>—</div>";
      return;
    }
    const rows = log.slice().sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));
    let html = `<table>
      <thead><tr>
        <th>Čas</th><th>Kto</th><th>AP</th><th>Fotil</th><th>Plagáty</th><th>Poznámka</th><th>Súbor</th>
      </tr></thead><tbody>`;
    for(const r of rows){
      html += `<tr>
        <td>${fmtTime(r.ts)}</td>
        <td>${r.who||""}</td>
        <td><b>${r.ap||""}</b></td>
        <td>${r.photoCode||""}</td>
        <td>${(r.posters&&r.posters.length)?r.posters.join(", "):"—"}</td>
        <td>${r.note||""}</td>
        <td>${r.file||""}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
    reportWrap.innerHTML = html;
  }

  function escapeCsv(s){
    const v = String(s ?? "");
    if (/[",\n;]/.test(v)) return `"${v.replaceAll('"','""')}"`;
    return v;
  }
  function exportCsv(){
    const day = repDate.value || isoDate(new Date());
    const log = loadLog().filter(x => x.day === day).sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));
    if(log.length === 0){ alert("—"); return; }
    const header = ["day","time","who","ap","photoCode","posters","note","file"];
    const lines = [header.join(";")];
    for(const r of log){
      lines.push([
        escapeCsv(r.day),
        escapeCsv(fmtTime(r.ts)),
        escapeCsv(r.who),
        escapeCsv(r.ap),
        escapeCsv(r.photoCode),
        escapeCsv((r.posters && r.posters.length) ? r.posters.join(", ") : ""),
        escapeCsv(r.note),
        escapeCsv(r.file)
      ].join(";"));
    }
    const csv = lines.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const filename = `report_${day}_${safeName(repName.value || "repre")}.csv`;
    downloadNow(blob, filename);
  }

  // ===== Task completion =====
  function isPhotoDoneToday(ap, type, standCode, b1Code, staticBase){
    // najprv session (okamžité)
    if(type==="stand" && sessionDone.stand) return true;
    if(type==="b1" && sessionDone.b1) return true;
    if(type==="static" && sessionDone.stat) return true;

    const day = repDate.value || isoDate(new Date());
    const log = loadLog().filter(x => x.day === day && String(x.ap||"") === ap);

    if(type==="stand") return log.some(x => normCode(x.photoCode) === normCode(standCode));
    if(type==="b1")    return log.some(x => normCode(x.photoCode) === normCode(b1Code));
    if(type==="static")return log.some(x => stripSuffixABC(x.photoCode) === normCode(staticBase));
    return false;
  }

  function computeTasks(ap){
    if(!idx) return null;
    const apN = normCode(ap);
    const row = idx.byAP.get(apN);
    if(!row) return null;

    const needStand = rowHasAnyText(row, IDX_STAND_FROM, IDX_STAND_TO);
    const needB1 = norm(row[IDX_B1]) !== "";
    const needStatic = norm(row[IDX_STATIC]) !== "";

    const standCode = norm(row[colToIndex("B")]);
    const b1Code = norm(row[colToIndex("C")]);
    const staticBase = norm(row[colToIndex("AO")]);

    const needExpress = norm(row[IDX_EXPRESS]) !== "";

    return { ap: apN, row, needStand, needB1, needStatic, standCode, b1Code, staticBase, needExpress };
  }

  function makeTaskRow({label, code, state, onClick}){
    const div = document.createElement("div");
    div.className = "task " + state;

    const left = document.createElement("div");
    left.className = "left";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = label;

    const codeEl = document.createElement("div");
    codeEl.className = "code";
    codeEl.textContent = code || "—";

    left.appendChild(title);
    left.appendChild(codeEl);
    div.appendChild(left);

    if(state !== "off" && typeof onClick === "function"){
      div.addEventListener("click", onClick);
    }
    return div;
  }

  // ✅ Statický: karta = bez suffixu, tlačidlá = A/B/C
  function makeStaticRow(t, state){
    const div = document.createElement("div");
    div.className = "task " + state;

    const left = document.createElement("div");
    left.className = "left";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = "Fotím statický plagát";

    const codeEl = document.createElement("div");
    codeEl.className = "code";
    codeEl.textContent = t.staticBase || "—";

    const suffixWrap = document.createElement("div");
    suffixWrap.className = "suffixWrap";
    suffixWrap.style.marginTop = "8px";

    const mkSuffix = (s)=>{
      const b = document.createElement("div");
      b.className = "suffixBtn";
      b.textContent = s;
      if(staticSuffix===s) b.classList.add("active");

      b.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        staticSuffix = s;
        renderTasks();

        const base = t.staticBase || "";
        if(!base) return;
        manualCode.value = base + staticSuffix;
        refreshCameraButton();
        currentPhotoCode = manualCode.value.trim();
        openCamera();
      });
      return b;
    };

    ["A","B","C"].forEach(s=> suffixWrap.appendChild(mkSuffix(s)));

    left.appendChild(title);
    left.appendChild(codeEl);
    left.appendChild(suffixWrap);
    div.appendChild(left);

    // click na kartu = bez suffixu
    if(state !== "off"){
      div.addEventListener("click", ()=>{
        const base = t.staticBase || "";
        if(!base) return;
        manualCode.value = base;
        refreshCameraButton();
        currentPhotoCode = base;
        openCamera();
      });
    }

    return div;
  }

  function updateFinishButton(){
    if(!currentTasks) return;

    const t = currentTasks;
    const doneStand = !t.needStand || isPhotoDoneToday(t.ap,"stand",t.standCode,t.b1Code,t.staticBase);
    const doneB1 = !t.needB1 || isPhotoDoneToday(t.ap,"b1",t.standCode,t.b1Code,t.staticBase);
    const doneStatic = !t.needStatic || isPhotoDoneToday(t.ap,"static",t.standCode,t.b1Code,t.staticBase);
    const doneExpress = !t.needExpress || expressSaved;

    const allDone = doneStand && doneB1 && doneStatic && doneExpress;

    if(allDone){
      btnFinish.textContent = "Všetko hotové";
      btnFinish.className = "btn green";
    }else{
      btnFinish.textContent = "Ukončiť";
      btnFinish.className = "btn red";
    }
  }

  function renderTasks(){
    const t = currentTasks;
    taskList.innerHTML = "";

    // STAND
    const enabledStand = t.needStand && !!t.standCode;
    const doneStand = enabledStand ? isPhotoDoneToday(t.ap,"stand",t.standCode,t.b1Code,t.staticBase) : false;
    const stateStand = enabledStand ? (doneStand ? "done" : "todo") : "off";

    taskList.appendChild(makeTaskRow({
      label:"Fotím stojan",
      code:t.standCode || "—",
      state: stateStand,
      onClick: ()=>{
        manualCode.value = t.standCode || "";
        refreshCameraButton();
        currentPhotoCode = manualCode.value.trim();
        openCamera();
      }
    }));

    // B1
    const enabledB1 = t.needB1 && !!t.b1Code;
    const doneB1 = enabledB1 ? isPhotoDoneToday(t.ap,"b1",t.standCode,t.b1Code,t.staticBase) : false;
    const stateB1 = enabledB1 ? (doneB1 ? "done" : "todo") : "off";

    taskList.appendChild(makeTaskRow({
      label:"Fotím B1",
      code:t.b1Code || "—",
      state: stateB1,
      onClick: ()=>{
        manualCode.value = t.b1Code || "";
        refreshCameraButton();
        currentPhotoCode = manualCode.value.trim();
        openCamera();
      }
    }));

    // STATIC
    const enabledStatic = t.needStatic && !!t.staticBase;
    const doneStatic = enabledStatic ? isPhotoDoneToday(t.ap,"static",t.standCode,t.b1Code,t.staticBase) : false;
    const stateStatic = enabledStatic ? (doneStatic ? "done" : "todo") : "off";

    taskList.appendChild(makeStaticRow(t, stateStatic));

    // EXPRESS block
    if(t.needExpress){
      expressBlock.style.display = "block";
      btnExpressToggle.textContent = expressSaved ? "Express uložený" : "Express som odovzdal";
      if(expressSaved){
        btnExpressToggle.style.background = "var(--greenBg)";
        btnExpressToggle.style.border = "1px solid var(--green)";
        btnExpressToggle.style.color = "var(--green)";
      }else{
        btnExpressToggle.removeAttribute("style");
      }
    }else{
      expressBlock.style.display = "none";
      expressArea.style.display = "none";
      expressTextEl.value = "";
      expressSaved = false;
    }

    updateFinishButton();
  }

  // ===== Photo flow =====
  function openCamera(){
    if(!currentPhotoCode) return;
    photoInput.value = "";
    photoInput.click();
  }

  function downloadNow(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 4000);
  }

  photoInput.addEventListener('change', ()=>{
    const f = photoInput.files && photoInput.files[0];
    if(!f) return;
    lastBlob = f;

    afterPhoto.style.display = "block";
    tasksCard.style.display = "none";
  });

  btnRetake.addEventListener('click', ()=>{
    lastBlob = null;
    afterPhoto.style.display = "none";
    tasksCard.style.display = "block";
    openCamera();
  });

  btnBack.addEventListener('click', ()=>{
    lastBlob = null;
    afterPhoto.style.display = "none";
    tasksCard.style.display = "block";
  });

  btnSavePhoto.addEventListener('click', ()=>{
    if(!lastBlob || !currentTasks) return;

    const code = manualCode.value.trim();
    if(!code) return;

    currentPhotoCode = code;
    const filename = safeName(currentPhotoCode) + ".jpg";
    downloadNow(lastBlob, filename);

    const ap = currentTasks.ap;
    const row = currentTasks.row;
    const posters = row ? getPostersFromRow(row) : [];
    const note = (norm(expressTextEl.value)) ? ("EXPRESS: " + norm(expressTextEl.value)) : "";

    addLogEntry(ap, currentPhotoCode, posters, note, filename);

    if(normCode(currentPhotoCode) === normCode(currentTasks.standCode)) sessionDone.stand = true;
    if(normCode(currentPhotoCode) === normCode(currentTasks.b1Code)) sessionDone.b1 = true;
    if(stripSuffixABC(currentPhotoCode) === normCode(currentTasks.staticBase)) sessionDone.stat = true;

    lastBlob = null;
    afterPhoto.style.display = "none";
    tasksCard.style.display = "block";

    renderTasks();
  });

  // ===== Express =====
  btnExpressToggle.addEventListener("click", ()=>{
    expressArea.style.display = (expressArea.style.display==="block") ? "none" : "block";
    if(expressArea.style.display==="block") expressTextEl.focus();
  });

  btnSaveExpress.addEventListener("click", ()=>{
    expressSaved = true;
    expressArea.style.display = "none";
    renderTasks();
  });

  // ===== Finish =====
  function missingList(){
    const t = currentTasks;
    const miss = [];

    const doneStand = !t.needStand || isPhotoDoneToday(t.ap,"stand",t.standCode,t.b1Code,t.staticBase);
    const doneB1 = !t.needB1 || isPhotoDoneToday(t.ap,"b1",t.standCode,t.b1Code,t.staticBase);
    const doneStatic = !t.needStatic || isPhotoDoneToday(t.ap,"static",t.standCode,t.b1Code,t.staticBase);
    const doneExpress = !t.needExpress || expressSaved;

    if(!doneStand && t.needStand) miss.push("stojan");
    if(!doneB1 && t.needB1) miss.push("B1");
    if(!doneStatic && t.needStatic) miss.push("statický");
    if(!doneExpress && t.needExpress) miss.push("express");

    return miss;
  }

  btnFinish.addEventListener("click", ()=>{
    if(!currentTasks) return;

    const miss = missingList();
    if(miss.length === 0){
      resetToNew();
      return;
    }

    finishText.textContent = "Chýba: " + miss.join(", ");
    dlgFinish.showModal();
  });

  btnFinishNo.addEventListener("click", ()=> dlgFinish.close());
  btnFinishYes.addEventListener("click", ()=>{
    dlgFinish.close();
    resetToNew();
  });

  function resetToNew(){
    tasksCard.style.display = "none";
    afterPhoto.style.display = "none";
    taskList.innerHTML = "";
    currentTasks = null;
    currentPhotoCode = "";
    lastBlob = null;
    staticSuffix = "A";

    expressSaved = false;
    expressTextEl.value = "";
    expressArea.style.display = "none";
    expressBlock.style.display = "none";
    btnExpressToggle.textContent = "Express som odovzdal";
    btnExpressToggle.removeAttribute("style");

    resetSessionFlags();

    apInput.value = "";
    manualCode.value = "";
    refreshCameraButton();
    apInput.focus();
  }

  // ===== Load =====
  btnLoad.addEventListener("click", ()=>{
    const ap = apInput.value.trim();
    if(!ap || !idx) return;

    const t = computeTasks(ap);
    if(!t){
      tasksCard.style.display = "none";
      return;
    }

    currentTasks = t;
    currentPhotoCode = "";
    lastBlob = null;
    staticSuffix = "A";
    expressSaved = false;
    expressTextEl.value = "";
    expressArea.style.display = "none";
    btnExpressToggle.textContent = "Express som odovzdal";
    btnExpressToggle.removeAttribute("style");

    resetSessionFlags();

    tasksCard.style.display = "block";
    renderTasks();
  });

  apInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") btnLoad.click(); });

  // ===== Manual camera button =====
  manualCode.addEventListener("input", refreshCameraButton);

  btnCamera.addEventListener("click", ()=>{
    const c = manualCode.value.trim();
    if(!c) return;
    currentPhotoCode = c;
    openCamera();
  });

  refreshCameraButton();

  // ===== Bottom panels toggle =====
  btnMiniScan.addEventListener("click", ()=>{
    panelScan.style.display = (panelScan.style.display==="block") ? "none" : "block";
    if(panelScan.style.display==="block") startScan();
  });
  btnMiniReport.addEventListener("click", ()=>{
    panelReport.style.display = (panelReport.style.display==="block") ? "none" : "block";
  });

  // ===== Scan (hidden) =====
  let stream=null, scanning=false;

  function stopStream(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }
  function stopScan(){
    scanning=false;
    stopStream();
  }

  async function startScan(){
    if (!('BarcodeDetector' in window)) return;
    if(scanning) return;

    scanning=true;
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:"environment" } }, audio:false
      });
      video.srcObject = stream;
      await video.play();

      const detector = new BarcodeDetector({ formats:["code_128","ean_13","ean_8","qr_code","code_39","upc_a","upc_e"] });

      const loop = async ()=>{
        if(!scanning) return;

        const w = video.videoWidth || 640;
        const h = video.videoHeight || 480;
        canvas.width = w; canvas.height = h;
        ctx.drawImage(video, 0, 0, w, h);

        try{
          const codes = await detector.detect(canvas);
          if(codes && codes.length){
            const raw = (codes[0].rawValue || "").trim();
            if(raw){
              manualCode.value = raw;
              refreshCameraButton();
              stopScan();
              panelScan.style.display="none";
              btnCamera.click(); // rovno foťák
              return;
            }
          }
        }catch(e){}
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    }catch(e){
      stopScan();
    }
  }

  btnStopScan.addEventListener("click", ()=>{
    stopScan();
    panelScan.style.display="none";
  });

  // ===== Report (hidden) =====
  btnToggleReport.addEventListener("click", ()=>{
    const vis = reportWrap.style.display==="block";
    if(vis){
      reportWrap.style.display="none";
      btnToggleReport.textContent="Zobraziť";
    }else{
      reportWrap.style.display="block";
      btnToggleReport.textContent="Skryť";
      renderReport();
    }
  });
  btnExportCsv.addEventListener("click", exportCsv);

  // ===== Init =====
  repDate.value = (new Date()).toISOString().slice(0,10);
  repName.value = localStorage.getItem(REP_KEY) || "";
  repName.addEventListener('change', ()=> localStorage.setItem(REP_KEY, repName.value.trim()));

  loadDbXlsx();
</script>
</body>
</html>
