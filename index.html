<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDS Foto (offline)</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px;max-width:860px}
    h1{font-size:20px;margin:0 0 10px}
    .muted{color:#666;font-size:13px;line-height:1.35}
    .card{border:1px solid #ddd;border-radius:16px;padding:14px;margin:12px 0}
    .bigbtn{
      width:100%;
      padding:16px 14px;
      border-radius:16px;
      border:1px solid #111;
      background:#111;
      color:#fff;
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .bigbtn:disabled{opacity:.45}
    .btn{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid #ccc;
      background:#fff;
      font-size:16px;
      font-weight:700;
    }
    .btn:disabled{opacity:.45}
    .btn-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;background:#f2f2f2;font-weight:800}
    input{
      width:100%;
      padding:14px 12px;
      border-radius:14px;
      border:1px solid #ccc;
      font-size:16px;
    }
    video{width:100%;max-width:560px;border-radius:14px;border:1px solid #eee;background:#000}
    img{width:100%;max-width:560px;border-radius:14px;border:1px solid #eee}
    .sp8{height:8px}
    .sp12{height:12px}
    .ok{color:#0a7a2f;font-weight:800}
    .bad{color:#b00020;font-weight:800}
  </style>
</head>
<body>
  <h1>IDS Foto podľa kódu</h1>
  <div class="muted">
    1) Skenovať alebo zadať kód → 2) Odfotiť → 3) Uložiť / Zdieľať.<br>
    Pozn.: uloženie ide ako súbor <span class="badge">KÓD.jpg</span> (zvyčajne do Downloads).
  </div>

  <div class="card">
    <div class="muted">Aktuálny kód</div>
    <div style="font-size:20px;margin:6px 0 12px">
      <span id="codeOut" class="badge">—</span>
    </div>

    <button id="btnStartScan" class="bigbtn">SKENOVAŤ</button>
    <div class="sp12"></div>

    <div id="scanArea" style="display:none">
      <video id="video" playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
      <div class="sp8"></div>
      <button id="btnStopScan" class="btn" style="width:100%">Zastaviť skener</button>
      <div class="sp8"></div>
    </div>

    <div class="muted">…alebo zadať ručne (môže byť text aj čísla)</div>
    <div class="sp8"></div>
    <input id="manualCode" placeholder="napr. 8544 alebo ABC-8544" />
    <div class="sp8"></div>
    <button id="btnUseManual" class="btn" style="width:100%">Použiť zadaný kód</button>

    <div class="sp12"></div>
    <div id="scanStatus" class="muted">Skener je vypnutý.</div>
  </div>

  <div class="card">
    <button id="btnTakePhoto" class="bigbtn" disabled>ODFOTIŤ</button>
    <div class="sp12"></div>

    <div class="btn-row">
      <button id="btnRetake" class="btn" disabled>Fotiť znova</button>
      <button id="btnShare" class="btn" disabled>Zdieľať</button>
    </div>

    <div class="sp12"></div>
    <button id="btnSave" class="bigbtn" disabled>ULOŽIŤ</button>

    <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />

    <div class="sp12"></div>
    <div id="photoStatus" class="muted">Najprv nastav kód.</div>

    <div class="sp12"></div>
    <div id="previewWrap" style="display:none">
      <img id="preview" alt="Náhľad fotky" />
    </div>
  </div>

  <script>
    // Offline (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }

    // UI
    const btnStartScan = document.getElementById('btnStartScan');
    const btnStopScan  = document.getElementById('btnStopScan');
    const scanStatus   = document.getElementById('scanStatus');
    const scanArea     = document.getElementById('scanArea');

    const manualCode   = document.getElementById('manualCode');
    const btnUseManual = document.getElementById('btnUseManual');
    const codeOut      = document.getElementById('codeOut');

    const btnTakePhoto = document.getElementById('btnTakePhoto');
    const btnRetake    = document.getElementById('btnRetake');
    const btnSave      = document.getElementById('btnSave');
    const btnShare     = document.getElementById('btnShare');
    const photoInput   = document.getElementById('photoInput');
    const photoStatus  = document.getElementById('photoStatus');
    const previewWrap  = document.getElementById('previewWrap');
    const preview      = document.getElementById('preview');

    const video  = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx    = canvas.getContext('2d', { willReadFrequently: true });

    // State
    let currentCode = "";
    let stream = null;
    let scanning = false;
    let lastBlob = null;

    function setCode(code){
      currentCode = String(code || "").trim();
      codeOut.textContent = currentCode || "—";
      btnTakePhoto.disabled = !currentCode;
      photoStatus.textContent = currentCode
        ? "Kód je nastavený. Klikni ODFOTIŤ."
        : "Najprv nastav kód.";
    }

    function stopStream(){
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    function stopScan(msg){
      scanning = false;
      scanArea.style.display = "none";
      btnStartScan.disabled = false;
      btnStopScan.disabled = true;
      stopStream();
      scanStatus.textContent = msg || "Skener je vypnutý.";
    }

    async function startScan(){
      if (!('BarcodeDetector' in window)) {
        scanStatus.innerHTML = '<span class="bad">Tvoj prehliadač nepodporuje skener.</span> Použi ručný vstup.';
        return;
      }

      scanning = true;
      btnStartScan.disabled = true;
      btnStopScan.disabled = false;
      scanArea.style.display = "block";
      scanStatus.textContent = "Spúšťam kameru…";

      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false
        });
        video.srcObject = stream;
        await video.play();

        scanStatus.textContent = "Skenujem…";
        const detector = new BarcodeDetector({ formats: ["code_128","ean_13","ean_8","qr_code","code_39","upc_a","upc_e"] });

        const loop = async () => {
          if (!scanning) return;

          const w = video.videoWidth || 640;
          const h = video.videoHeight || 480;
          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(video, 0, 0, w, h);

          try{
            const barcodes = await detector.detect(canvas);
            if (barcodes && barcodes.length){
              const raw = (barcodes[0].rawValue || "").trim();
              if (raw){
                setCode(raw);
                stopScan("Nájdené: " + raw);
                return;
              }
            }
          }catch(e){}

          requestAnimationFrame(loop);
        };

        requestAnimationFrame(loop);

      }catch(err){
        stopScan("Kamera sa nedá spustiť (povolenia / HTTPS).");
      }
    }

    btnStartScan.addEventListener('click', startScan);
    btnStopScan.addEventListener('click', () => stopScan("Skener zastavený."));

    btnUseManual.addEventListener('click', () => {
      const v = manualCode.value.trim();
      if (!v) return;
      setCode(v);
      scanStatus.innerHTML = '<span class="ok">Použitý ručný kód:</span> ' + v;
    });

    manualCode.addEventListener('keydown', (e) => {
      if (e.key === "Enter") btnUseManual.click();
    });

    btnTakePhoto.addEventListener('click', () => {
      if (!currentCode){
        alert("Najprv nastav kód (sken alebo ručne).");
        return;
      }
      photoInput.value = "";
      photoInput.click();
    });

    btnRetake.addEventListener('click', () => {
      lastBlob = null;
      previewWrap.style.display = "none";
      preview.src = "";
      btnSave.disabled = true;
      btnShare.disabled = true;
      btnRetake.disabled = true;
      photoStatus.textContent = "OK, odfoť znova.";
      photoInput.value = "";
      photoInput.click();
    });

    photoInput.addEventListener('change', () => {
      const file = photoInput.files && photoInput.files[0];
      if (!file) return;

      lastBlob = file;
      preview.src = URL.createObjectURL(file);
      previewWrap.style.display = "block";

      btnSave.disabled = false;
      btnRetake.disabled = false;
      btnShare.disabled = !(navigator.canShare && navigator.canShare({ files: [file] }));

      photoStatus.textContent = "Skontroluj fotku. Potom ULOŽIŤ alebo ZDIEĽAŤ, prípadne Fotiť znova.";
    });

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    btnSave.addEventListener('click', () => {
      if (!currentCode || !lastBlob){
        alert("Chýba kód alebo fotka.");
        return;
      }
      const safe = currentCode.replace(/[\\/:*?"<>|]+/g, "_"); // bezpečný názov súboru
      const filename = `${safe}.jpg`;
      downloadBlob(lastBlob, filename);
      photoStatus.innerHTML = '<span class="ok">Uložené:</span> ' + filename + ' (zvyčajne v Downloads).';
    });

    btnShare.addEventListener('click', async () => {
      if (!currentCode || !lastBlob) return;
      const safe = currentCode.replace(/[\\/:*?"<>|]+/g, "_");
      const filename = `${safe}.jpg`;

      try{
        const file = new File([lastBlob], filename, { type: lastBlob.type || "image/jpeg" });
        await navigator.share({
          title: "Foto plochy",
          text: `Foto pre kód ${currentCode}`,
          files: [file]
        });
      }catch(e){}
    });

    // init
    btnStopScan.disabled = true;
    setCode("");
  </script>
</body>
</html>
