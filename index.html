<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDS Foto</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffd400">

  <!-- Montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --ids-yellow:#ffd400;
      --ids-cycla:#e6007e;
      --ids-navy:#0b2a5b;

      --ids-soft:#f4f6fb;
      --ids-soft2:#fff4bf;

      --ids-green:#118a3c;
      --ids-greenBg:#ecf8f0;

      --ids-red:#b00020;

      --bg:#ffffff;
      --text:var(--ids-navy);
      --muted:rgba(11,42,91,.65);

      --soft:var(--ids-soft);
      --yellow:var(--ids-yellow);
      --yellow2:var(--ids-soft2);
      --green:var(--ids-green);
      --greenBg:var(--ids-greenBg);
      --red:var(--ids-red);

      --r:14px;
      --shadow: 0 10px 30px rgba(11,42,91,.08);
    }

    *{ box-sizing:border-box; border-radius:var(--r); }

    body{
      font-family: Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:14px;
      max-width:720px;
      overscroll-behavior-y: contain; /* proti pull-to-refresh (pomáha) */
    }

    .card{
      border:none;
      padding:14px;
      background:#fff;
      box-shadow: var(--shadow);
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:10px; }

    input, textarea{
      width:100%;
      padding:14px 14px;
      border:none;
      font-size:16px;
      background:var(--soft);
      color:var(--ids-navy);
      font-family: inherit;
      outline:none;
      font-weight:800;
      border-radius:var(--r);
    }
    textarea{
      min-height:72px;
      resize:vertical;
      font-weight:700;
    }

    .btn{
      border:0;
      padding:14px 16px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      background:var(--ids-navy);
      color:#fff;
      border-radius:var(--r);
    }
    .btn.yellow{
      background:var(--ids-yellow);
      color:var(--ids-navy);
      font-size:18px;
      padding:16px 16px;
    }
    .btn.gray{
      background:#e9eef7;
      color:var(--ids-navy);
    }
    .btn.green{
      background:var(--ids-green);
      color:#fff;
      font-size:18px;
      padding:16px 16px;
    }
    .btn.red{
      background:var(--ids-cycla);
      color:#fff;
      font-size:18px;
      padding:16px 16px;
    }

    .linkBtn{
      border:0;
      background:transparent;
      color:rgba(11,42,91,.75);
      font-weight:900;
      font-size:13px;
      padding:8px 10px;
      cursor:pointer;
      text-decoration:underline;
      border-radius:12px;
    }

    .sp{height:10px}
    .sp2{height:14px}

    /* AP panel */
    .apInput{
      font-size:18px !important;
      padding:14px 14px !important;
      font-weight:900 !important;
      letter-spacing:.01em;
    }

    /* TOP OK overlay */
    #topOkBanner{ display:none; }
    .okFull{
      background:linear-gradient(0deg, rgba(255,212,0,.16), rgba(255,212,0,.16)), #fff;
      color:var(--ids-navy);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
      justify-content:center;
      text-align:center;
      min-height:58vh;
      border-radius:var(--r);
      box-shadow: var(--shadow);
    }
    .okIcon{
      width:68px;height:68px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(230,0,126,.10);
      color:var(--ids-cycla);
      border-radius:999px;
      font-size:36px;
      font-weight:900;
    }
    .okTitle{ font-weight:900; font-size:24px; line-height:1.15; }
    .okSub{ color:rgba(11,42,91,.75); font-weight:800; font-size:13px; }

    /* Next suggestions */
    #okNextWrap{ width:100%; max-width:520px; text-align:left; display:none; }
    .okNextTitle{
      font-weight:900; font-size:13px; letter-spacing:.02em;
      color:rgba(11,42,91,.70);
      text-transform:uppercase;
      margin:4px 0 6px;
      border-radius:0;
    }
    .okNextGroup{
      background:#fff;
      border-radius:var(--r);
      padding:10px;
      box-shadow: 0 10px 26px rgba(11,42,91,.06);
    }
    .okNextBtn{
      width:100%;
      border:0;
      padding:12px 12px;
      font-weight:900;
      cursor:pointer;
      background:#f3f5fb;
      color:var(--ids-navy);
      text-align:left;
      border-radius:var(--r);
      margin-top:8px;
      line-height:1.15;
    }
    .okNextBtn small{
      display:block;
      font-weight:800;
      color:rgba(11,42,91,.60);
      margin-top:4px;
      border-radius:0;
    }

    /* Tasks card */
    #tasksCard{ display:none; }

    /* Zostáva bar */
    #remainBar{
      display:none;
      margin-bottom:12px;
      padding:12px 12px;
      background:#0b2a5b;
      color:#fff;
      font-weight:900;
      font-size:14px;
      border-radius:var(--r);
    }
    #remainBar.done{ background: var(--ids-green); }

    /* Úlohy výrazne červené */
    .task{
      border:none;
      padding:16px;
      display:flex;
      align-items:stretch;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      cursor:pointer;
      background: var(--ids-cycla);
      color:#fff;
      border-radius:var(--r);
    }
    .task.done{ background:var(--greenBg); color:var(--ids-green); }
    .task .left{ display:flex; flex-direction:column; gap:10px; min-width:0; flex:1 1 auto; }
    .task .title{ font-weight:900; font-size:16px; line-height:1.1; color:#fff; }
    .task.done .title{ color:var(--ids-green); }

    .task .code{
      font-weight:900;
      color:#fff;
      background:rgba(255,255,255,.18);
      padding:12px 14px;
      width:max-content;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      border-radius:var(--r);
    }
    .task.done .code{
      color:var(--ids-green);
      background:rgba(255,255,255,.70);
    }

    .task .hint{
      font-size:12.5px;
      font-weight:800;
      line-height:1.25;
      color:#fff;
      background:rgba(255,255,255,.14);
      padding:12px 14px;
      white-space:pre-wrap;
      word-break:break-word;
      border-radius:var(--r);
    }
    .task.done .hint{ background:rgba(255,255,255,.55); color:var(--ids-green); }

    .suffixWrap{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      margin-top:8px;
    }
    .suffixBtn{
      border:none;
      background:#fff;
      padding:12px 16px;
      font-weight:900;
      min-width:64px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      border-radius:var(--r);
      color:var(--ids-navy);
    }
    .suffixBtn.active{
      box-shadow: 0 0 0 2px rgba(11,42,91,.10) inset;
      background:rgba(255,255,255,.92);
    }

    /* After photo */
    #afterPhoto{ display:none; }
    .bigSave{ width:100%; font-size:20px; padding:18px 16px; }

    /* Express area */
    #expressAreaWrap{ display:none; }
    .subcard{
      border:none;
      padding:12px;
      background:var(--soft);
      border-radius:var(--r);
    }
    .exGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .exItem{
      display:flex;
      gap:10px;
      align-items:center;
      background:#fff;
      padding:12px 12px;
      user-select:none;
      border-radius:var(--r);
    }
    .exItem input{ width:auto; margin:0; padding:0; }
    .exItem label{ font-weight:900; cursor:pointer; color:var(--ids-navy); }

    /* Scan panel */
    #panelScan, #panelReport { display:none; margin-top:12px; }
    video{width:100%; background:#000; border:none; border-radius:var(--r); }

    .muted{ color:var(--muted); font-size:12px; font-weight:800; }
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;font-size:12.5px;vertical-align:top}
    th{text-align:left;font-size:11px;color:#667}

    /* Mini info */
    #miniInfoWrap{ display:none; }
    .miniInfo{ background:#f6f7fb; padding:12px; border-radius:var(--r); }
    .miniTitle{
      font-size:11px;
      font-weight:900;
      color:rgba(11,42,91,.55);
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.02em;
    }
    .miniLine{ font-size:12.5px; color:var(--ids-navy); line-height:1.35; margin:2px 0; word-break:break-word; font-weight:700; }
    .miniPills{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .miniPill{ font-size:12px; font-weight:900; background:#eaeef7; padding:6px 8px; border-radius:999px; }

    #noteCard{ display:none; margin-top:12px; }

    #appVersion{
      margin-top:12px;
      text-align:center;
      color:rgba(11,42,91,.35);
      font-weight:900;
      font-size:12px;
      letter-spacing:.05em;
    }

    dialog{
      border:none;
      padding:16px;
      border-radius:var(--r);
      box-shadow: var(--shadow);
    }

    .pulse{ animation: pulse 0.75s ease-in-out 2; }
    @keyframes pulse{
      0%{ transform:scale(1); filter:brightness(1); }
      50%{ transform:scale(1.03); filter:brightness(1.05); }
      100%{ transform:scale(1); filter:brightness(1); }
    }

    /* Tiny report */
    #tinyReportWrap{
      display:none;
      margin-top:14px;
      text-align:center;
    }
    .tinyLink{
      border:0;
      background:transparent;
      color:rgba(11,42,91,.35);
      font-weight:900;
      font-size:12px;
      letter-spacing:.03em;
      text-decoration:underline;
      cursor:pointer;
      padding:6px 10px;
      border-radius:999px;
    }
  </style>
</head>

<body>

  <!-- TOP OK OVERLAY -->
  <div id="topOkBanner" class="card" style="padding:0;background:transparent;box-shadow:none">
    <div class="okFull">
      <div class="okIcon">✓</div>
      <div id="okTitle" class="okTitle">Všetko hotové</div>
      <div id="okSub" class="okSub">Môžeš pokračovať na ďalšiu plochu</div>

      <button id="btnOkNext" class="btn green" style="width:100%;max-width:360px">Nové</button>
      <button id="btnOkExpress" class="btn gray" style="width:100%;max-width:360px; display:none">Express</button>

      <div id="okNextWrap">
        <div class="okNextTitle">Pokračovať na plochy</div>
        <div class="okNextGroup" id="okNextGroup"></div>
      </div>

      <button id="btnShowDetails" class="linkBtn">Zobraziť podrobnosti</button>
    </div>
  </div>

  <div id="mainUi">

    <!-- AP -->
    <div id="apWrap" class="card">
      <div class="col">
        <input id="apInput" class="apInput" placeholder="Kód plochy" autocomplete="off" autocapitalize="characters" />
        <button id="btnLoad" class="btn yellow">Načítať</button>
      </div>
    </div>

    <div class="sp2"></div>

    <!-- Manual / scan result + camera -->
    <div id="topToolsWrap" class="card">
      <div class="row">
        <input id="manualCode" placeholder="Číslo fotky (napr. 5587)" autocomplete="off" inputmode="numeric" />
        <button id="btnCamera" class="btn gray" style="min-width:110px">Foto</button>
      </div>
      <div class="sp"></div>
      <div class="row">
        <button id="btnScanToggle" class="btn gray" style="flex:1">Sken</button>
        <button id="btnStopScan" class="btn gray" style="flex:1; display:none">Stop</button>
      </div>
      <div class="sp"></div>
      <div id="scanHint" class="muted" style="display:none">Naskenované ✓ Klikni „Foto“.</div>
    </div>

    <div class="sp2"></div>

    <!-- Scan panel -->
    <div id="panelScan" class="card">
      <video id="video" playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
    </div>

    <div class="sp2"></div>

    <!-- TASKS -->
    <div id="tasksCard" class="card">
      <div id="remainBar">—</div>
      <div id="taskList" style="display:flex;flex-direction:column;gap:12px"></div>

      <!-- EXPRESS -->
      <div id="expressAreaWrap" class="subcard" style="margin-top:12px">
        <div class="muted" id="expressHint" style="margin-bottom:8px"></div>
        <div class="exGrid" id="exGrid"></div>
        <div class="sp"></div>
        <textarea id="expressExtra" placeholder="Poznámka k expressu (voliteľné)"></textarea>
        <div class="sp"></div>
        <div class="row">
          <button id="btnExpressDelivered" class="btn" style="flex:1">Odovzdaný</button>
          <button id="btnExpressNot" class="btn gray" style="flex:1">Neodovzdaný</button>
        </div>
        <div class="sp"></div>
        <button id="btnExpressClose" class="btn gray" style="width:100%">Zavrieť</button>
      </div>

      <div class="sp2"></div>
      <button id="btnFinish" class="btn red" style="width:100%">Ukončiť</button>
    </div>

    <!-- AFTER PHOTO -->
    <div id="afterPhoto" class="card">
      <button id="btnSavePhoto" class="btn yellow bigSave">Uložiť</button>
      <div class="sp"></div>
      <div class="row">
        <button id="btnRetake" class="btn gray" style="flex:1">Znova</button>
        <button id="btnBack" class="btn gray" style="flex:1">Späť</button>
      </div>
    </div>

    <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />

    <!-- Report (tiny link) -->
    <div id="tinyReportWrap">
      <button id="btnTinyReport" class="tinyLink">Report</button>
    </div>

    <!-- Report panel -->
    <div id="panelReport" class="card">
      <div class="row">
        <input id="repName" placeholder="Kto" />
        <input id="repDate" type="date" />
      </div>
      <div class="sp"></div>
      <div class="row">
        <button id="btnToggleReport" class="btn gray" style="flex:1">Zobraziť</button>
        <button id="btnExportCsv" class="btn gray" style="flex:1">CSV</button>
      </div>
      <div class="sp"></div>
      <div class="row">
        <button id="btnDeleteDay" class="btn gray" style="flex:1">Vymazať deň</button>
        <button id="btnDeleteAll" class="btn red" style="flex:1">Vymazať všetko</button>
      </div>
      <div id="reportWrap" style="display:none"></div>
    </div>

    <!-- Note -->
    <div id="noteCard" class="card">
      <div class="subcard">
        <textarea id="noteText" placeholder="Poznámka"></textarea>
      </div>
    </div>

    <!-- Mini info -->
    <div id="miniInfoWrap" class="card">
      <div class="miniInfo">
        <div class="miniTitle">Plocha</div>
        <div id="miniAddress" class="miniLine">—</div>
        <div id="miniPerson" class="miniLine">—</div>
        <div id="miniPharmacy" class="miniLine">—</div>

        <div class="sp"></div>
        <div class="miniTitle">Plagáty</div>
        <div id="miniPosters" class="miniPills"></div>
      </div>
    </div>

    <div id="appVersion"></div>
  </div>

  <!-- Finish dialog -->
  <dialog id="dlgFinish">
    <div style="font-weight:900;font-size:18px;color:var(--ids-navy)">Ukončiť?</div>
    <div id="finishText" class="muted" style="margin-top:10px"></div>
    <div class="sp2"></div>
    <div class="row">
      <button id="btnFinishNo" class="btn gray" style="flex:1">Nie</button>
      <button id="btnFinishYes" class="btn red" style="flex:1">Áno</button>
    </div>
  </dialog>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const APP_VERSION = "V29-FIXCAM+NAV";

    /* ===== Service Worker register ===== */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try { await navigator.serviceWorker.register("./sw.js"); } catch (e) {}
      });
    }

    /* ===== Columns ===== */
    const COL_MAIN_AP = "AP";
    const COL_STAND_FROM="AG", COL_STAND_TO="AJ";
    const COL_B1="AK";
    const COL_STATIC="AM";
    const COL_EXPRESS="AL";

    const COL_STAND_CODE="B";
    const COL_B1_CODE="C";
    const COL_STATIC_CODE="AO";

    const COL_CITY="F", COL_STREET="G", COL_HOUSE="H", COL_NAME="J", COL_SURNAME="K", COL_PHARMACY="L";

    function colToIndex(letter){
      let s = String(letter).toUpperCase().replace(/[^A-Z]/g,"");
      let n = 0;
      for (let i=0;i<s.length;i++) n = n*26 + (s.charCodeAt(i)-64);
      return n-1;
    }
    function norm(v){ return String(v ?? "").trim(); }
    function normCode(v){ return norm(v).toUpperCase(); }
    function safeName(s){ return norm(s).replace(/[\\/:*?"<>|]+/g, "_"); }
    function isoDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function fmtTime(ts){
      return String(ts||"").split("T")[1]?.slice(0,8) || "";
    }

    /* ===== Clean input ===== */
    function cleanCodeInput(v){
      let s = String(v ?? "");
      s = s.replace(/\u00A0/g, " ");
      s = s.replace(/\s+/g, "");
      s = s.replace(/[‐-–—]/g, "-");
      s = s.toUpperCase();
      return s;
    }
    function cleanNumeric(v){
      return String(v ?? "").replace(/\D+/g,"");
    }

    function downloadNow(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 4000);
    }
    function rowHasAnyText(row, fromIdx, toIdx){
      for(let i=fromIdx;i<=toIdx;i++){
        if(norm(row[i]) !== "") return true;
      }
      return false;
    }
    function joinCells(row, fromCol, toCol){
      const from = colToIndex(fromCol);
      const to = colToIndex(toCol);
      const parts=[];
      for(let i=from;i<=to;i++){
        const v = norm(row[i]);
        if(v) parts.push(v);
      }
      return parts.join("\n");
    }
    function parseEXTokens(s){
      const t = normCode(s).replace(/[,\.;\/\\]+/g, " ");
      const parts = t.split(/\s+/).filter(Boolean);
      const out = [];
      for(const p of parts){
        const m = /^EX([1-9])$/.exec(p);
        if(m) out.push("EX"+m[1]);
      }
      return Array.from(new Set(out));
    }
    function readExpressPicked(){
      const picked=[];
      for(let i=1;i<=9;i++){
        const ex="EX"+i;
        const cb=document.getElementById("cb_"+ex);
        if(cb && cb.checked) picked.push(ex);
      }
      return picked;
    }

    /* ===== Elements ===== */
    const topOkBanner = document.getElementById('topOkBanner');
    const mainUi = document.getElementById('mainUi');
    const okTitle = document.getElementById('okTitle');
    const okSub = document.getElementById('okSub');
    const btnOkNext = document.getElementById('btnOkNext');
    const btnOkExpress = document.getElementById('btnOkExpress');
    const btnShowDetails = document.getElementById('btnShowDetails');

    const okNextWrap = document.getElementById('okNextWrap');
    const okNextGroup = document.getElementById('okNextGroup');

    const apWrap = document.getElementById('apWrap');
    const apInput = document.getElementById('apInput');
    const btnLoad = document.getElementById('btnLoad');

    const manualCode = document.getElementById('manualCode');
    const btnCamera = document.getElementById('btnCamera');
    const scanHint = document.getElementById('scanHint');

    const btnScanToggle = document.getElementById('btnScanToggle');
    const btnStopScan = document.getElementById('btnStopScan');
    const panelScan = document.getElementById('panelScan');

    const tasksCard = document.getElementById('tasksCard');
    const remainBar = document.getElementById('remainBar');
    const taskList = document.getElementById('taskList');

    const expressAreaWrap = document.getElementById('expressAreaWrap');
    const expressHint = document.getElementById('expressHint');
    const exGrid = document.getElementById('exGrid');
    const expressExtra = document.getElementById('expressExtra');
    const btnExpressDelivered = document.getElementById('btnExpressDelivered');
    const btnExpressNot = document.getElementById('btnExpressNot');
    const btnExpressClose = document.getElementById('btnExpressClose');

    const afterPhoto = document.getElementById('afterPhoto');
    const btnSavePhoto = document.getElementById('btnSavePhoto');
    const btnRetake = document.getElementById('btnRetake');
    const btnBack = document.getElementById('btnBack');
    const photoInput = document.getElementById('photoInput');

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const repName = document.getElementById('repName');
    const repDate = document.getElementById('repDate');
    const btnToggleReport = document.getElementById('btnToggleReport');
    const btnExportCsv = document.getElementById('btnExportCsv');
    const reportWrap = document.getElementById('reportWrap');

    const btnDeleteDay = document.getElementById('btnDeleteDay');
    const btnDeleteAll = document.getElementById('btnDeleteAll');

    const noteCard = document.getElementById('noteCard');
    const noteText = document.getElementById('noteText');

    const miniInfoWrap = document.getElementById('miniInfoWrap');
    const miniAddress = document.getElementById('miniAddress');
    const miniPerson = document.getElementById('miniPerson');
    const miniPharmacy = document.getElementById('miniPharmacy');
    const miniPosters = document.getElementById('miniPosters');

    const dlgFinish = document.getElementById('dlgFinish');
    const finishText = document.getElementById('finishText');
    const btnFinish = document.getElementById('btnFinish');
    const btnFinishNo = document.getElementById('btnFinishNo');
    const btnFinishYes = document.getElementById('btnFinishYes');

    const tinyReportWrap = document.getElementById('tinyReportWrap');
    const btnTinyReport = document.getElementById('btnTinyReport');
    const panelReport = document.getElementById('panelReport');

    /* ===== DB ===== */
    let dbRows=null, idx=null;

    const IDX_AP = colToIndex(COL_MAIN_AP);

    const IDX_STAND_FROM = colToIndex(COL_STAND_FROM);
    const IDX_STAND_TO = colToIndex(COL_STAND_TO);
    const IDX_B1 = colToIndex(COL_B1);
    const IDX_STATIC = colToIndex(COL_STATIC);
    const IDX_EXPRESS = colToIndex(COL_EXPRESS);

    const IDX_STAND_CODE = colToIndex(COL_STAND_CODE);
    const IDX_B1_CODE = colToIndex(COL_B1_CODE);
    const IDX_STATIC_CODE = colToIndex(COL_STATIC_CODE);

    const IDX_CITY = colToIndex(COL_CITY);
    const IDX_STREET = colToIndex(COL_STREET);
    const IDX_HOUSE = colToIndex(COL_HOUSE);
    const IDX_NAME = colToIndex(COL_NAME);
    const IDX_SURNAME = colToIndex(COL_SURNAME);
    const IDX_PHARMACY = colToIndex(COL_PHARMACY);

    let navIndex = { byAddr:new Map(), byStreet:new Map(), byCity:new Map() };
    function pushMapList(map, key, value){
      if(!key) return;
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(value);
    }
    function keyCity(row){ return normCode(row[IDX_CITY]); }
    function keyStreet(row){ return normCode(row[IDX_STREET]); }
    function keyHouse(row){ return normCode(row[IDX_HOUSE]); }
    function keyAddr(row){ return [keyCity(row), keyStreet(row), keyHouse(row)].join("|"); }
    function keyCityStreet(row){ return [keyCity(row), keyStreet(row)].join("|"); }

    async function loadDbXlsx(){
      try{
        const res = await fetch("./db.xlsx", { cache:"no-cache" });
        if(!res.ok) throw new Error("db.xlsx not found");
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, { type:"array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        dbRows = XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });

        idx = { byAP:new Map() };
        navIndex = { byAddr:new Map(), byStreet:new Map(), byCity:new Map() };

        for(const row of dbRows){
          const ap = normCode(row[IDX_AP]);
          if(!ap) continue;
          idx.byAP.set(ap, row);

          pushMapList(navIndex.byAddr, keyAddr(row), ap);
          pushMapList(navIndex.byStreet, keyCityStreet(row), ap);
          pushMapList(navIndex.byCity, keyCity(row), ap);
        }
      }catch(e){
        dbRows=null; idx=null;
      }
    }

    function getPostersFromRow(row){
      if(!row) return [];
      const from = colToIndex("AG");
      const to   = colToIndex("AM");
      const set = new Set();
      for(let i=from;i<=to;i++){
        const v0 = norm(row[i]);
        if(!v0) continue;
        v0.split(/[\s,;\/]+/).map(x=>x.trim()).filter(Boolean).forEach(x=>set.add(x));
      }
      return Array.from(set);
    }

    function renderMiniInfo(row){
      if(!row){
        miniInfoWrap.style.display="none";
        noteCard.style.display="block";
        return;
      }

      const city = norm(row[IDX_CITY]);
      const street = norm(row[IDX_STREET]);
      const house = norm(row[IDX_HOUSE]);
      const name = norm(row[IDX_NAME]);
      const surname = norm(row[IDX_SURNAME]);
      const pharmacy = norm(row[IDX_PHARMACY]);

      const addrParts = [city, street, house].filter(Boolean);
      miniAddress.textContent = addrParts.length ? addrParts.join(", ") : "—";

      const personParts = [name, surname].filter(Boolean);
      miniPerson.textContent = personParts.length ? personParts.join(" ") : "—";

      miniPharmacy.textContent = pharmacy ? pharmacy : "—";

      const posters = getPostersFromRow(row);
      miniPosters.innerHTML="";
      if(posters.length){
        posters.forEach(p=>{
          const d=document.createElement("div");
          d.className="miniPill";
          d.textContent=p;
          miniPosters.appendChild(d);
        });
      }else{
        const d=document.createElement("div");
        d.className="miniLine";
        d.textContent="—";
        miniPosters.appendChild(d);
      }

      miniInfoWrap.style.display="block";
      noteCard.style.display="block";
    }

    /* ===== TASKS STATE ===== */
    let currentTasks=null;
    let currentPhotoCode="";
    let lastBlob=null;

    let expressStatus="NA";
    let expressSuggested=[];
    let sessionLocked=false;

    function computeTasks(ap){
      if(!idx) return null;
      const apN = normCode(ap);
      const row = idx.byAP.get(apN);
      if(!row) return null;

      const needStand = rowHasAnyText(row, IDX_STAND_FROM, IDX_STAND_TO);
      const needB1 = norm(row[IDX_B1]) !== "";
      const needStatic = norm(row[IDX_STATIC]) !== "";

      const standCode = norm(row[IDX_STAND_CODE]);
      const b1Code = norm(row[IDX_B1_CODE]);
      const staticBase = norm(row[IDX_STATIC_CODE]);

      const needExpress = norm(row[IDX_EXPRESS]) !== "";
      const suggestedExpress = parseEXTokens(row[IDX_EXPRESS]);

      const standHint = joinCells(row, "AG", "AJ");
      const b1Hint = norm(row[IDX_B1]);

      return {
        ap: apN, row,
        needStand, needB1, needStatic,
        standCode, b1Code, staticBase,
        needExpress, suggestedExpress,
        standHint, b1Hint,
        _suffix:"A"
      };
    }

    /* ===== LOG ===== */
    const LOG_KEY="ids_foto_log_v29";
    const REP_KEY="ids_rep_name_v29";

    function loadLog(){ try { return JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); } catch { return []; } }
    function saveLog(arr){ localStorage.setItem(LOG_KEY, JSON.stringify(arr)); }

    function addLogEntry(ap, photoCode, posters, note, file){
      const now = new Date();
      const entry = {
        ts: now.toISOString().slice(0,19),
        day: isoDate(now),
        who: (repName.value || "").trim(),
        ap: ap || "",
        photoCode: photoCode || "",
        posters: posters || [],
        note: note || "",
        file: file || ""
      };
      const log = loadLog();
      log.push(entry);
      saveLog(log);
    }

    function isPhotoDoneToday(ap, type, codeOrBase){
      const day = repDate.value || isoDate(new Date());
      const log = loadLog().filter(x => x.day === day && String(x.ap||"") === ap);

      if(type==="exact"){
        return log.some(x => normCode(x.photoCode) === normCode(codeOrBase));
      }
      if(type==="base"){
        const base = normCode(codeOrBase);
        return log.some(x => normCode((x.photoCode||"").replace(/[A-Z]$/,"")) === base);
      }
      return false;
    }

    function photosDone(){
      const t=currentTasks;
      if(!t) return false;

      if(t.needStand && t.standCode && !isPhotoDoneToday(t.ap,"exact",t.standCode)) return false;
      if(t.needB1 && t.b1Code && !isPhotoDoneToday(t.ap,"exact",t.b1Code)) return false;
      if(t.needStatic && t.staticBase && !isPhotoDoneToday(t.ap,"base",t.staticBase)) return false;

      return true;
    }

    function countRemainingPhotos(){
      const t=currentTasks;
      if(!t) return 0;
      let n=0;
      if(t.needStand && t.standCode && !isPhotoDoneToday(t.ap,"exact",t.standCode)) n++;
      if(t.needB1 && t.b1Code && !isPhotoDoneToday(t.ap,"exact",t.b1Code)) n++;
      if(t.needStatic && t.staticBase && !isPhotoDoneToday(t.ap,"base",t.staticBase)) n++;
      return n;
    }

    /* ===== NAV suggestions ===== */
    function labelForAP(ap){
      if(!idx || !idx.byAP.has(ap)) return ap;
      const r = idx.byAP.get(ap);
      const ph = norm(r[IDX_PHARMACY]);
      const nm = [norm(r[IDX_NAME]), norm(r[IDX_SURNAME])].filter(Boolean).join(" ").trim();
      const who = ph || nm || "—";
      const addr = [norm(r[IDX_CITY]), norm(r[IDX_STREET]), norm(r[IDX_HOUSE])].filter(Boolean).join(", ");
      return { who, addr };
    }

    function apIsFullyDoneToday(ap){
      if(!idx || !idx.byAP.has(ap)) return false;
      const t = computeTasks(ap);
      if(!t) return false;

      if(t.needStand && t.standCode && !isPhotoDoneToday(ap,"exact",t.standCode)) return false;
      if(t.needB1 && t.b1Code && !isPhotoDoneToday(ap,"exact",t.b1Code)) return false;
      if(t.needStatic && t.staticBase && !isPhotoDoneToday(ap,"base",t.staticBase)) return false;

      return true;
    }

    function buildNextSuggestions(){
      okNextGroup.innerHTML = "";
      okNextWrap.style.display = "none";
      if(!currentTasks || !currentTasks.row || !idx) return;

      const row = currentTasks.row;
      const kA = keyAddr(row);
      const kS = keyCityStreet(row);
      const kC = keyCity(row);

      const sameAddr = (navIndex.byAddr.get(kA) || []).filter(ap => ap !== currentTasks.ap && !apIsFullyDoneToday(ap));
      const sameStreet = (navIndex.byStreet.get(kS) || []).filter(ap => ap !== currentTasks.ap && !apIsFullyDoneToday(ap) && !sameAddr.includes(ap));
      const sameCity = (navIndex.byCity.get(kC) || []).filter(ap => ap !== currentTasks.ap && !apIsFullyDoneToday(ap) && !sameAddr.includes(ap) && !sameStreet.includes(ap));

      const groups = [
        { title:"Na tej istej adrese", list:sameAddr.slice(0,6) },
        { title:"Na tej istej ulici", list:sameStreet.slice(0,6) },
        { title:"V tom istom meste", list:sameCity.slice(0,6) }
      ].filter(g => g.list.length);

      if(!groups.length) return;

      groups.forEach(g=>{
        const h = document.createElement("div");
        h.className = "okNextTitle";
        h.textContent = g.title;
        okNextGroup.appendChild(h);

        g.list.forEach(ap=>{
          const info = labelForAP(ap);
          const b = document.createElement("button");
          b.type = "button";
          b.className = "okNextBtn";
          b.innerHTML = `${ap} — ${info.who}<small>${info.addr}</small>`;
          b.addEventListener("click", ()=>{
            hideOkBannerShowDetails();
            startSessionForAP(ap);
          });
          okNextGroup.appendChild(b);
        });
      });

      okNextWrap.style.display = "block";
    }

    /* ===== OK banner logic ===== */
    function showOkBanner(mode){
      if(!currentTasks) return;

      const needExpress = !!currentTasks.needExpress;
      const expressDone = (expressStatus !== "NA");

      if(mode === "ALL"){
        okTitle.textContent = "Všetko hotové";
        okSub.textContent = "Môžeš pokračovať na ďalšiu plochu";
        btnOkExpress.style.display = "none";
      }else{
        okTitle.textContent = "Všetko okrem expressov hotové";
        okSub.textContent = "Ak chceš, potvrď ešte express (voliteľné)";
        btnOkExpress.style.display = needExpress && !expressDone ? "block" : "none";
      }

      buildNextSuggestions();

      mainUi.style.display = "none";
      topOkBanner.style.display = "block";
      window.scrollTo({ top:0, behavior:"smooth" });
    }

    function hideOkBannerShowDetails(){
      topOkBanner.style.display = "none";
      mainUi.style.display = "block";
      window.scrollTo({ top:0, behavior:"smooth" });
    }

    function checkAutoOk(){
      if(!currentTasks) return;
      if(!photosDone()) return;

      if(currentTasks.needExpress && expressStatus === "NA"){
        showOkBanner("PHOTOS_ONLY");
      }else{
        showOkBanner("ALL");
      }
    }

    btnOkNext.addEventListener("click", ()=> resetToNew());
    btnShowDetails.addEventListener("click", ()=> hideOkBannerShowDetails());
    btnOkExpress.addEventListener("click", ()=>{
      hideOkBannerShowDetails();
      openExpressArea();
      window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
    });

    /* ===== RENDER TASKS ===== */
    function makeTaskRow({label, code, hint, done, onClick}){
      const div = document.createElement("div");
      div.className = "task" + (done ? " done" : "");

      const left = document.createElement("div");
      left.className="left";

      const title = document.createElement("div");
      title.className="title";
      title.textContent=label;

      const codeEl = document.createElement("div");
      codeEl.className="code";
      codeEl.textContent=code || "—";

      left.appendChild(title);
      left.appendChild(codeEl);

      if(hint && hint.trim()){
        const hintEl = document.createElement("div");
        hintEl.className="hint";
        hintEl.textContent = hint.trim();
        left.appendChild(hintEl);
      }

      div.appendChild(left);
      div.addEventListener("click", (e)=>{ e.preventDefault(); onClick(); });
      return div;
    }

    function makeStaticRow(t, done){
      const div = document.createElement("div");
      div.className = "task" + (done ? " done" : "");

      const left = document.createElement("div");
      left.className="left";

      const title = document.createElement("div");
      title.className="title";
      title.textContent="Fotím statický plagát";

      const codeEl = document.createElement("div");
      codeEl.className="code";
      codeEl.textContent=t.staticBase || "—";

      const suffixWrap = document.createElement("div");
      suffixWrap.className="suffixWrap";

      ["A","B","C"].forEach(s=>{
        const b=document.createElement("div");
        b.className="suffixBtn" + (t._suffix===s ? " active":"");
        b.textContent=s;
        b.addEventListener("click",(ev)=>{
          ev.stopPropagation();
          t._suffix = s;
          renderTasks();

          const base=t.staticBase||"";
          if(!base) return;
          triggerCameraForCode(base + s);  // ✅ FIX: otvor foto
        });
        suffixWrap.appendChild(b);
      });

      left.appendChild(title);
      left.appendChild(codeEl);
      left.appendChild(suffixWrap);
      div.appendChild(left);

      div.addEventListener("click", ()=>{
        const base=t.staticBase||"";
        if(!base) return;
        triggerCameraForCode(base); // ✅ FIX: otvor foto
      });

      return div;
    }

    function renderExpressUI(){
      exGrid.innerHTML = "";
      const suggested = expressSuggested || [];
      expressHint.textContent = suggested.length ? ("Návrh: " + suggested.join(" ")) : "Bez návrhu";

      const all = ["EX1","EX2","EX3","EX4","EX5","EX6","EX7","EX8","EX9"];
      all.forEach(ex=>{
        const id = "cb_" + ex;
        const wrap = document.createElement("div");
        wrap.className = "exItem";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.checked = suggested.includes(ex);

        const lab = document.createElement("label");
        lab.htmlFor = id;
        lab.textContent = ex;

        wrap.appendChild(cb);
        wrap.appendChild(lab);
        exGrid.appendChild(wrap);
      });
    }

    function openExpressArea(){
      if(!currentTasks || !currentTasks.needExpress) return;
      expressAreaWrap.style.display = "block";
      renderExpressUI();
    }

    function updateRemainBar(){
      if(!currentTasks){
        remainBar.style.display="none";
        return;
      }
      const n = countRemainingPhotos();
      remainBar.style.display="block";
      if(n===0){
        remainBar.classList.add("done");
        remainBar.textContent = "HOTOVO ✓";
      }else{
        remainBar.classList.remove("done");
        remainBar.textContent = "ZOSTÁVA: " + n;
      }
    }

    function renderTasks(){
      const t = currentTasks;
      taskList.innerHTML = "";
      if(!t) return;

      updateRemainBar();

      if(t.needStand && t.standCode){
        const done = isPhotoDoneToday(t.ap,"exact",t.standCode);
        taskList.appendChild(makeTaskRow({
          label:"Fotím stojan",
          code:t.standCode,
          hint:t.standHint,
          done,
          onClick: ()=> triggerCameraForCode(t.standCode) // ✅ FIX
        }));
      }

      if(t.needB1 && t.b1Code){
        const done = isPhotoDoneToday(t.ap,"exact",t.b1Code);
        taskList.appendChild(makeTaskRow({
          label:"Fotím B1 plagát",
          code:t.b1Code,
          hint:t.b1Hint,
          done,
          onClick: ()=> triggerCameraForCode(t.b1Code) // ✅ FIX
        }));
      }

      if(t.needStatic && t.staticBase){
        const done = isPhotoDoneToday(t.ap,"base",t.staticBase);
        taskList.appendChild(makeStaticRow(t, done));
      }

      if(t.needExpress){
        const done = (expressStatus !== "NA");
        taskList.appendChild(makeTaskRow({
          label:"Express",
          code:(t.suggestedExpress||[]).join(" ") || "—",
          hint:"Klikni pre potvrdenie (voliteľné)",
          done,
          onClick: ()=>{
            openExpressArea();
            window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
          }
        }));
      }

      checkAutoOk();
    }

    /* ===== Refresh lock (jemná poistka) ===== */
    function setRefreshLock(on){
      sessionLocked = !!on;
    }
    window.addEventListener("beforeunload", (e)=>{
      if(sessionLocked && currentTasks && !photosDone()){
        e.preventDefault();
        e.returnValue = "";
      }
    });

    /* ===== PHOTO FLOW ===== */
    function refreshCameraButton(){
      const ok = cleanNumeric(manualCode.value).length > 0;
      btnCamera.className = ok ? "btn red" : "btn gray";
    }

    // ✅ FIX: jednotná funkcia – nastaví kód, skryje klávesnicu a hneď otvorí fotoaparát
    function triggerCameraForCode(code){
      const c = cleanCodeInput(code);
      manualCode.value = c;
      scanHint.style.display = "none";
      refreshCameraButton();
      currentPhotoCode = c;

      // schovaj klávesnicu
      if(document.activeElement) document.activeElement.blur();
      manualCode.blur();

      openCamera(); // musí byť v tom istom kliknutí
    }

    function openCamera(){
      if(!manualCode.value.trim()) return;
      photoInput.value="";
      // dôležité: click musí byť priamo z user gesture (tu je)
      photoInput.click();
    }

    function showSaveIfFileReturned(){
      const f = photoInput.files && photoInput.files[0];
      if(f){
        lastBlob = f;
        afterPhoto.style.display = "block";
        tasksCard.style.display = "none";
        return true;
      }
      return false;
    }

    photoInput.addEventListener("change", () => {
      if (showSaveIfFileReturned()) return;

      setTimeout(() => {
        if (showSaveIfFileReturned()) return;

        setTimeout(() => {
          if (showSaveIfFileReturned()) return;

          lastBlob = null;
          afterPhoto.style.display = "none";
          tasksCard.style.display = currentTasks ? "block" : "none";
        }, 500);
      }, 200);
    });

    window.addEventListener("focus", () => {
      if(!lastBlob) showSaveIfFileReturned();
    });
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible"){
        if(!lastBlob) showSaveIfFileReturned();
      }
    });

    btnSavePhoto.addEventListener('click', ()=>{
      if(!lastBlob) return;

      const code = cleanNumeric(manualCode.value);
      if(!code) return;

      const filename = safeName(code) + ".jpg";
      downloadNow(lastBlob, filename);

      const ap = currentTasks?.ap || normCode(apInput.value);

      let posters = [];
      let row = null;
      if(idx && ap && idx.byAP.has(ap)){
        row = idx.byAP.get(ap);
        posters = getPostersFromRow(row);
        renderMiniInfo(row);
      }else{
        renderMiniInfo(null);
      }

      const note = norm(noteText.value);
      addLogEntry(ap, code, posters, note, filename);

      lastBlob=null;
      afterPhoto.style.display="none";
      tasksCard.style.display = currentTasks ? "block" : "none";

      if(currentTasks) renderTasks();
    });

    btnRetake.addEventListener("click", ()=>{
      afterPhoto.style.display="none";
      tasksCard.style.display = currentTasks ? "block" : "none";
      lastBlob=null;
      openCamera();
    });
    btnBack.addEventListener("click", ()=>{
      afterPhoto.style.display="none";
      tasksCard.style.display = currentTasks ? "block" : "none";
      lastBlob=null;
    });

    /* ===== EXPRESS ===== */
    btnExpressClose.addEventListener("click", ()=> expressAreaWrap.style.display="none");

    function logExpress(statusText){
      if(!currentTasks) return;
      const ap = currentTasks.ap;
      const posters = currentTasks.row ? getPostersFromRow(currentTasks.row) : [];
      const baseNote = norm(noteText.value);
      const extra = norm(expressExtra.value);

      let s = statusText;
      if(extra) s += " | " + extra;

      const finalNote = [baseNote, s].filter(Boolean).join(" | ");
      addLogEntry(ap, "", posters, finalNote, "");
    }

    btnExpressDelivered.addEventListener("click", ()=>{
      expressStatus = "DELIVERED";
      const pickedNow = readExpressPicked();
      const s = "EXPRESS: " + (pickedNow.join(" ") || "ODOVZDANÝ");
      logExpress(s);
      expressAreaWrap.style.display="none";
      renderTasks();
    });

    btnExpressNot.addEventListener("click", ()=>{
      expressStatus = "NOT";
      logExpress("EXPRESS: NEODOVZDANÝ");
      expressAreaWrap.style.display="none";
      renderTasks();
    });

    /* ===== Finish ===== */
    function missingListForPhotosOnly(){
      const t=currentTasks;
      const miss=[];
      if(!t) return miss;
      if(t.needStand && t.standCode && !isPhotoDoneToday(t.ap,"exact",t.standCode)) miss.push("stojan");
      if(t.needB1 && t.b1Code && !isPhotoDoneToday(t.ap,"exact",t.b1Code)) miss.push("B1");
      if(t.needStatic && t.staticBase && !isPhotoDoneToday(t.ap,"base",t.staticBase)) miss.push("statický");
      return miss;
    }

    btnFinish.addEventListener("click", ()=>{
      if(!currentTasks) return;
      const miss = missingListForPhotosOnly();
      if(miss.length===0){
        if(currentTasks.needExpress && expressStatus==="NA"){ showOkBanner("PHOTOS_ONLY"); return; }
        showOkBanner("ALL");
        return;
      }
      finishText.textContent = "Chýba: " + miss.join(", ");
      dlgFinish.showModal();
    });

    btnFinishNo.addEventListener("click", ()=> dlgFinish.close());
    btnFinishYes.addEventListener("click", ()=>{
      dlgFinish.close();
      resetToNew();
    });

    /* ===== Session UI hiding ===== */
    function setSessionUI(on){
      // po načítaní plochy skryj hore AP a nech neruší
      apWrap.style.display = on ? "none" : "block";

      // tiny report nech je len keď beží session (úplne dole)
      tinyReportWrap.style.display = on ? "block" : "none";

      // report panel skryté default
      if(!on) panelReport.style.display = "none";
    }

    function resetToNew(){
      topOkBanner.style.display="none";
      mainUi.style.display="block";

      tasksCard.style.display="none";
      afterPhoto.style.display="none";
      taskList.innerHTML="";
      currentTasks=null;
      currentPhotoCode="";
      lastBlob=null;

      expressStatus="NA";
      expressSuggested=[];
      expressExtra.value="";
      expressAreaWrap.style.display="none";

      noteText.value="";
      scanHint.style.display="none";
      manualCode.value="";
      refreshCameraButton();

      miniInfoWrap.style.display="none";
      noteCard.style.display="none";

      apInput.value="";

      setRefreshLock(false);
      setSessionUI(false);

      apInput.focus();
      window.scrollTo({ top:0, behavior:"smooth" });
    }

    /* ===== LOAD AP ===== */
    function startSessionForAP(ap){
      const apC = cleanCodeInput(ap);
      apInput.value = apC;

      if(!apC || !idx) return;

      const t = computeTasks(apC);
      if(!t){
        tasksCard.style.display="none";
        renderMiniInfo(null);
        currentTasks=null;
        return;
      }

      currentTasks = t;
      expressStatus="NA";
      expressSuggested = t.suggestedExpress || [];
      expressExtra.value="";
      expressAreaWrap.style.display="none";

      renderMiniInfo(t.row);

      tasksCard.style.display="block";
      renderTasks();

      // lock refresh počas práce
      setRefreshLock(true);

      // UI minimalizácia
      setSessionUI(true);

      // zavri klávesnicu po načítaní
      apInput.blur();

      window.scrollTo({ top:0, behavior:"smooth" });
    }

    btnLoad.addEventListener("click", ()=>{
      const ap = cleanCodeInput(apInput.value.trim());
      startSessionForAP(ap);
    });

    apInput.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        btnLoad.click();
      }
    });

    /* ===== manual code ===== */
    manualCode.addEventListener("input", ()=>{
      const cleaned = cleanNumeric(manualCode.value);
      if(manualCode.value !== cleaned) manualCode.value = cleaned;
      scanHint.style.display="none";
      refreshCameraButton();
    });

    apInput.addEventListener("input", ()=>{
      const cleaned = cleanCodeInput(apInput.value);
      if(apInput.value !== cleaned) apInput.value = cleaned;
    });

    btnCamera.addEventListener("click", ()=>{
      const c = cleanNumeric(manualCode.value.trim());
      manualCode.value = c;
      if(!c) return;

      // schovaj klávesnicu a otvor foto
      if(document.activeElement) document.activeElement.blur();
      manualCode.blur();

      openCamera();
    });

    refreshCameraButton();

    /* ===== REPORT ===== */
    function renderReport(){
      const day = repDate.value || isoDate(new Date());
      const log = loadLog().filter(x => x.day === day);
      if(log.length === 0){
        reportWrap.innerHTML = "<div class='muted' style='margin-top:10px'>—</div>";
        return;
      }
      const rows = log.slice().sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));
      let html = `<table>
        <thead><tr>
          <th>Čas</th><th>Kto</th><th>AP</th><th>Fotil</th><th>Plagáty</th><th>Poznámka</th><th>Súbor</th>
        </tr></thead><tbody>`;
      for(const r of rows){
        html += `<tr>
          <td>${fmtTime(r.ts)}</td>
          <td>${r.who||""}</td>
          <td><b>${r.ap||""}</b></td>
          <td>${r.photoCode||""}</td>
          <td>${(r.posters&&r.posters.length)?r.posters.join(", "):"—"}</td>
          <td>${r.note||""}</td>
          <td>${r.file||""}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      reportWrap.innerHTML = html;
    }

    function escapeCsv(s){
      const v = String(s ?? "");
      if (/[",\n;]/.test(v)) return `"${v.replaceAll('"','""')}"`;
      return v;
    }
    function exportCsv(){
      const day = repDate.value || isoDate(new Date());
      const log = loadLog().filter(x => x.day === day).sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));
      if(log.length === 0) return;

      const header = ["day","time","who","ap","photoCode","posters","note","file"];
      const lines = [header.join(";")];
      for(const r of log){
        lines.push([
          escapeCsv(r.day),
          escapeCsv(fmtTime(r.ts)),
          escapeCsv(r.who),
          escapeCsv(r.ap),
          escapeCsv(r.photoCode),
          escapeCsv((r.posters && r.posters.length) ? r.posters.join(", ") : ""),
          escapeCsv(r.note),
          escapeCsv(r.file)
        ].join(";"));
      }
      const csv = lines.join("\n");
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      const filename = `report_${day}_${safeName(repName.value || "repre")}.csv`;
      downloadNow(blob, filename);
    }

    function deleteLogsForDay(day){
      const all = loadLog();
      saveLog(all.filter(x => x.day !== day));
    }
    function deleteLogsAll(){ saveLog([]); }

    btnToggleReport.addEventListener("click", ()=>{
      const vis = reportWrap.style.display==="block";
      if(vis){
        reportWrap.style.display="none";
        btnToggleReport.textContent="Zobraziť";
      }else{
        reportWrap.style.display="block";
        btnToggleReport.textContent="Skryť";
        renderReport();
      }
    });
    btnExportCsv.addEventListener("click", exportCsv);

    btnDeleteDay.addEventListener("click", ()=>{
      const day = repDate.value || isoDate(new Date());
      if(!confirm(`Vymazať report len pre deň ${day}?`)) return;
      deleteLogsForDay(day);
      if(reportWrap.style.display === "block") renderReport();
    });
    btnDeleteAll.addEventListener("click", ()=>{
      if(!confirm("Vymazať CELÝ report (všetky dni)?")) return;
      if(!confirm("Naozaj? Toto sa nedá vrátiť späť.")) return;
      deleteLogsAll();
      if(reportWrap.style.display === "block") renderReport();
    });

    btnTinyReport.addEventListener("click", ()=>{
      panelReport.style.display = (panelReport.style.display==="block") ? "none" : "block";
      if(panelReport.style.display==="block"){
        window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
      }
    });

    /* ===== SCAN ===== */
    let stream=null, scanning=false;
    function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
    function stopScan(){ scanning=false; stopStream(); btnStopScan.style.display="none"; }

    async function startScan(){
      if(!('BarcodeDetector' in window)) return;
      if(scanning) return;

      scanning=true;
      btnStopScan.style.display="block";
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:"environment" } }, audio:false });
        video.srcObject = stream;
        await video.play();

        const detector = new BarcodeDetector({ formats:["code_128","ean_13","ean_8","qr_code","code_39","upc_a","upc_e"] });

        const loop = async ()=>{
          if(!scanning) return;

          const w = video.videoWidth || 640;
          const h = video.videoHeight || 480;
          canvas.width = w; canvas.height = h;
          ctx.drawImage(video, 0, 0, w, h);

          try{
            const codes = await detector.detect(canvas);
            if(codes && codes.length){
              const raw = (codes[0].rawValue || "").trim();
              if(raw){
                manualCode.value = cleanNumeric(raw);
                scanHint.style.display = "block";
                refreshCameraButton();

                stopScan();
                panelScan.style.display="none";

                btnCamera.classList.add("pulse");
                setTimeout(()=>btnCamera.classList.remove("pulse"), 1200);

                // zavri klávesnicu
                if(document.activeElement) document.activeElement.blur();
                manualCode.blur();

                window.scrollTo({ top:0, behavior:"smooth" });
                return;
              }
            }
          }catch(e){}
          requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
      }catch(e){
        stopScan();
      }
    }

    btnScanToggle.addEventListener("click", ()=>{
      panelScan.style.display = (panelScan.style.display==="block") ? "none" : "block";
      if(panelScan.style.display==="block") startScan();
      else stopScan();
    });
    btnStopScan.addEventListener("click", ()=>{
      stopScan();
      panelScan.style.display="none";
    });

    /* ===== Init ===== */
    repDate.value = (new Date()).toISOString().slice(0,10);
    repName.value = localStorage.getItem(REP_KEY) || "";
    repName.addEventListener('change', ()=> localStorage.setItem(REP_KEY, repName.value.trim()));

    document.getElementById("appVersion").textContent = APP_VERSION;

    loadDbXlsx();
    apInput.focus();
  </script>
</body>
</html>
