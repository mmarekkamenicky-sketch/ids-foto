<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDS Foto</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:14px;max-width:520px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;background:#f2f2f2;font-weight:900}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:10px}
    .iconBtn{
      border:2px solid #111;border-radius:18px;padding:18px 10px;
      background:#fff;font-weight:900;font-size:15px;text-align:center;
      display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;
      user-select:none
    }
    .icon{font-size:34px;line-height:1;color:#111}
    .iconBtn:active{transform:scale(.99)}
    .iconBtn:disabled{opacity:.35}
    .btn{padding:14px 14px;border-radius:16px;border:2px solid #111;background:#fff;font-weight:900;width:100%}
    .btn.primary{background:#111;color:#fff}
    .btn.danger{border-color:#b00020;color:#b00020}
    video,img{width:100%;border-radius:16px;border:1px solid #eee;background:#000;margin-top:12px}
    dialog{border:none;border-radius:16px;padding:14px;max-width:420px;width:92vw}
    dialog::backdrop{background:rgba(0,0,0,.45)}
    input{width:100%;padding:12px 12px;border-radius:14px;border:1px solid #ccc;font-size:16px}
    .tiny{font-size:12px;color:#666;margin-top:8px}
    .card{border:1px solid #ddd;border-radius:16px;padding:12px;margin-top:12px}
    .pill{display:inline-block;border:1px solid #111;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-weight:900}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;font-size:13px;vertical-align:top}
    th{text-align:left;font-size:12px;color:#666}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  </style>
</head>
<body>

  <div class="top">
    <div>Kód: <span id="codeOut" class="badge">—</span></div>
    <div id="dbOut" class="badge">DB: …</div>
  </div>

  <!-- 3 ikonky = fotoworkflow -->
  <div class="grid">
    <button id="btnScan" class="iconBtn">
      <div class="icon">▣</div><div>Skenovať</div>
    </button>

    <button id="btnManual" class="iconBtn">
      <div class="icon">⌨</div><div>Zadať</div>
    </button>

    <button id="btnPhoto" class="iconBtn" disabled>
      <div class="icon">◉</div><div>Foto</div>
    </button>
  </div>

  <div id="scanWrap" style="display:none">
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <div style="margin-top:10px"><button id="btnStop" class="btn">Stop</button></div>
  </div>

  <img id="preview" style="display:none" alt="Náhľad" />

  <div id="afterPhoto" style="display:none;margin-top:10px">
    <button id="btnOk" class="btn primary">OK (stiahnuť + zapísať do reportu)</button>
    <div style="height:10px"></div>
    <button id="btnRetake" class="btn">Znova</button>
    <div style="height:10px"></div>
    <button id="btnNextScan" class="btn">Skenovať nové</button>
  </div>

  <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />

  <dialog id="dlg">
    <div style="font-weight:900;margin-bottom:10px">Zadať kód (pre fotenie)</div>
    <input id="manualText" placeholder="napr. 8544 alebo ABC-8544" />
    <div style="margin-top:10px">
      <button id="dlgOk" class="btn primary">OK</button>
      <div style="height:10px"></div>
      <button id="dlgCancel" class="btn">Zrušiť</button>
    </div>
    <div class="tiny">Tip: môže byť aj text.</div>
  </dialog>

  <!-- Samostatná časť: Zistiť plagáty -->
  <div class="card">
    <div style="font-weight:900;margin-bottom:8px">Zistiť plagáty (AG–AM)</div>
    <input id="lookupCode" placeholder="Kód plochy (AP) – sem zadaj" />
    <div style="height:10px"></div>
    <button id="btnLookup" class="btn">Zobraziť plagáty</button>
    <div id="posters" style="margin-top:10px"></div>
  </div>

  <!-- Denný report -->
  <div class="card">
    <div style="font-weight:900;margin-bottom:8px">Denný report</div>

    <div class="row2">
      <div>
        <div class="tiny">Dátum</div>
        <input id="repDate" type="date" />
      </div>
      <div>
        <div class="tiny">Reprezentant (voliteľné)</div>
        <input id="repName" placeholder="napr. Jano" />
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="row2">
      <button id="btnShowReport" class="btn">Zobraziť</button>
      <button id="btnExportCsv" class="btn">Export CSV</button>
    </div>

    <div style="height:10px"></div>
    <div class="row2">
      <button id="btnClearDay" class="btn danger">Vymazať deň</button>
      <button id="btnClearAll" class="btn danger">Vymazať všetko</button>
    </div>

    <div id="reportWrap"></div>
  </div>

  <!-- Excel parser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

  const codeOut = document.getElementById('codeOut');
  const dbOut = document.getElementById('dbOut');

  const btnScan = document.getElementById('btnScan');
  const btnManual = document.getElementById('btnManual');
  const btnPhoto = document.getElementById('btnPhoto');

  const scanWrap = document.getElementById('scanWrap');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const btnStop = document.getElementById('btnStop');

  const photoInput = document.getElementById('photoInput');
  const preview = document.getElementById('preview');
  const afterPhoto = document.getElementById('afterPhoto');
  const btnOk = document.getElementById('btnOk');
  const btnRetake = document.getElementById('btnRetake');
  const btnNextScan = document.getElementById('btnNextScan');

  const dlg = document.getElementById('dlg');
  const manualText = document.getElementById('manualText');
  const dlgOk = document.getElementById('dlgOk');
  const dlgCancel = document.getElementById('dlgCancel');

  const lookupCode = document.getElementById('lookupCode');
  const btnLookup = document.getElementById('btnLookup');
  const postersEl = document.getElementById('posters');

  const repDate = document.getElementById('repDate');
  const repName = document.getElementById('repName');
  const btnShowReport = document.getElementById('btnShowReport');
  const btnExportCsv = document.getElementById('btnExportCsv');
  const btnClearDay = document.getElementById('btnClearDay');
  const btnClearAll = document.getElementById('btnClearAll');
  const reportWrap = document.getElementById('reportWrap');

  let currentCode = "";
  let stream = null;
  let scanning = false;
  let lastBlob = null;

  // ===== DB =====
  let dbRows = null;
  function colToIndex(letter){
    let s = String(letter).toUpperCase().replace(/[^A-Z]/g,"");
    let n = 0;
    for (let i=0;i<s.length;i++) n = n*26 + (s.charCodeAt(i)-64);
    return n-1;
  }
  const IDX_AP = colToIndex("AP");
  const IDX_AG = colToIndex("AG");
  const IDX_AM = colToIndex("AM");

  // ===== Report storage =====
  const LOG_KEY = "ids_foto_log_v1";
  const REP_KEY = "ids_rep_name_v1";

  function loadLog(){
    try { return JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); }
    catch { return []; }
  }
  function saveLog(arr){
    localStorage.setItem(LOG_KEY, JSON.stringify(arr));
  }

  function safeName(s){
    return String(s || "").trim().replace(/[\\/:*?"<>|]+/g, "_");
  }

  function setCode(v){
    currentCode = String(v || "").trim();
    codeOut.textContent = currentCode || "—";
    btnPhoto.disabled = !currentCode;
  }

  async function loadDbXlsx(){
    try{
      const res = await fetch("./db.xlsx", { cache: "no-cache" });
      if(!res.ok) throw new Error("db.xlsx not found");
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      dbRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
      dbOut.textContent = "DB: OK";
    }catch(e){
      dbRows = null;
      dbOut.textContent = "DB: —";
    }
  }

  function getPostersForAP(apCode){
    if(!dbRows) return [];
    const wanted = String(apCode || "").trim();
    if(!wanted) return [];

    let found = null;
    for(let r=0;r<dbRows.length;r++){
      const row = dbRows[r];
      if(!row) continue;
      const ap = String(row[IDX_AP] ?? "").trim();
      if(ap === wanted){ found = row; break; }
    }
    if(!found) return [];

    const set = new Set();
    for(let i=IDX_AG;i<=IDX_AM;i++){
      const v = String(found[i] ?? "").trim();
      if(!v) continue;
      v.split(/[\s,;\/]+/).map(x=>x.trim()).filter(Boolean).forEach(x=>set.add(x));
    }
    return Array.from(set);
  }

  // ===== Scan =====
  function stopStream(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }
  function stopScan(){
    scanning = false;
    scanWrap.style.display = "none";
    stopStream();
  }

  async function startScan(){
    if (!('BarcodeDetector' in window)) {
      dlg.showModal();
      setTimeout(()=>manualText.focus(), 50);
      return;
    }
    scanning = true;
    scanWrap.style.display = "block";

    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:"environment" } }, audio:false
      });
      video.srcObject = stream;
      await video.play();

      const detector = new BarcodeDetector({ formats:["code_128","ean_13","ean_8","qr_code","code_39","upc_a","upc_e"] });

      const loop = async () => {
        if(!scanning) return;

        const w = video.videoWidth || 640;
        const h = video.videoHeight || 480;
        canvas.width = w; canvas.height = h;
        ctx.drawImage(video, 0, 0, w, h);

        try{
          const codes = await detector.detect(canvas);
          if(codes && codes.length){
            const raw = (codes[0].rawValue || "").trim();
            if(raw){
              setCode(raw);
              stopScan();
              return;
            }
          }
        }catch(e){}
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);

    }catch(e){
      stopScan();
      dlg.showModal();
      setTimeout(()=>manualText.focus(), 50);
    }
  }

  function openCamera(){
    if(!currentCode) return;
    photoInput.value = "";
    photoInput.click();
  }

  function downloadNow(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 4000);
  }

  function resetAfterSave(){
    lastBlob = null;
    preview.style.display = "none";
    preview.src = "";
    afterPhoto.style.display = "none";
    setCode("");
  }

  // ===== Lookup posters (UI) =====
  function showPostersFor(apCode){
    postersEl.innerHTML = "";
    const posters = getPostersForAP(apCode);
    if(!dbRows){
      postersEl.innerHTML = "<span class='pill'>DB nie je načítaná</span>";
      return;
    }
    if(!String(apCode||"").trim()){
      postersEl.innerHTML = "<span class='pill'>Zadaj kód</span>";
      return;
    }
    if(posters.length === 0){
      postersEl.innerHTML = "<span class='pill'>—</span>";
      return;
    }
    postersEl.innerHTML = posters.map(x => `<span class="pill">${x}</span>`).join("");
  }

  // ===== Report rendering/export =====
  function isoDate(d){
    // YYYY-MM-DD local
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function fmtTime(iso){
    // "2026-01-08T10:12:33" -> "10:12:33"
    return String(iso||"").split("T")[1]?.slice(0,8) || "";
  }

  function escapeCsv(s){
    const v = String(s ?? "");
    if (/[",\n;]/.test(v)) return `"${v.replaceAll('"','""')}"`;
    return v;
  }

  function renderReport(){
    const day = repDate.value || isoDate(new Date());
    const log = loadLog().filter(x => x.day === day);

    if(log.length === 0){
      reportWrap.innerHTML = "<div class='tiny' style='margin-top:10px'>Žiadne záznamy pre tento deň.</div>";
      return;
    }

    const rows = log
      .slice()
      .sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));

    let html = `<table>
      <thead><tr>
        <th>Čas</th><th>Kód</th><th>Plagáty</th><th>Súbor</th>
      </tr></thead><tbody>`;

    for(const r of rows){
      html += `<tr>
        <td>${fmtTime(r.ts)}</td>
        <td><b>${r.code || ""}</b></td>
        <td>${(r.posters && r.posters.length) ? r.posters.join(", ") : "—"}</td>
        <td>${r.file || ""}</td>
      </tr>`;
    }
    html += `</tbody></table>
      <div class="tiny" style="margin-top:8px">Spolu: <b>${rows.length}</b></div>`;
    reportWrap.innerHTML = html;
  }

  function exportCsv(){
    const day = repDate.value || isoDate(new Date());
    const rep = (repName.value || "").trim();
    const log = loadLog().filter(x => x.day === day).sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));
    if(log.length === 0){
      alert("Pre tento deň nie sú žiadne záznamy.");
      return;
    }

    const header = ["day","time","representant","code","posters","file"];
    const lines = [header.join(";")];

    for(const r of log){
      const time = fmtTime(r.ts);
      const posters = (r.posters && r.posters.length) ? r.posters.join(", ") : "";
      lines.push([
        escapeCsv(r.day),
        escapeCsv(time),
        escapeCsv(rep),
        escapeCsv(r.code),
        escapeCsv(posters),
        escapeCsv(r.file)
      ].join(";"));
    }

    const csv = lines.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const filename = `report_${day}${rep ? "_" + safeName(rep) : ""}.csv`;
    downloadNow(blob, filename);
  }

  function clearDay(){
    const day = repDate.value || isoDate(new Date());
    if(!confirm("Vymazať záznamy pre deň " + day + "?")) return;
    const log = loadLog().filter(x => x.day !== day);
    saveLog(log);
    renderReport();
  }

  function clearAll(){
    if(!confirm("Vymazať VŠETKY záznamy reportu v tomto telefóne?")) return;
    saveLog([]);
    renderReport();
  }

  // ===== Events =====
  btnScan.addEventListener('click', startScan);
  btnStop.addEventListener('click', stopScan);

  btnManual.addEventListener('click', ()=>{
    dlg.showModal();
    manualText.value = currentCode;
    setTimeout(()=>manualText.focus(), 50);
  });
  dlgOk.addEventListener('click', ()=>{
    const v = manualText.value.trim();
    if(v) setCode(v);
    dlg.close();
  });
  dlgCancel.addEventListener('click', ()=> dlg.close());
  manualText.addEventListener('keydown', (e)=>{ if(e.key==="Enter") dlgOk.click(); });

  btnPhoto.addEventListener('click', openCamera);

  photoInput.addEventListener('change', ()=>{
    const f = photoInput.files && photoInput.files[0];
    if(!f) return;
    lastBlob = f;
    preview.src = URL.createObjectURL(f);
    preview.style.display = "block";
    afterPhoto.style.display = "block";
  });

  btnRetake.addEventListener('click', ()=>{
    lastBlob = null;
    preview.style.display = "none";
    preview.src = "";
    afterPhoto.style.display = "none";
    openCamera();
  });

  btnOk.addEventListener('click', ()=>{
    if(!currentCode || !lastBlob) return;

    const filename = safeName(currentCode) + ".jpg";
    downloadNow(lastBlob, filename);

    // zapíš do reportu
    const now = new Date();
    const entry = {
      ts: now.toISOString().slice(0,19),       // YYYY-MM-DDTHH:MM:SS
      day: isoDate(now),
      code: String(currentCode),
      posters: getPostersForAP(currentCode),
      file: filename
    };
    const log = loadLog();
    log.push(entry);
    saveLog(log);

    // refresh report ak je otvorený ten istý deň
    if((repDate.value || isoDate(new Date())) === entry.day) renderReport();

    resetAfterSave();
  });

  btnNextScan.addEventListener('click', ()=>{
    resetAfterSave();
    startScan();
  });

  btnLookup.addEventListener('click', ()=> showPostersFor(lookupCode.value));
  lookupCode.addEventListener('keydown', (e)=>{ if(e.key==="Enter") btnLookup.click(); });

  // Report controls
  btnShowReport.addEventListener('click', renderReport);
  btnExportCsv.addEventListener('click', exportCsv);
  btnClearDay.addEventListener('click', clearDay);
  btnClearAll.addEventListener('click', clearAll);

  // init
  setCode("");
  loadDbXlsx();

  // report defaults
  repDate.value = (new Date()).toISOString().slice(0,10);
  repName.value = localStorage.getItem(REP_KEY) || "";
  repName.addEventListener('change', ()=> localStorage.setItem(REP_KEY, repName.value.trim()));
  renderReport();
</script>
</body>
</html>
