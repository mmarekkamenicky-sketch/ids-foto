<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDS Foto</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffd400">

  <!-- Montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --ids-yellow:#ffd400;
      --ids-cycla:#e6007e;
      --ids-navy:#0b2a5b;

      --ids-soft:#f4f6fb;
      --ids-soft2:#fff4bf;

      --ids-green:#118a3c;
      --ids-greenBg:#ecf8f0;

      /* originál červená */
      --ids-red:#c4001a;

      --bg:#ffffff;
      --text:var(--ids-navy);
      --muted:rgba(11,42,91,.65);

      --soft:var(--ids-soft);
      --yellow:var(--ids-yellow);
      --yellow2:var(--ids-soft2);
      --green:var(--ids-green);
      --greenBg:var(--ids-greenBg);
      --red:var(--ids-red);

      --r:14px;
      --shadow: 0 10px 30px rgba(11,42,91,.08);
    }

    *{ box-sizing:border-box; border-radius:var(--r); }

    body{
      font-family: Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:14px;
      max-width:720px;
      overscroll-behavior-y: contain;
    }

    .card{
      border:none;
      padding:14px;
      background:#fff;
      box-shadow: var(--shadow);
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:10px; }

    input, textarea{
      width:100%;
      padding:14px 14px;
      border:none;
      font-size:16px;
      background:var(--soft);
      color:var(--ids-navy);
      font-family: inherit;
      outline:none;
      font-weight:800;
      border-radius:var(--r);
    }
    textarea{
      min-height:72px;
      resize:vertical;
      font-weight:700;
    }

    .btn{
      border:0;
      padding:14px 16px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      background:var(--ids-navy);
      color:#fff;
      border-radius:var(--r);
    }
    .btn.yellow{
      background:var(--ids-yellow);
      color:var(--ids-navy);
      font-size:18px;
      padding:16px 16px;
    }
    .btn.gray{
      background:#e9eef7;
      color:var(--ids-navy);
    }
    .btn.green{
      background:var(--ids-green);
      color:#fff;
      font-size:18px;
      padding:16px 16px;
    }
    .btn.red{
      background:var(--ids-red);
      color:#fff;
      font-size:18px;
      padding:16px 16px;
    }

    .sp{height:10px}
    .sp2{height:14px}

    /* === AP panel – OBROVSKÉ + centrované === */
    .apInput{
      font-size:34px !important;
      padding:22px 18px !important;
      font-weight:900 !important;
      letter-spacing:.03em;
      text-align:center;
    }

    /* TOP OK overlay */
    #topOkBanner{ display:none; }
    .okFull{
      background:linear-gradient(0deg, rgba(255,212,0,.16), rgba(255,212,0,.16)), #fff;
      color:var(--ids-navy);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
      justify-content:center;
      text-align:center;
      min-height:58vh;
      border-radius:var(--r);
      box-shadow: var(--shadow);
    }
    .okIcon{
      width:68px;height:68px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(230,0,126,.10);
      color:var(--ids-cycla);
      border-radius:999px;
      font-size:36px;
      font-weight:900;
    }
    .okTitle{ font-weight:900; font-size:24px; line-height:1.15; }
    .okSub{ color:rgba(11,42,91,.75); font-weight:800; font-size:13px; }

    /* thumbs on OK screen */
    #okProofWrap{
      width:100%;
      max-width:520px;
      display:none;
      text-align:left;
    }
    .proofTitle{
      font-weight:900;
      font-size:12px;
      letter-spacing:.03em;
      color:rgba(11,42,91,.60);
      text-transform:uppercase;
      margin:4px 0 8px;
      border-radius:0;
    }
    .thumbGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .thumbCard{
      background:#fff;
      box-shadow: 0 10px 26px rgba(11,42,91,.06);
      padding:10px;
      border-radius:var(--r);
      overflow:hidden;
    }
    .thumbImg{
      width:100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      background:#eef2fb;
      border-radius:12px;
      display:block;
    }
    .thumbCode{
      margin-top:8px;
      font-weight:900;
      font-size:12px;
      color:var(--ids-navy);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .thumbTime{
      margin-top:3px;
      font-weight:800;
      font-size:11px;
      color:rgba(11,42,91,.55);
      border-radius:0;
    }

    /* Next suggestions */
    #okNextWrap{ width:100%; max-width:520px; text-align:left; display:none; }
    .okNextTitle{
      font-weight:900; font-size:13px; letter-spacing:.02em;
      color:rgba(11,42,91,.70);
      text-transform:uppercase;
      margin:4px 0 6px;
      border-radius:0;
    }
    .okNextGroup{
      background:#fff;
      border-radius:var(--r);
      padding:10px;
      box-shadow: 0 10px 26px rgba(11,42,91,.06);
    }
    .okNextBtn{
      width:100%;
      border:0;
      padding:12px 12px;
      font-weight:900;
      cursor:pointer;
      background:#f3f5fb;
      color:var(--ids-navy);
      text-align:left;
      border-radius:var(--r);
      margin-top:8px;
      line-height:1.15;
    }
    .okNextBtn small{
      display:block;
      font-weight:800;
      color:rgba(11,42,91,.60);
      margin-top:4px;
      border-radius:0;
    }

    /* Tasks card */
    #tasksCard{ display:none; }

    /* Zostáva bar */
    #remainBar{
      display:none;
      margin-bottom:12px;
      padding:12px 12px;
      background:#0b2a5b;
      color:#fff;
      font-weight:900;
      font-size:14px;
      border-radius:var(--r);
    }
    #remainBar.done{ background: var(--ids-green); }

    /* Úlohy výrazne ČERVENÉ + biele písmo (nedokončené) */
    .task{
      border:none;
      padding:16px;
      display:flex;
      align-items:stretch;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      cursor:pointer;
      background: var(--ids-red);
      color:#fff;
      border-radius:var(--r);
    }
    .task.done{ background:var(--greenBg); color:var(--ids-green); }

    .task .left{ display:flex; flex-direction:column; gap:10px; min-width:0; flex:1 1 auto; }
    .task .title{ font-weight:900; font-size:16px; line-height:1.1; color:#fff; }
    .task.done .title{ color:var(--ids-green); }

    .task .code{
      font-weight:900;
      color:#fff;
      background:rgba(255,255,255,.18);
      padding:12px 14px;
      width:max-content;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      border-radius:var(--r);
    }
    .task.done .code{
      color:var(--ids-green);
      background:rgba(255,255,255,.70);
    }

    .task .hint{
      font-size:12.5px;
      font-weight:800;
      line-height:1.25;
      color:#fff;
      background:rgba(255,255,255,.14);
      padding:12px 14px;
      white-space:pre-wrap;
      word-break:break-word;
      border-radius:var(--r);
    }
    .task.done .hint{ background:rgba(255,255,255,.55); color:var(--ids-green); }

    /* sivá nenápadná bublinka (DP) */
    .task.dpTask{
      background:#eef2fb;
      color:var(--ids-navy);
    }
    .task.dpTask .title{ color:var(--ids-navy); }
    .task.dpTask .code{
      color:var(--ids-navy);
      background:rgba(11,42,91,.08);
    }
    .task.dpTask .hint{
      color:rgba(11,42,91,.75);
      background:rgba(11,42,91,.06);
    }
    .task.dpTask.done{
      background:var(--greenBg);
      color:var(--ids-green);
    }
    .task.dpTask.done .title{ color:var(--ids-green); }
    .task.dpTask.done .code{
      color:var(--ids-green);
      background:rgba(255,255,255,.70);
    }
    .task.dpTask.done .hint{
      color:var(--ids-green);
      background:rgba(255,255,255,.55);
    }

    /* Express */
    #expressAreaWrap{ display:none; }
    .subcard{
      border:none;
      padding:12px;
      background:var(--soft);
      border-radius:var(--r);
    }
    .exGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .exItem{
      display:flex;
      gap:10px;
      align-items:center;
      background:#fff;
      padding:12px 12px;
      user-select:none;
      border-radius:var(--r);
    }
    .exItem input{ width:auto; margin:0; padding:0; }
    .exItem label{ font-weight:900; cursor:pointer; color:var(--ids-navy); }

    /* Scan panel */
    #panelScan, #panelReport { display:none; margin-top:12px; }
    video{width:100%; background:#000; border:none; border-radius:var(--r); }

    .muted{ color:var(--muted); font-size:12px; font-weight:800; }
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;font-size:12.5px;vertical-align:top}
    th{text-align:left;font-size:11px;color:#667}

    /* Mini info */
    #miniInfoWrap{ display:none; }
    .miniInfo{ background:#f6f7fb; padding:12px; border-radius:var(--r); }
    .miniTitle{
      font-size:11px;
      font-weight:900;
      color:rgba(11,42,91,.55);
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.02em;
    }
    .miniLine{ font-size:12.5px; color:var(--ids-navy); line-height:1.35; margin:2px 0; word-break:break-word; font-weight:700; }
    .miniPills{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .miniPill{ font-size:12px; font-weight:900; background:#eaeef7; padding:6px 8px; border-radius:999px; }

    #noteCard{ display:none; margin-top:12px; }

    #appVersion{
      margin-top:12px;
      text-align:center;
      color:rgba(11,42,91,.35);
      font-weight:900;
      font-size:12px;
      letter-spacing:.05em;
    }

    dialog{
      border:none;
      padding:16px;
      border-radius:var(--r);
      box-shadow: var(--shadow);
    }

    .pulse{ animation: pulse 0.75s ease-in-out 2; }
    @keyframes pulse{
      0%{ transform:scale(1); filter:brightness(1); }
      50%{ transform:scale(1.03); filter:brightness(1.05); }
      100%{ transform:scale(1); filter:brightness(1); }
    }

    /* FULLSCREEN SAVE WARNING */
    #saveOverlay{
      display:none;
      position:fixed;
      inset:0;
      z-index:9999;
      background:var(--ids-red);
      color:#fff;
      padding:18px;
      border-radius:0;
    }
    .saveBox{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:14px;
      text-align:center;
      border-radius:0;
    }
    .warnIcon{
      width:74px;height:74px;
      display:flex;align-items:center;justify-content:center;
      border:4px solid rgba(255,255,255,.95);
      border-radius:999px;
      font-size:42px;
      font-weight:900;
      line-height:1;
    }
    .warnTitle{
      font-size:22px;
      font-weight:900;
      line-height:1.15;
      max-width:520px;
    }
    .warnSub{
      font-size:13px;
      font-weight:800;
      opacity:.92;
      max-width:520px;
    }
    .whiteBtn{
      width:100%;
      max-width:380px;
      border:0;
      padding:16px 16px;
      font-weight:900;
      font-size:18px;
      cursor:pointer;
      background:#fff;
      color:var(--ids-red);
      border-radius:var(--r);
    }
    .whiteBtn.secondary{
      background:rgba(255,255,255,.92);
      color:var(--ids-navy);
    }
  </style>
</head>

<body>

  <!-- FULLSCREEN SAVE WARNING -->
  <div id="saveOverlay">
    <div class="saveBox">
      <div class="warnIcon">!</div>
      <div class="warnTitle">Fotografia nebola uložená</div>
      <div class="warnSub">Vrátil si sa z fotoaparátu. Aby sa fotka naozaj uložila, klikni <b>Uložiť</b>.</div>
      <button id="btnSaveOverlay" class="whiteBtn">Uložiť</button>
      <button id="btnCancelOverlay" class="whiteBtn secondary">Ukončiť</button>
    </div>
  </div>

  <!-- TOP OK OVERLAY -->
  <div id="topOkBanner" class="card" style="padding:0;background:transparent;box-shadow:none">
    <div class="okFull">
      <div class="okIcon">✓</div>
      <div id="okTitle" class="okTitle">Všetko hotové</div>
      <div id="okSub" class="okSub">Môžeš pokračovať na ďalšiu plochu</div>

      <button id="btnOkNext" class="btn green" style="width:100%;max-width:360px">Nové</button>
      <button id="btnOkExpress" class="btn gray" style="width:100%;max-width:360px; display:none">Express</button>

      <!-- PROOF (thumbs) -->
      <div id="okProofWrap">
        <div class="proofTitle">Uložené fotky (dnes / táto plocha)</div>
        <div id="okThumbGrid" class="thumbGrid"></div>
      </div>

      <!-- NEW: full button back to job (replaces "Zobraziť podrobnosti") -->
      <button id="btnBackToJob" class="btn gray" style="width:100%;max-width:360px">
        Späť na plochu
      </button>

      <!-- NAV -->
      <div id="okNextWrap">
        <div class="okNextTitle">Pokračovať na plochy</div>
        <div class="okNextGroup" id="okNextGroup"></div>
      </div>
    </div>
  </div>

  <div id="mainUi">

    <!-- AP -->
    <div id="apWrap" class="card">
      <div class="col">
        <input id="apInput" class="apInput" placeholder="Kód plochy" autocomplete="off" autocapitalize="characters" />
        <button id="btnLoad" class="btn red">Vyhľadať</button>
        <button id="btnHomeReport" class="btn gray">Report</button>
      </div>
    </div>

    <div class="sp2"></div>

    <!-- Manual / scan + camera -->
    <div id="topToolsWrap" class="card">
      <div class="row">
        <input id="manualCode" placeholder="Kód fotky (napr. 6675 alebo 6675B)" autocomplete="off" autocapitalize="characters" />
        <button id="btnCamera" class="btn gray" style="min-width:110px">Foto</button>
      </div>
      <div class="sp"></div>
      <div class="row">
        <button id="btnScanToggle" class="btn gray" style="flex:1">Sken</button>
        <button id="btnStopScan" class="btn gray" style="flex:1; display:none">Stop</button>
      </div>
      <div class="sp"></div>
      <div id="scanHint" class="muted" style="display:none">Naskenované ✓ Klikni „Foto“.</div>
    </div>

    <div class="sp2"></div>

    <!-- Scan panel -->
    <div id="panelScan" class="card">
      <video id="video" playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
    </div>

    <div class="sp2"></div>

    <!-- TASKS -->
    <div id="tasksCard" class="card">
      <div id="remainBar">—</div>
      <div id="taskList" style="display:flex;flex-direction:column;gap:12px"></div>

      <!-- EXPRESS -->
      <div id="expressAreaWrap" class="subcard" style="margin-top:12px">
        <div class="muted" id="expressHint" style="margin-bottom:8px"></div>
        <div class="exGrid" id="exGrid"></div>
        <div class="sp"></div>
        <textarea id="expressExtra" placeholder="Poznámka k expressu (voliteľné)"></textarea>
        <div class="sp"></div>
        <div class="row">
          <button id="btnExpressDelivered" class="btn" style="flex:1">Odovzdaný</button>
          <button id="btnExpressNot" class="btn gray" style="flex:1">Neodovzdaný</button>
        </div>
        <div class="sp"></div>
        <button id="btnExpressClose" class="btn gray" style="width:100%">Zavrieť</button>
      </div>

      <div class="sp2"></div>
      <button id="btnFinish" class="btn red" style="width:100%">Ukončiť</button>
    </div>

    <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />

    <!-- Report panel -->
    <div id="panelReport" class="card">
      <div class="row">
        <input id="repName" placeholder="Kto" />
        <input id="repDate" type="date" />
      </div>
      <div class="sp"></div>
      <div class="row">
        <button id="btnToggleReport" class="btn gray" style="flex:1">Zobraziť</button>
        <button id="btnShareHtml" class="btn gray" style="flex:1">Zdieľať HTML</button>
      </div>
      <div class="sp"></div>
      <div class="row">
        <button id="btnExportCsv" class="btn gray" style="flex:1">CSV</button>
        <button id="btnDeleteDay" class="btn gray" style="flex:1">Vymazať deň</button>
      </div>
      <div class="sp"></div>
      <div class="row">
        <button id="btnDeleteAll" class="btn red" style="flex:1">Vymazať všetko</button>
      </div>
      <div id="reportWrap" style="display:none"></div>
    </div>

    <!-- Note -->
    <div id="noteCard" class="card">
      <div class="subcard">
        <textarea id="noteText" placeholder="Poznámka"></textarea>
      </div>
    </div>

    <!-- Mini info -->
    <div id="miniInfoWrap" class="card">
      <div class="miniInfo">
        <div class="miniTitle">Plocha</div>
        <div id="miniAddress" class="miniLine">—</div>
        <div id="miniPerson" class="miniLine">—</div>
        <div id="miniPharmacy" class="miniLine">—</div>

        <div class="sp"></div>
        <div class="miniTitle">Plagáty</div>
        <div id="miniPosters" class="miniPills"></div>
      </div>
    </div>

    <div id="appVersion"></div>
  </div>

  <!-- Finish dialog -->
  <dialog id="dlgFinish">
    <div style="font-weight:900;font-size:18px;color:var(--ids-navy)">Ukončiť?</div>
    <div id="finishText" class="muted" style="margin-top:10px"></div>
    <div class="sp2"></div>
    <div class="row">
      <button id="btnFinishNo" class="btn gray" style="flex:1">Nie</button>
      <button id="btnFinishYes" class="btn red" style="flex:1">Áno</button>
    </div>
  </dialog>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const APP_VERSION = "V36-BACKBTN";

    /* ===== SW ===== */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try { await navigator.serviceWorker.register("./sw.js"); } catch (e) {}
      });
    }

    /* ===== Columns ===== */
    const COL_MAIN_AP = "AP";
    const COL_STAND_FROM="AG", COL_STAND_TO="AJ";
    const COL_B1="AK";
    const COL_STATIC="AM";
    const COL_EXPRESS="AL";

    const COL_STAND_CODE="B";
    const COL_B1_CODE="C";
    const COL_STATIC_CODE="AO";

    const COL_CITY="F", COL_STREET="G", COL_HOUSE="H", COL_NAME="J", COL_SURNAME="K", COL_PHARMACY="L";

    function colToIndex(letter){
      let s = String(letter).toUpperCase().replace(/[^A-Z]/g,"");
      let n = 0;
      for (let i=0;i<s.length;i++) n = n*26 + (s.charCodeAt(i)-64);
      return n-1;
    }
    function norm(v){ return String(v ?? "").trim(); }
    function normCode(v){ return norm(v).toUpperCase(); }
    function safeName(s){ return norm(s).replace(/[\\/:*?"<>|]+/g, "_"); }
    function isoDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function fmtTime(ts){
      return String(ts||"").split("T")[1]?.slice(0,8) || "";
    }

    function cleanCodeInput(v){
      let s = String(v ?? "");
      s = s.replace(/\u00A0/g, " ");
      s = s.replace(/\s+/g, "");
      s = s.replace(/[‐-–—]/g, "-");
      s = s.toUpperCase();
      return s;
    }

    function downloadNow(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 4000);
    }

    function rowHasAnyText(row, fromIdx, toIdx){
      for(let i=fromIdx;i<=toIdx;i++){
        if(norm(row[i]) !== "") return true;
      }
      return false;
    }

    function joinCells(row, fromCol, toCol){
      const from = colToIndex(fromCol);
      const to = colToIndex(toCol);
      const parts=[];
      for(let i=from;i<=to;i++){
        const v = norm(row[i]);
        if(v) parts.push(v);
      }
      return parts.join("\n");
    }

    function parseEXTokens(s){
      const t = normCode(s).replace(/[,\.;\/\\]+/g, " ");
      const parts = t.split(/\s+/).filter(Boolean);
      const out = [];
      for(const p of parts){
        const m = /^EX([1-9])$/.exec(p);
        if(m) out.push("EX"+m[1]);
      }
      return Array.from(new Set(out));
    }

    function readExpressPicked(){
      const picked=[];
      for(let i=1;i<=9;i++){
        const ex="EX"+i;
        const cb=document.getElementById("cb_"+ex);
        if(cb && cb.checked) picked.push(ex);
      }
      return picked;
    }

    /* ===== Elements ===== */
    const saveOverlay = document.getElementById("saveOverlay");
    const btnSaveOverlay = document.getElementById("btnSaveOverlay");
    const btnCancelOverlay = document.getElementById("btnCancelOverlay");

    const topOkBanner = document.getElementById('topOkBanner');
    const mainUi = document.getElementById('mainUi');
    const okTitle = document.getElementById('okTitle');
    const okSub = document.getElementById('okSub');
    const btnOkNext = document.getElementById('btnOkNext');
    const btnOkExpress = document.getElementById('btnOkExpress');
    const btnBackToJob = document.getElementById('btnBackToJob');

    const okNextWrap = document.getElementById('okNextWrap');
    const okNextGroup = document.getElementById('okNextGroup');

    const okProofWrap = document.getElementById('okProofWrap');
    const okThumbGrid = document.getElementById('okThumbGrid');

    const apWrap = document.getElementById('apWrap');
    const apInput = document.getElementById('apInput');
    const btnLoad = document.getElementById('btnLoad');
    const btnHomeReport = document.getElementById('btnHomeReport');

    const manualCode = document.getElementById('manualCode');
    const btnCamera = document.getElementById('btnCamera');
    const scanHint = document.getElementById('scanHint');

    const btnScanToggle = document.getElementById('btnScanToggle');
    const btnStopScan = document.getElementById('btnStopScan');
    const panelScan = document.getElementById('panelScan');

    const tasksCard = document.getElementById('tasksCard');
    const remainBar = document.getElementById('remainBar');
    const taskList = document.getElementById('taskList');

    const expressAreaWrap = document.getElementById('expressAreaWrap');
    const expressHint = document.getElementById('expressHint');
    const exGrid = document.getElementById('exGrid');
    const expressExtra = document.getElementById('expressExtra');
    const btnExpressDelivered = document.getElementById('btnExpressDelivered');
    const btnExpressNot = document.getElementById('btnExpressNot');
    const btnExpressClose = document.getElementById('btnExpressClose');

    const photoInput = document.getElementById('photoInput');

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const repName = document.getElementById('repName');
    const repDate = document.getElementById('repDate');
    const btnToggleReport = document.getElementById('btnToggleReport');
    const btnShareHtml = document.getElementById('btnShareHtml');
    const btnExportCsv = document.getElementById('btnExportCsv');
    const reportWrap = document.getElementById('reportWrap');

    const btnDeleteDay = document.getElementById('btnDeleteDay');
    const btnDeleteAll = document.getElementById('btnDeleteAll');

    const noteCard = document.getElementById('noteCard');
    const noteText = document.getElementById('noteText');

    const miniInfoWrap = document.getElementById('miniInfoWrap');
    const miniAddress = document.getElementById('miniAddress');
    const miniPerson = document.getElementById('miniPerson');
    const miniPharmacy = document.getElementById('miniPharmacy');
    const miniPosters = document.getElementById('miniPosters');

    const dlgFinish = document.getElementById('dlgFinish');
    const finishText = document.getElementById('finishText');
    const btnFinish = document.getElementById('btnFinish');
    const btnFinishNo = document.getElementById('btnFinishNo');
    const btnFinishYes = document.getElementById('btnFinishYes');

    const panelReport = document.getElementById('panelReport');

    /* ===== DB ===== */
    let dbRows=null, idx=null;

    const IDX_AP = colToIndex(COL_MAIN_AP);

    const IDX_STAND_FROM = colToIndex(COL_STAND_FROM);
    const IDX_STAND_TO = colToIndex(COL_STAND_TO);
    const IDX_B1 = colToIndex(COL_B1);
    const IDX_STATIC = colToIndex(COL_STATIC);
    const IDX_EXPRESS = colToIndex(COL_EXPRESS);

    const IDX_STAND_CODE = colToIndex(COL_STAND_CODE);
    const IDX_B1_CODE = colToIndex(COL_B1_CODE);
    const IDX_STATIC_CODE = colToIndex(COL_STATIC_CODE);

    const IDX_CITY = colToIndex(COL_CITY);
    const IDX_STREET = colToIndex(COL_STREET);
    const IDX_HOUSE = colToIndex(COL_HOUSE);
    const IDX_NAME = colToIndex(COL_NAME);
    const IDX_SURNAME = colToIndex(COL_SURNAME);
    const IDX_PHARMACY = colToIndex(COL_PHARMACY);

    let navIndex = { byAddr:new Map(), byStreet:new Map(), byCity:new Map() };
    function pushMapList(map, key, value){
      if(!key) return;
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(value);
    }
    function keyCity(row){ return normCode(row[IDX_CITY]); }
    function keyStreet(row){ return normCode(row[IDX_STREET]); }
    function keyHouse(row){ return normCode(row[IDX_HOUSE]); }
    function keyAddr(row){ return [keyCity(row), keyStreet(row), keyHouse(row)].join("|"); }
    function keyCityStreet(row){ return [keyCity(row), keyStreet(row)].join("|"); }

    async function loadDbXlsx(){
      try{
        const res = await fetch("./db.xlsx", { cache:"no-cache" });
        if(!res.ok) throw new Error("db.xlsx not found");
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, { type:"array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        dbRows = XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });

        idx = { byAP:new Map() };
        navIndex = { byAddr:new Map(), byStreet:new Map(), byCity:new Map() };

        for(const row of dbRows){
          const ap = normCode(row[IDX_AP]);
          if(!ap) continue;
          idx.byAP.set(ap, row);

          pushMapList(navIndex.byAddr, keyAddr(row), ap);
          pushMapList(navIndex.byStreet, keyCityStreet(row), ap);
          pushMapList(navIndex.byCity, keyCity(row), ap);
        }
      }catch(e){
        dbRows=null; idx=null;
      }
    }

    function getPostersFromRow(row){
      if(!row) return [];
      const from = colToIndex("AG");
      const to   = colToIndex("AM");
      const set = new Set();
      for(let i=from;i<=to;i++){
        const v0 = norm(row[i]);
        if(!v0) continue;
        v0.split(/[\s,;\/]+/).map(x=>x.trim()).filter(Boolean).forEach(x=>set.add(x));
      }
      return Array.from(set);
    }

    function renderMiniInfo(row){
      if(!row){
        miniInfoWrap.style.display="none";
        noteCard.style.display="block";
        return;
      }

      const city = norm(row[IDX_CITY]);
      const street = norm(row[IDX_STREET]);
      const house = norm(row[IDX_HOUSE]);
      const name = norm(row[IDX_NAME]);
      const surname = norm(row[IDX_SURNAME]);
      const pharmacy = norm(row[IDX_PHARMACY]);

      const addrParts = [city, street, house].filter(Boolean);
      miniAddress.textContent = addrParts.length ? addrParts.join(", ") : "—";

      const personParts = [name, surname].filter(Boolean);
      miniPerson.textContent = personParts.length ? personParts.join(" ") : "—";

      miniPharmacy.textContent = pharmacy ? pharmacy : "—";

      const posters = getPostersFromRow(row);
      miniPosters.innerHTML="";
      if(posters.length){
        posters.forEach(p=>{
          const d=document.createElement("div");
          d.className="miniPill";
          d.textContent=p;
          miniPosters.appendChild(d);
        });
      }else{
        const d=document.createElement("div");
        d.className="miniLine";
        d.textContent="—";
        miniPosters.appendChild(d);
      }

      miniInfoWrap.style.display="block";
      noteCard.style.display="block";
    }

    /* ===== STATE ===== */
    let currentTasks=null;
    let lastBlob=null;

    let expressStatus="NA";
    let expressSuggested=[];
    let sessionLocked=false;

    let waitingForPhoto = false;

    function computeTasks(ap){
      if(!idx) return null;
      const apN = normCode(ap);
      const row = idx.byAP.get(apN);
      if(!row) return null;

      const needStand = rowHasAnyText(row, IDX_STAND_FROM, IDX_STAND_TO);
      const needB1 = norm(row[IDX_B1]) !== "";
      const needStatic = norm(row[IDX_STATIC]) !== "";

      const standCode = norm(row[IDX_STAND_CODE]);
      const b1Code = norm(row[IDX_B1_CODE]);

      let staticBase = norm(row[IDX_STATIC_CODE]);
      staticBase = staticBase.replace(/[A-Z]$/i, "");

      const needExpress = norm(row[IDX_EXPRESS]) !== "";
      const suggestedExpress = parseEXTokens(row[IDX_EXPRESS]);

      const standHint = joinCells(row, "AG", "AJ");
      const b1Hint = norm(row[IDX_B1]);

      return {
        ap: apN, row,
        needStand, needB1, needStatic,
        standCode, b1Code, staticBase,
        needExpress, suggestedExpress,
        standHint, b1Hint
      };
    }

    /* ===== LOG ===== */
    const LOG_KEY="ids_foto_log_v36";
    const REP_KEY="ids_rep_name_v36";

    // OK state persistence
    const OK_STATE_KEY = "ids_ok_state_v36";

    function loadLog(){ try { return JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); } catch { return []; } }
    function saveLog(arr){ localStorage.setItem(LOG_KEY, JSON.stringify(arr)); }

    function pruneLog(log){
      const MAX = 500;
      if(log.length > MAX) return log.slice(-MAX);
      return log;
    }

    function addLogEntry(ap, photoCode, posters, note, file, thumb){
      const now = new Date();
      const entry = {
        ts: now.toISOString().slice(0,19),
        day: isoDate(now),
        who: (repName.value || "").trim(),
        ap: ap || "",
        photoCode: photoCode || "",
        posters: posters || [],
        note: note || "",
        file: file || "",
        thumb: thumb || ""
      };
      const log = loadLog();
      log.push(entry);
      saveLog(pruneLog(log));
    }

    function isPhotoDoneToday(ap, type, code){
      const day = repDate.value || isoDate(new Date());
      const log = loadLog().filter(x => x.day === day && String(x.ap||"") === ap);
      if(type==="exact"){
        return log.some(x => normCode(x.photoCode) === normCode(code));
      }
      return false;
    }

    function isStaticDone(ap, staticBase, suffix){
      const base = normCode(staticBase);
      if(!base) return false;
      const code = suffix ? (base + suffix) : base;
      return isPhotoDoneToday(ap, "exact", code);
    }

    function photosDone(){
      const t=currentTasks;
      if(!t) return false;

      if(t.needStand && t.standCode && !isPhotoDoneToday(t.ap,"exact",t.standCode)) return false;
      if(t.needB1 && t.b1Code && !isPhotoDoneToday(t.ap,"exact",t.b1Code)) return false;

      return true;
    }

    function countRemainingPhotos(){
      const t=currentTasks;
      if(!t) return 0;
      let n=0;
      if(t.needStand && t.standCode && !isPhotoDoneToday(t.ap,"exact",t.standCode)) n++;
      if(t.needB1 && t.b1Code && !isPhotoDoneToday(t.ap,"exact",t.b1Code)) n++;
      return n;
    }

    /* ===== OK STATE (persist) ===== */
    function saveOkState(mode){
      try{
        if(!currentTasks) return;
        const day = repDate.value || isoDate(new Date());
        const state = {
          v: APP_VERSION,
          ts: new Date().toISOString(),
          day,
          ap: currentTasks.ap,
          mode: mode || "ALL",
          expressStatus: expressStatus || "NA"
        };
        localStorage.setItem(OK_STATE_KEY, JSON.stringify(state));
      }catch(e){}
    }
    function clearOkState(){
      try{ localStorage.removeItem(OK_STATE_KEY); }catch(e){}
    }
    function loadOkState(){
      try{ return JSON.parse(localStorage.getItem(OK_STATE_KEY) || "null"); }
      catch(e){ return null; }
    }

    /* ===== Thumbnail maker ===== */
    async function makeThumbFromBlob(blob){
      try{
        const bmp = await createImageBitmap(blob);
        const max = 220;
        const w = bmp.width, h = bmp.height;
        const s = Math.min(1, max / Math.max(w, h));
        const tw = Math.max(1, Math.round(w * s));
        const th = Math.max(1, Math.round(h * s));

        const c = document.createElement("canvas");
        c.width = tw; c.height = th;
        const x = c.getContext("2d");
        x.drawImage(bmp, 0, 0, tw, th);

        const dataUrl = c.toDataURL("image/jpeg", 0.62);
        bmp.close && bmp.close();
        return dataUrl;
      }catch(e){
        return "";
      }
    }

    /* ===== NAV suggestions ===== */
    function labelForAP(ap){
      if(!idx || !idx.byAP.has(ap)) return { who:"—", addr:"—" };
      const r = idx.byAP.get(ap);
      const ph = norm(r[IDX_PHARMACY]);
      const nm = [norm(r[IDX_NAME]), norm(r[IDX_SURNAME])].filter(Boolean).join(" ").trim();
      const who = ph || nm || "—";
      const addr = [norm(r[IDX_CITY]), norm(r[IDX_STREET]), norm(r[IDX_HOUSE])].filter(Boolean).join(", ");
      return { who, addr };
    }

    function apIsFullyDoneToday(ap){
      if(!idx || !idx.byAP.has(ap)) return false;
      const t = computeTasks(ap);
      if(!t) return false;

      if(t.needStand && t.standCode && !isPhotoDoneToday(ap,"exact",t.standCode)) return false;
      if(t.needB1 && t.b1Code && !isPhotoDoneToday(ap,"exact",t.b1Code)) return false;

      return true;
    }

    function buildNextSuggestions(){
      okNextGroup.innerHTML = "";
      okNextWrap.style.display = "none";
      if(!currentTasks || !currentTasks.row || !idx) return;

      const row = currentTasks.row;
      const kA = [normCode(row[IDX_CITY]), normCode(row[IDX_STREET]), normCode(row[IDX_HOUSE])].join("|");
      const kS = [normCode(row[IDX_CITY]), normCode(row[IDX_STREET])].join("|");
      const kC = normCode(row[IDX_CITY]);

      const sameAddr = (navIndex.byAddr.get(kA) || []).filter(ap => ap !== currentTasks.ap && !apIsFullyDoneToday(ap));
      const sameStreet = (navIndex.byStreet.get(kS) || []).filter(ap => ap !== currentTasks.ap && !apIsFullyDoneToday(ap) && !sameAddr.includes(ap));
      const sameCity = (navIndex.byCity.get(kC) || []).filter(ap => ap !== currentTasks.ap && !apIsFullyDoneToday(ap) && !sameAddr.includes(ap) && !sameStreet.includes(ap));

      const groups = [
        { title:"Na tej istej adrese", list:sameAddr.slice(0,6) },
        { title:"Na tej istej ulici", list:sameStreet.slice(0,6) },
        { title:"V tom istom meste", list:sameCity.slice(0,6) }
      ].filter(g => g.list.length);

      if(!groups.length) return;

      groups.forEach(g=>{
        const h = document.createElement("div");
        h.className = "okNextTitle";
        h.textContent = g.title;
        okNextGroup.appendChild(h);

        g.list.forEach(ap=>{
          const info = labelForAP(ap);
          const b = document.createElement("button");
          b.type = "button";
          b.className = "okNextBtn";
          b.innerHTML = `${ap} — ${info.who}<small>${info.addr}</small>`;
          b.addEventListener("click", ()=>{
            hideOkBannerShowDetails();
            startSessionForAP(ap);
          });
          okNextGroup.appendChild(b);
        });
      });

      okNextWrap.style.display = "block";
    }

    function renderOkProofThumbs(){
      okThumbGrid.innerHTML = "";
      okProofWrap.style.display = "none";
      if(!currentTasks) return;

      const day = repDate.value || isoDate(new Date());
      const ap = currentTasks.ap;

      const items = loadLog()
        .filter(x => x.day === day && String(x.ap||"") === ap && norm(x.photoCode) !== "")
        .sort((a,b)=> (a.ts||"").localeCompare(b.ts||""))
        .slice(-12);

      if(!items.length) return;

      items.forEach(it=>{
        const wrap = document.createElement("div");
        wrap.className = "thumbCard";

        const img = document.createElement("img");
        img.className = "thumbImg";
        img.alt = it.photoCode || "";
        img.src = it.thumb || "";
        wrap.appendChild(img);

        const code = document.createElement("div");
        code.className = "thumbCode";
        code.textContent = (it.file || (it.photoCode ? (it.photoCode + ".jpg") : "—"));
        wrap.appendChild(code);

        const t = document.createElement("div");
        t.className = "thumbTime";
        t.textContent = fmtTime(it.ts);
        wrap.appendChild(t);

        okThumbGrid.appendChild(wrap);
      });

      okProofWrap.style.display = "block";
    }

    /* ===== OK banner ===== */
    function showOkBanner(mode){
      if(!currentTasks) return;

      const needExpress = !!currentTasks.needExpress;
      const expressDone = (expressStatus !== "NA");

      if(mode === "ALL"){
        okTitle.textContent = "Všetko hotové";
        okSub.textContent = "Môžeš pokračovať na ďalšiu plochu";
        btnOkExpress.style.display = "none";
      }else{
        okTitle.textContent = "Všetko okrem expressov hotové";
        okSub.textContent = "Ak chceš, potvrď ešte express (voliteľné)";
        btnOkExpress.style.display = needExpress && !expressDone ? "block" : "none";
      }

      renderOkProofThumbs();
      buildNextSuggestions();

      mainUi.style.display = "none";
      topOkBanner.style.display = "block";

      saveOkState(mode);

      window.scrollTo({ top:0, behavior:"smooth" });
    }

    function hideOkBannerShowDetails(){
      topOkBanner.style.display = "none";
      mainUi.style.display = "block";
      window.scrollTo({ top:0, behavior:"smooth" });
    }

    function checkAutoOk(){
      if(!currentTasks) return;
      if(currentTasks.needStatic) return;
      if(!photosDone()) return;

      if(currentTasks.needExpress && expressStatus === "NA"){
        showOkBanner("PHOTOS_ONLY");
      }else{
        showOkBanner("ALL");
      }
    }

    btnOkNext.addEventListener("click", ()=> resetToNew());
    btnOkExpress.addEventListener("click", ()=>{
      hideOkBannerShowDetails();
      openExpressArea();
      window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
    });
    btnBackToJob.addEventListener("click", ()=> hideOkBannerShowDetails());

    /* ===== RENDER TASKS ===== */
    function makeTaskRow({label, code, hint, done, extraClass, onClick}){
      const div = document.createElement("div");
      div.className = "task" + (done ? " done" : "") + (extraClass ? (" " + extraClass) : "");

      const left = document.createElement("div");
      left.className="left";

      const title = document.createElement("div");
      title.className="title";
      title.textContent=label;

      const codeEl = document.createElement("div");
      codeEl.className="code";
      codeEl.textContent=code || "—";

      left.appendChild(title);
      left.appendChild(codeEl);

      if(hint && hint.trim()){
        const hintEl = document.createElement("div");
        hintEl.className="hint";
        hintEl.textContent = hint.trim();
        left.appendChild(hintEl);
      }

      div.appendChild(left);
      div.addEventListener("click", (e)=>{ e.preventDefault(); onClick(); });
      return div;
    }

    function renderExpressUI(){
      exGrid.innerHTML = "";
      const suggested = expressSuggested || [];
      expressHint.textContent = suggested.length ? ("Návrh: " + suggested.join(" ")) : "Bez návrhu";

      const all = ["EX1","EX2","EX3","EX4","EX5","EX6","EX7","EX8","EX9"];
      all.forEach(ex=>{
        const id = "cb_" + ex;
        const wrap = document.createElement("div");
        wrap.className = "exItem";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.checked = suggested.includes(ex);

        const lab = document.createElement("label");
        lab.htmlFor = id;
        lab.textContent = ex;

        wrap.appendChild(cb);
        wrap.appendChild(lab);
        exGrid.appendChild(wrap);
      });
    }

    function openExpressArea(){
      if(!currentTasks || !currentTasks.needExpress) return;
      expressAreaWrap.style.display = "block";
      renderExpressUI();
    }

    function updateRemainBar(){
      if(!currentTasks){
        remainBar.style.display="none";
        return;
      }
      const n = countRemainingPhotos();
      remainBar.style.display="block";
      if(n===0){
        remainBar.classList.add("done");
        remainBar.textContent = "HOTOVO ✓ (stojan + B1)";
      }else{
        remainBar.classList.remove("done");
        remainBar.textContent = "ZOSTÁVA (stojan + B1): " + n;
      }
    }

    function triggerCameraForCode(code){
      const c = cleanCodeInput(code);
      manualCode.value = c;
      scanHint.style.display = "none";
      refreshCameraButton();

      if(document.activeElement) document.activeElement.blur();
      manualCode.blur();

      openCamera();
    }

    function renderTasks(){
      const t = currentTasks;
      taskList.innerHTML = "";
      if(!t) return;

      updateRemainBar();

      if(t.needStand && t.standCode){
        const done = isPhotoDoneToday(t.ap,"exact",t.standCode);
        taskList.appendChild(makeTaskRow({
          label:"Fotím stojan",
          code:t.standCode,
          hint:t.standHint,
          done,
          onClick: ()=> triggerCameraForCode(t.standCode)
        }));
      }

      if(t.needB1 && t.b1Code){
        const done = isPhotoDoneToday(t.ap,"exact",t.b1Code);
        taskList.appendChild(makeTaskRow({
          label:"Fotím B1 plagát",
          code:t.b1Code,
          hint:t.b1Hint,
          done,
          onClick: ()=> triggerCameraForCode(t.b1Code)
        }));
      }

      if(t.needStatic && t.staticBase){
        const base = normCode(t.staticBase);

        const mk = (suffix, label) => {
          const done = isStaticDone(t.ap, base, suffix);
          const code = suffix ? (base + suffix) : base;
          taskList.appendChild(makeTaskRow({
            label,
            code,
            hint:"Klikni a odfoť (voliteľné)",
            done,
            onClick: ()=> triggerCameraForCode(code)
          }));
        };

        mk("",  "Statický plagát");
        mk("A", "Statický plagát A");
        mk("B", "Statický plagát B");
        mk("C", "Statický plagát C");
      }

      if(t.needExpress){
        const done = (expressStatus !== "NA");
        taskList.appendChild(makeTaskRow({
          label:"Express",
          code:(t.suggestedExpress||[]).join(" ") || "—",
          hint:"Klikni pre potvrdenie (voliteľné)",
          done,
          onClick: ()=>{
            openExpressArea();
            window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
          }
        }));
      }

      /* Digital panel (DP) – sivá bublinka */
      const dpCode = (t.ap ? (t.ap + "DP") : "");
      if(dpCode){
        const dpDone = isPhotoDoneToday(t.ap, "exact", dpCode);
        taskList.appendChild(makeTaskRow({
          label:"Fotím digitálny panel",
          code:dpCode,
          hint:"Voliteľné",
          done: dpDone,
          extraClass:"dpTask",
          onClick: ()=> triggerCameraForCode(dpCode)
        }));
      }

      checkAutoOk();
    }

    /* ===== Refresh lock ===== */
    function setRefreshLock(on){
      sessionLocked = !!on;
    }
    window.addEventListener("beforeunload", (e)=>{
      if(sessionLocked && currentTasks && !photosDone()){
        e.preventDefault();
        e.returnValue = "";
      }
    });

    /* ===== PHOTO FLOW ===== */
    function refreshCameraButton(){
      const ok = cleanCodeInput(manualCode.value).length > 0;
      btnCamera.className = ok ? "btn red" : "btn gray";
    }

    function openCamera(){
      if(!manualCode.value.trim()) return;

      waitingForPhoto = true;
      lastBlob = null;
      photoInput.value = "";
      photoInput.click();
    }

    function showSaveOverlay(){
      mainUi.style.display = "none";
      topOkBanner.style.display = "none";
      saveOverlay.style.display = "block";
      window.scrollTo({ top:0, behavior:"instant" });
    }
    function hideSaveOverlay(){
      saveOverlay.style.display = "none";
      mainUi.style.display = "block";
    }

    function showSaveIfFileReturned(){
      if(!waitingForPhoto) return false;

      const f = photoInput.files && photoInput.files[0];
      if(f){
        lastBlob = f;
        waitingForPhoto = false;
        showSaveOverlay();
        return true;
      }
      return false;
    }

    photoInput.addEventListener("change", () => {
      if (showSaveIfFileReturned()) return;

      setTimeout(() => {
        if (showSaveIfFileReturned()) return;

        setTimeout(() => {
          if (showSaveIfFileReturned()) return;

          waitingForPhoto = false;
          lastBlob = null;
          photoInput.value = "";
        }, 500);
      }, 200);
    });

    window.addEventListener("focus", () => {
      if(waitingForPhoto) showSaveIfFileReturned();
    });
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible"){
        if(waitingForPhoto) showSaveIfFileReturned();
      }
    });

    async function doSavePhoto(){
      if(!lastBlob) return;

      const code = cleanCodeInput(manualCode.value);
      manualCode.value = code;
      if(!code) return;

      const thumb = await makeThumbFromBlob(lastBlob);

      const filename = safeName(code) + ".jpg";
      downloadNow(lastBlob, filename);

      const ap = currentTasks?.ap || normCode(apInput.value);

      let posters = [];
      let row = null;
      if(idx && ap && idx.byAP.has(ap)){
        row = idx.byAP.get(ap);
        posters = getPostersFromRow(row);
        renderMiniInfo(row);
      }else{
        renderMiniInfo(null);
      }

      const note = norm(noteText.value);
      addLogEntry(ap, code, posters, note, filename, thumb);

      lastBlob=null;
      waitingForPhoto = false;
      photoInput.value = "";

      hideSaveOverlay();

      if(currentTasks){
        tasksCard.style.display = "block";
        renderTasks();
      }
    }

    btnSaveOverlay.addEventListener("click", doSavePhoto);

    btnCancelOverlay.addEventListener("click", ()=>{
      lastBlob = null;
      waitingForPhoto = false;
      photoInput.value = "";
      hideSaveOverlay();
      if(currentTasks){
        tasksCard.style.display="block";
        renderTasks();
      }
    });

    /* ===== EXPRESS ===== */
    btnExpressClose.addEventListener("click", ()=> expressAreaWrap.style.display="none");

    function logExpress(statusText){
      if(!currentTasks) return;
      const ap = currentTasks.ap;
      const posters = currentTasks.row ? getPostersFromRow(currentTasks.row) : [];
      const baseNote = norm(noteText.value);
      const extra = norm(expressExtra.value);

      let s = statusText;
      if(extra) s += " | " + extra;

      const finalNote = [baseNote, s].filter(Boolean).join(" | ");
      addLogEntry(ap, "", posters, finalNote, "", "");
    }

    btnExpressDelivered.addEventListener("click", ()=>{
      expressStatus = "DELIVERED";
      const pickedNow = readExpressPicked();
      const s = "EXPRESS: " + (pickedNow.join(" ") || "ODOVZDANÝ");
      logExpress(s);
      expressAreaWrap.style.display="none";
      renderTasks();
    });

    btnExpressNot.addEventListener("click", ()=>{
      expressStatus = "NOT";
      logExpress("EXPRESS: NEODOVZDANÝ");
      expressAreaWrap.style.display="none";
      renderTasks();
    });

    /* ===== Finish ===== */
    function missingListForPhotosOnly(){
      const t=currentTasks;
      const miss=[];
      if(!t) return miss;

      if(t.needStand && t.standCode && !isPhotoDoneToday(t.ap,"exact",t.standCode)) miss.push("stojan");
      if(t.needB1 && t.b1Code && !isPhotoDoneToday(t.ap,"exact",t.b1Code)) miss.push("B1");

      return miss;
    }

    btnFinish.addEventListener("click", ()=>{
      if(!currentTasks) return;
      const miss = missingListForPhotosOnly();

      if(miss.length===0){
        if(currentTasks.needExpress && expressStatus==="NA"){ showOkBanner("PHOTOS_ONLY"); return; }
        showOkBanner("ALL");
        return;
      }

      finishText.textContent = "Chýba: " + miss.join(", ");
      dlgFinish.showModal();
    });

    btnFinishNo.addEventListener("click", ()=> dlgFinish.close());
    btnFinishYes.addEventListener("click", ()=>{
      dlgFinish.close();
      resetToNew();
    });

    /* ===== Session UI ===== */
    function setSessionUI(on){
      apWrap.style.display = on ? "none" : "block";
    }

    function resetToNew(){
      clearOkState();

      saveOverlay.style.display="none";
      topOkBanner.style.display="none";
      mainUi.style.display="block";

      tasksCard.style.display="none";
      taskList.innerHTML="";
      currentTasks=null;
      lastBlob=null;

      expressStatus="NA";
      expressSuggested=[];
      expressExtra.value="";
      expressAreaWrap.style.display="none";

      noteText.value="";
      scanHint.style.display="none";
      manualCode.value="";
      refreshCameraButton();

      miniInfoWrap.style.display="none";
      noteCard.style.display="none";

      apInput.value="";

      setRefreshLock(false);
      setSessionUI(false);

      waitingForPhoto = false;
      photoInput.value = "";

      apInput.focus();
      window.scrollTo({ top:0, behavior:"smooth" });
    }

    /* ===== LOAD AP ===== */
    function startSessionForAP(ap){
      clearOkState();

      const apC = cleanCodeInput(ap);
      apInput.value = apC;

      if(!apC || !idx) return;

      const t = computeTasks(apC);
      if(!t){
        tasksCard.style.display="none";
        renderMiniInfo(null);
        currentTasks=null;
        return;
      }

      currentTasks = t;
      expressStatus="NA";
      expressSuggested = t.suggestedExpress || [];
      expressExtra.value="";
      expressAreaWrap.style.display="none";

      renderMiniInfo(t.row);

      tasksCard.style.display="block";
      renderTasks();

      setRefreshLock(true);
      setSessionUI(true);

      apInput.blur();
      window.scrollTo({ top:0, behavior:"smooth" });
    }

    btnLoad.addEventListener("click", ()=>{
      const ap = cleanCodeInput(apInput.value.trim());
      startSessionForAP(ap);
    });

    apInput.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        btnLoad.click();
      }
    });

    /* ===== manual code ===== */
    manualCode.addEventListener("input", ()=>{
      const cleaned = cleanCodeInput(manualCode.value);
      if(manualCode.value !== cleaned) manualCode.value = cleaned;
      scanHint.style.display="none";
      refreshCameraButton();
    });

    apInput.addEventListener("input", ()=>{
      const cleaned = cleanCodeInput(apInput.value);
      if(apInput.value !== cleaned) apInput.value = cleaned;
    });

    btnCamera.addEventListener("click", ()=>{
      const c = cleanCodeInput(manualCode.value.trim());
      manualCode.value = c;
      if(!c) return;

      if(document.activeElement) document.activeElement.blur();
      manualCode.blur();

      openCamera();
    });

    refreshCameraButton();

    /* ===== REPORT ===== */
    function renderReport(){
      const day = repDate.value || isoDate(new Date());
      const log = loadLog().filter(x => x.day === day);
      if(log.length === 0){
        reportWrap.innerHTML = "<div class='muted' style='margin-top:10px'>—</div>";
        return;
      }
      const rows = log.slice().sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));
      let html = `<table>
        <thead><tr>
          <th>Čas</th><th>Kto</th><th>AP</th><th>Fotil</th><th>Plagáty</th><th>Poznámka</th><th>Súbor</th>
        </tr></thead><tbody>`;
      for(const r of rows){
        html += `<tr>
          <td>${fmtTime(r.ts)}</td>
          <td>${r.who||""}</td>
          <td><b>${r.ap||""}</b></td>
          <td>${r.photoCode||""}</td>
          <td>${(r.posters&&r.posters.length)?r.posters.join(", "):"—"}</td>
          <td>${r.note||""}</td>
          <td>${r.file||""}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      reportWrap.innerHTML = html;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    async function shareFileOrDownload(blob, filename){
      try{
        if(navigator.share && window.File){
          const file = new File([blob], filename, { type: blob.type || "application/octet-stream" });
          if(navigator.canShare && navigator.canShare({ files:[file] })){
            await navigator.share({ files:[file], title: filename, text: "IDS Foto report" });
            return true;
          }
        }
      }catch(e){}
      downloadNow(blob, filename);
      return false;
    }

    function buildHtmlReportForDay(day){
      const who = (repName.value || "").trim();
      const rows = loadLog()
        .filter(x => x.day === day)
        .slice()
        .sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));

      const totalPhotos = rows.filter(r => (r.photoCode||"").trim() !== "").length;
      const totalExpress = rows.filter(r => String(r.note||"").includes("EXPRESS:")).length;

      const tr = rows.map(r=>{
        const posters = (r.posters && r.posters.length) ? r.posters.join(", ") : "";
        return `<tr>
          <td>${escapeHtml(fmtTime(r.ts))}</td>
          <td>${escapeHtml(r.who||"")}</td>
          <td><b>${escapeHtml(r.ap||"")}</b></td>
          <td>${escapeHtml(r.photoCode||"")}</td>
          <td>${escapeHtml(posters)}</td>
          <td>${escapeHtml(r.note||"")}</td>
          <td>${escapeHtml(r.file||"")}</td>
        </tr>`;
      }).join("\n");

      const doc = `<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>IDS Foto report ${escapeHtml(day)}</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:18px;color:#0b2a5b;background:#fff}
  h1{font-size:18px;margin:0 0 8px}
  .meta{font-size:12px;color:rgba(11,42,91,.70);font-weight:700;margin:0 0 14px}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 14px}
  .pill{background:#f1f3fb;border-radius:999px;padding:8px 10px;font-weight:800;font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #e9edf6;padding:8px 6px;font-size:12px;vertical-align:top;text-align:left}
  th{font-size:11px;color:rgba(11,42,91,.65);text-transform:uppercase;letter-spacing:.04em}
  b{font-weight:900}
</style>
</head>
<body>
  <h1>IDS Foto – denný report</h1>
  <div class="meta">Deň: <b>${escapeHtml(day)}</b> &nbsp; | &nbsp; Kto: <b>${escapeHtml(who || "—")}</b></div>
  <div class="kpi">
    <div class="pill">Fotky: ${totalPhotos}</div>
    <div class="pill">Express záznamy: ${totalExpress}</div>
    <div class="pill">Záznamy spolu: ${rows.length}</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Čas</th><th>Kto</th><th>AP</th><th>Fotil</th><th>Plagáty</th><th>Poznámka</th><th>Súbor</th>
      </tr>
    </thead>
    <tbody>
      ${tr || "<tr><td colspan='7'>—</td></tr>"}
    </tbody>
  </table>
</body>
</html>`;
      return doc;
    }

    async function shareHtmlReport(){
      const day = repDate.value || isoDate(new Date());
      const html = buildHtmlReportForDay(day);
      const blob = new Blob([html], { type:"text/html;charset=utf-8" });
      const filename = `report_${day}_${safeName(repName.value || "repre")}.html`;
      await shareFileOrDownload(blob, filename);
    }

    function escapeCsv(s){
      const v = String(s ?? "");
      if (/[",\n;]/.test(v)) return `"${v.replaceAll('"','""')}"`;
      return v;
    }
    function exportCsv(){
      const day = repDate.value || isoDate(new Date());
      const log = loadLog().filter(x => x.day === day).sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));
      if(log.length === 0) return;

      const header = ["day","time","who","ap","photoCode","posters","note","file"];
      const lines = [header.join(";")];
      for(const r of log){
        lines.push([
          escapeCsv(r.day),
          escapeCsv(fmtTime(r.ts)),
          escapeCsv(r.who),
          escapeCsv(r.ap),
          escapeCsv(r.photoCode),
          escapeCsv((r.posters && r.posters.length) ? r.posters.join(", ") : ""),
          escapeCsv(r.note),
          escapeCsv(r.file)
        ].join(";"));
      }
      const csv = lines.join("\n");
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      const filename = `report_${day}_${safeName(repName.value || "repre")}.csv`;
      downloadNow(blob, filename);
    }

    function deleteLogsForDay(day){
      const all = loadLog();
      saveLog(all.filter(x => x.day !== day));
    }
    function deleteLogsAll(){ saveLog([]); }

    btnToggleReport.addEventListener("click", ()=>{
      const vis = reportWrap.style.display==="block";
      if(vis){
        reportWrap.style.display="none";
        btnToggleReport.textContent="Zobraziť";
      }else{
        reportWrap.style.display="block";
        btnToggleReport.textContent="Skryť";
        renderReport();
      }
    });

    btnShareHtml.addEventListener("click", shareHtmlReport);
    btnExportCsv.addEventListener("click", exportCsv);

    btnDeleteDay.addEventListener("click", ()=>{
      const day = repDate.value || isoDate(new Date());
      if(!confirm(`Vymazať report len pre deň ${day}?`)) return;
      deleteLogsForDay(day);
      if(reportWrap.style.display === "block") renderReport();
    });
    btnDeleteAll.addEventListener("click", ()=>{
      if(!confirm("Vymazať CELÝ report (všetky dni)?")) return;
      if(!confirm("Naozaj? Toto sa nedá vrátiť späť.")) return;
      deleteLogsAll();
      if(reportWrap.style.display === "block") renderReport();
    });

    btnHomeReport.addEventListener("click", ()=>{
      panelReport.style.display = (panelReport.style.display==="block") ? "none" : "block";
      if(panelReport.style.display==="block"){
        window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
      }
    });

    /* ===== SCAN ===== */
    let stream=null, scanning=false;
    function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
    function stopScan(){ scanning=false; stopStream(); btnStopScan.style.display="none"; }

    async function startScan(){
      if(!('BarcodeDetector' in window)) return;
      if(scanning) return;

      scanning=true;
      btnStopScan.style.display="block";
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:"environment" } }, audio:false });
        video.srcObject = stream;
        await video.play();

        const detector = new BarcodeDetector({ formats:["code_128","ean_13","ean_8","qr_code","code_39","upc_a","upc_e"] });

        const loop = async ()=>{
          if(!scanning) return;

          const w = video.videoWidth || 640;
          const h = video.videoHeight || 480;
          canvas.width = w; canvas.height = h;
          ctx.drawImage(video, 0, 0, w, h);

          try{
            const codes = await detector.detect(canvas);
            if(codes && codes.length){
              const raw = (codes[0].rawValue || "").trim();
              if(raw){
                manualCode.value = cleanCodeInput(raw);
                scanHint.style.display = "block";
                refreshCameraButton();

                stopScan();
                panelScan.style.display="none";

                btnCamera.classList.add("pulse");
                setTimeout(()=>btnCamera.classList.remove("pulse"), 1200);

                if(document.activeElement) document.activeElement.blur();
                manualCode.blur();

                window.scrollTo({ top:0, behavior:"smooth" });
                return;
              }
            }
          }catch(e){}
          requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
      }catch(e){
        stopScan();
      }
    }

    btnScanToggle.addEventListener("click", ()=>{
      panelScan.style.display = (panelScan.style.display==="block") ? "none" : "block";
      if(panelScan.style.display==="block") startScan();
      else stopScan();
    });
    btnStopScan.addEventListener("click", ()=>{
      stopScan();
      panelScan.style.display="none";
    });

    /* ===== Restore OK screen after reopen ===== */
    async function restoreOkIfAny(){
      const st = loadOkState();
      if(!st) return;

      const today = repDate.value || isoDate(new Date());
      if(st.day !== today){ clearOkState(); return; }

      let tries = 0;
      while((!idx || !idx.byAP) && tries < 40){
        await new Promise(r=>setTimeout(r, 100));
        tries++;
      }

      const ap = cleanCodeInput(st.ap || "");
      if(ap && idx && idx.byAP && idx.byAP.has(ap)){
        currentTasks = computeTasks(ap);
        if(currentTasks){
          expressStatus = st.expressStatus || "NA";
          expressSuggested = currentTasks.suggestedExpress || [];
          renderMiniInfo(currentTasks.row);
          renderTasks();

          setRefreshLock(true);
          setSessionUI(true);
        }
      }

      showOkBanner(st.mode || "ALL");
    }

    /* ===== Init ===== */
    repDate.value = (new Date()).toISOString().slice(0,10);
    repName.value = localStorage.getItem(REP_KEY) || "";
    repName.addEventListener('change', ()=> localStorage.setItem(REP_KEY, repName.value.trim()));

    document.getElementById("appVersion").textContent = APP_VERSION;

    loadDbXlsx();
    apInput.focus();
    restoreOkIfAny();
  </script>
</body>
</html>
