<script>
/* =========================================================
   IDS FOTO APP – FULL JS (s čistením vstupu)
   Verzia: V26+
========================================================= */

const APP_VERSION = "V26+";

/* ====== KONFIG STĹPCOV ====== */
const COL_MAIN_AP = "AP";
const COL_STAND_FROM="AG", COL_STAND_TO="AJ";
const COL_B1="AK";
const COL_STATIC="AM";
const COL_EXPRESS="AL";

const COL_STAND_CODE="B";
const COL_B1_CODE="C";
const COL_STATIC_CODE="AO";

const COL_CITY="F", COL_STREET="G", COL_HOUSE="H", COL_NAME="J", COL_SURNAME="K", COL_PHARMACY="L";

/* ====== HELPERS ====== */
function colToIndex(letter){
  let s = String(letter).toUpperCase().replace(/[^A-Z]/g,"");
  let n = 0;
  for (let i=0;i<s.length;i++) n = n*26 + (s.charCodeAt(i)-64);
  return n-1;
}

function norm(v){ return String(v ?? "").trim(); }
function normCode(v){ return norm(v).toUpperCase(); }

function safeName(s){ return norm(s).replace(/[\\/:*?"<>|]+/g, "_"); }

function isoDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function fmtTime(ts){
  return String(ts||"").split("T")[1]?.slice(0,8) || "";
}

/* ====== ČISTENIE VSTUPU (VEĽKÉ PÍSMENÁ, BEZ MEDZIER) ====== */
function cleanCodeInput(v){
  let s = String(v ?? "");
  s = s.replace(/\u00A0/g, " ");     // NBSP
  s = s.replace(/\s+/g, "");        // žiadne medzery
  s = s.replace(/[‐-–—]/g, "-");    // zjednotenie pomlčiek
  s = s.toUpperCase();              // veľké písmená
  return s;
}

/* ====== ELEMENTY ====== */
const apInput = document.getElementById('apInput');
const manualCode = document.getElementById('manualCode');
const btnLoad = document.getElementById('btnLoad');
const btnCamera = document.getElementById('btnCamera');
const scanHint = document.getElementById('scanHint');
const tasksCard = document.getElementById('tasksCard');
const taskList = document.getElementById('taskList');
const afterPhoto = document.getElementById('afterPhoto');
const btnSavePhoto = document.getElementById('btnSavePhoto');
const btnRetake = document.getElementById('btnRetake');
const btnBack = document.getElementById('btnBack');
const photoInput = document.getElementById('photoInput');
const btnMiniScan = document.getElementById('btnMiniScan');
const btnMiniReport = document.getElementById('btnMiniReport');
const panelScan = document.getElementById('panelScan');
const panelReport = document.getElementById('panelReport');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const btnStopScan = document.getElementById('btnStopScan');
const repName = document.getElementById('repName');
const repDate = document.getElementById('repDate');
const btnToggleReport = document.getElementById('btnToggleReport');
const btnExportCsv = document.getElementById('btnExportCsv');
const reportWrap = document.getElementById('reportWrap');
const btnDeleteDay = document.getElementById('btnDeleteDay');
const btnDeleteAll = document.getElementById('btnDeleteAll');
const noteText = document.getElementById('noteText');
const miniInfoWrap = document.getElementById('miniInfoWrap');
const miniAddress = document.getElementById('miniAddress');
const miniPerson = document.getElementById('miniPerson');
const miniPharmacy = document.getElementById('miniPharmacy');
const miniPosters = document.getElementById('miniPosters');
const appVersion = document.getElementById("appVersion");

/* ====== STAV ====== */
let dbRows=null, idx=null;
let currentTasks=null;
let currentPhotoCode="";
let lastBlob=null;

/* ====== INDEXY ====== */
const IDX_AP = colToIndex(COL_MAIN_AP);
const IDX_STAND_FROM = colToIndex(COL_STAND_FROM);
const IDX_STAND_TO = colToIndex(COL_STAND_TO);
const IDX_B1 = colToIndex(COL_B1);
const IDX_STATIC = colToIndex(COL_STATIC);
const IDX_EXPRESS = colToIndex(COL_EXPRESS);
const IDX_STAND_CODE = colToIndex(COL_STAND_CODE);
const IDX_B1_CODE = colToIndex(COL_B1_CODE);
const IDX_STATIC_CODE = colToIndex(COL_STATIC_CODE);
const IDX_CITY = colToIndex(COL_CITY);
const IDX_STREET = colToIndex(COL_STREET);
const IDX_HOUSE = colToIndex(COL_HOUSE);
const IDX_NAME = colToIndex(COL_NAME);
const IDX_SURNAME = colToIndex(COL_SURNAME);
const IDX_PHARMACY = colToIndex(COL_PHARMACY);

/* ====== UTILITY ====== */
function refreshCameraButton(){
  const ok = manualCode.value.trim().length > 0;
  btnCamera.className = ok ? "btn red" : "btn gray";
}

function downloadNow(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 4000);
}

/* ====== NAČÍTANIE DATABÁZY ====== */
async function loadDbXlsx(){
  try{
    const res = await fetch("./db.xlsx", { cache:"no-cache" });
    if(!res.ok) throw new Error("db.xlsx not found");
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type:"array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    dbRows = XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });

    idx = { byAP:new Map() };
    for(const row of dbRows){
      const ap = normCode(row[IDX_AP]);
      if(ap) idx.byAP.set(ap, row);
    }
  }catch(e){
    console.error("DB load error:", e);
    dbRows=null; idx=null;
  }
}

/* ====== PLAGÁTY Z RIADKU ====== */
function getPostersFromRow(row){
  if(!row) return [];
  const from = colToIndex("AG");
  const to   = colToIndex("AM");
  const set = new Set();
  for(let i=from;i<=to;i++){
    const v = norm(row[i]);
    if(!v) continue;
    v.split(/[\s,;\/]+/).map(x=>x.trim()).filter(Boolean).forEach(x=>set.add(x));
  }
  return Array.from(set);
}

/* ====== MINI INFO ====== */
function renderMiniInfo(row){
  if(!row){
    miniInfoWrap.style.display="none";
    return;
  }
  const city = norm(row[IDX_CITY]);
  const street = norm(row[IDX_STREET]);
  const house = norm(row[IDX_HOUSE]);
  const name = norm(row[IDX_NAME]);
  const surname = norm(row[IDX_SURNAME]);
  const pharmacy = norm(row[IDX_PHARMACY]);

  miniAddress.textContent = [city, street, house].filter(Boolean).join(", ") || "—";
  miniPerson.textContent = [name, surname].filter(Boolean).join(" ") || "—";
  miniPharmacy.textContent = pharmacy || "—";

  const posters = getPostersFromRow(row);
  miniPosters.innerHTML="";
  if(posters.length){
    posters.forEach(p=>{
      const d=document.createElement("div");
      d.className="miniPill";
      d.textContent=p;
      miniPosters.appendChild(d);
    });
  }else{
    miniPosters.textContent="—";
  }
  miniInfoWrap.style.display="block";
}

/* ====== ÚLOHY PRE PLOCHU ====== */
function computeTasks(ap){
  if(!idx) return null;
  const apN = normCode(ap);
  const row = idx.byAP.get(apN);
  if(!row) return null;

  const needStand = row[IDX_STAND_FROM] || row[IDX_STAND_TO];
  const needB1 = norm(row[IDX_B1]) !== "";
  const needStatic = norm(row[IDX_STATIC]) !== "";

  return {
    ap: apN,
    row,
    needStand,
    needB1,
    needStatic,
    standCode: norm(row[IDX_STAND_CODE]),
    b1Code: norm(row[IDX_B1_CODE]),
    staticBase: norm(row[IDX_STATIC_CODE])
  };
}

/* ====== NAČÍTANIE PLOCHY ====== */
btnLoad.addEventListener("click", ()=>{
  const ap = cleanCodeInput(apInput.value);
  apInput.value = ap;
  if(!ap || !idx) return;

  const t = computeTasks(ap);
  if(!t){
    tasksCard.style.display="none";
    renderMiniInfo(null);
    currentTasks=null;
    return;
  }

  currentTasks = t;
  renderMiniInfo(t.row);
  renderTasks();
  tasksCard.style.display="block";
});

/* ====== VYKRESLENIE ÚLOH ====== */
function renderTasks(){
  taskList.innerHTML="";
  const t = currentTasks;
  if(!t) return;

  if(t.needStand && t.standCode){
    addTask("Fotím stojan", t.standCode);
  }
  if(t.needB1 && t.b1Code){
    addTask("Fotím B1 plagát", t.b1Code);
  }
  if(t.needStatic && t.staticBase){
    addTask("Fotím statický plagát", t.staticBase);
  }
}

function addTask(label, code){
  const div = document.createElement("div");
  div.className="task";
  div.innerHTML = `<div class="left"><div class="title">${label}</div><div class="code">${code}</div></div>`;
  div.addEventListener("click", ()=>{
    manualCode.value = code;
    refreshCameraButton();
    openCamera();
  });
  taskList.appendChild(div);
}

/* ====== FOTO ====== */
function openCamera(){
  if(!manualCode.value) return;
  photoInput.value="";
  photoInput.click();
}

photoInput.addEventListener('change', ()=>{
  const f = photoInput.files && photoInput.files[0];
  if(!f){
    alert("Foto sa nevrátilo.");
    return;
  }
  lastBlob = f;
  afterPhoto.style.display="block";
  tasksCard.style.display="none";
});

btnRetake.addEventListener("click", ()=>{
  lastBlob=null;
  afterPhoto.style.display="none";
  tasksCard.style.display="block";
  openCamera();
});

btnBack.addEventListener("click", ()=>{
  lastBlob=null;
  afterPhoto.style.display="none";
  tasksCard.style.display="block";
});

btnSavePhoto.addEventListener("click", ()=>{
  if(!lastBlob){ alert("Chýba fotografia."); return; }
  if(!manualCode.value){ alert("Chýba kód."); return; }

  const filename = safeName(manualCode.value)+".jpg";
  downloadNow(lastBlob, filename);

  lastBlob=null;
  afterPhoto.style.display="none";
  tasksCard.style.display="block";
});

/* ====== SKEN ====== */
let stream=null, scanning=false;

function stopStream(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
}

async function startScan(){
  if(!('BarcodeDetector' in window)){
    alert("Skenovanie nie je podporované.");
    return;
  }
  if(scanning) return;
  scanning=true;
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:"environment" } }, audio:false });
    video.srcObject = stream;
    await video.play();
    const detector = new BarcodeDetector({ formats:["code_128","ean_13","ean_8","qr_code","code_39","upc_a","upc_e"] });

    const loop = async ()=>{
      if(!scanning) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      try{
        const codes = await detector.detect(canvas);
        if(codes.length){
          manualCode.value = cleanCodeInput(codes[0].rawValue || "");
          scanHint.style.display="block";
          refreshCameraButton();
          stopScan();
          panelScan.style.display="none";
        }
      }catch(e){}
      requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
  }catch(e){
    stopScan();
  }
}

function stopScan(){
  scanning=false;
  stopStream();
}

btnMiniScan.addEventListener("click", ()=>{
  panelScan.style.display = panelScan.style.display==="block" ? "none" : "block";
  if(panelScan.style.display==="block") startScan();
});

btnStopScan.addEventListener("click", ()=>{
  stopScan();
  panelScan.style.display="none";
});

/* ====== VSTUPY – AUTOMATICKÉ ČISTENIE ====== */
apInput.addEventListener("input", ()=>{
  const c = cleanCodeInput(apInput.value);
  if(apInput.value!==c) apInput.value=c;
});
manualCode.addEventListener("input", ()=>{
  const c = cleanCodeInput(manualCode.value);
  if(manualCode.value!==c) manualCode.value=c;
  scanHint.style.display="none";
  refreshCameraButton();
});

/* ====== REPORT (SKRÁTENÉ) ====== */
const LOG_KEY="ids_foto_log_v26";
function loadLog(){ try { return JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); } catch { return []; } }
function saveLog(arr){ localStorage.setItem(LOG_KEY, JSON.stringify(arr)); }

function addLogEntry(ap, photoCode, posters, note, file){
  const now = new Date();
  const entry = {
    ts: now.toISOString().slice(0,19),
    day: isoDate(now),
    who: (repName.value || "").trim(),
    ap, photoCode, posters, note, file
  };
  const log = loadLog();
  log.push(entry);
  saveLog(log);
}

/* ====== INIT ====== */
repDate.value = (new Date()).toISOString().slice(0,10);
appVersion.textContent = APP_VERSION;
loadDbXlsx();
refreshCameraButton();
apInput.focus();

</script>
