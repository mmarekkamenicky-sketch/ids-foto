<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDS Foto</title>
  <link rel="manifest" href="manifest.json">

  <!-- Onest (fallback na system font ak offline) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --red:#b00020;
      --black:#111;
      --gray:#666;
      --line:#ddd;
      --ok:#0a7a2f;
      --bad:#b00020;
      --soft:#f6f6f6;
      --blue:#0b57d0;
      --blueSoft:#e7f0ff;
    }

    body{
      font-family: Onest, "Aptos Narrow", Aptos, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      margin:14px;max-width:820px
    }
    *{border-radius:0 !important}

    .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .badge{display:inline-block;padding:6px 10px;background:#f2f2f2;font-weight:900;border:1px solid #e5e5e5}

    .card{border:1px solid var(--line);padding:12px;margin-top:12px}
    .tiny{font-size:12px;color:var(--gray);margin-top:8px}

    input, textarea{
      width:100%;
      padding:12px 12px;
      border:1px solid #ccc;
      font-size:16px;
      background:#fff;
      font-family: inherit;
    }
    textarea{min-height:70px;resize:vertical}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:10px}
    .iconBtn{
      border:2px solid var(--black);
      padding:18px 10px;
      background:#fff;
      font-weight:900;
      font-size:15px;
      text-align:center;
      display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;
      user-select:none
    }
    .icon{font-size:34px;line-height:1;color:var(--black)}
    .iconBtn:active{transform:scale(.99)}
    .iconBtn:disabled{opacity:.35}
    .iconBtn.camera.enabled{border-color:var(--red)}

    .btn{
      padding:14px 14px;border:2px solid var(--black);background:#fff;font-weight:900;width:100%;
      font-family: inherit;
    }
    .btn.save{background:var(--red);border-color:var(--red);color:#fff}
    .btn.danger{border-color:var(--red);color:var(--red)}

    video,img{width:100%;border:1px solid #eee;background:#000;margin-top:12px}

    dialog{border:none;padding:14px;max-width:420px;width:92vw}
    dialog::backdrop{background:rgba(0,0,0,.45)}

    .pill{display:inline-block;border:1px solid var(--black);padding:6px 10px;margin:4px 6px 0 0;font-weight:900}

    /* √ölohy */
    .task{
      border:2px solid var(--bad);
      background:#fff;
      padding:10px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .task small{display:block;font-weight:700;color:#333;margin-top:6px}
    .task .code{display:inline-block;margin-top:6px;padding:6px 10px;background:var(--soft);border:1px solid #ddd}
    .task.done{
      border-color:var(--ok);
      color:var(--ok);
    }
    .task.done .code{border-color:#cfe8d7;background:#f2fbf5}
    .task.muted{opacity:.55;cursor:default}
    .taskHeader{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .check{font-weight:900}
    .warn{color:var(--bad);font-weight:900}

    /* Express */
    .exWrap{margin-top:10px;border-top:1px dashed #ddd;padding-top:10px}
    .exTitle{font-weight:900;margin-bottom:8px}
    .exGrid{display:grid;grid-template-columns:repeat(9,1fr);gap:8px}
    .exBox{
      border:2px solid #bbb;
      padding:10px 0;
      text-align:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      background:#fff;
    }
    .exBox.on{
      border-color:var(--blue);
      background:var(--blueSoft);
      color:var(--blue);
    }
    .exBox.pre{
      border-color:var(--blue);
      color:var(--blue);
      background:#fff;
    }
    .exHint{font-size:12px;color:#444;margin-top:8px}
    .okToast{
      margin-top:10px;
      border:2px solid var(--ok);
      color:var(--ok);
      font-weight:900;
      padding:10px;
      background:#f2fbf5;
    }

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;font-size:12.5px;vertical-align:top}
    th{text-align:left;font-size:11px;color:#666}
  </style>
</head>
<body>

  <div class="top">
    <div>K√≥d: <span id="codeOut" class="badge">‚Äî</span></div>
    <div id="dbOut" class="badge">DB: ‚Ä¶</div>
  </div>

  <!-- √ölohy podƒæa AP -->
  <div class="card">
    <div style="font-weight:900;margin-bottom:8px">√ölohy pre plochu (AP)</div>
    <div class="row2">
      <input id="apInput" placeholder="Zadaj AP (k√≥d plochy) ‚Äì napr. 2972" />
      <button id="btnLoadTasks" class="btn">Naƒç√≠ta≈• √∫lohy</button>
    </div>
    <div class="tiny">Klikni na ‚ÄûFot√≠m‚Ä¶‚Äú ‚Üí hneƒè sa otvor√≠ fotoapar√°t.</div>
    <div id="tasksWrap" style="margin-top:10px"></div>
  </div>

  <!-- 3 ikonky -->
  <div class="grid">
    <button id="btnScan" class="iconBtn">
      <div class="icon">‚ñ£</div><div>Skenova≈•</div>
    </button>

    <button id="btnManual" class="iconBtn">
      <div class="icon">‚å®</div><div>Zada≈•</div>
    </button>

    <button id="btnPhoto" class="iconBtn camera" disabled>
      <div class="icon">‚óâ</div><div>Foto</div>
    </button>
  </div>

  <div id="scanWrap" style="display:none">
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <div style="margin-top:10px"><button id="btnStop" class="btn">Stop</button></div>
  </div>

  <img id="preview" style="display:none" alt="N√°hƒæad" />

  <div id="afterPhoto" style="display:none;margin-top:10px">
    <div class="card" style="margin-top:0">
      <div style="font-weight:900;margin-bottom:8px">Pozn√°mka (voliteƒæn√©)</div>
      <textarea id="noteInput" placeholder="napr. zatvoren√° / odmietnut√° / prer√°bka / r√°m po≈°koden√Ω..."></textarea>

      <div id="expressWrap" class="exWrap" style="display:none">
        <div class="exTitle">Express som odovzdal</div>
        <div id="exGrid" class="exGrid"></div>
        <div class="exHint">Modr√© = odpor√∫ƒçan√© podƒæa DB (AL). Klikni ƒço si re√°lne odovzdal.</div>
      </div>

      <div id="allDoneToast" class="okToast" style="display:none">Pri tejto ploche som urobil v≈°etko ‚úÖ</div>
    </div>

    <div style="height:10px"></div>
    <button id="btnSave" class="btn save">Ulo≈æi≈•</button>
    <div style="height:10px"></div>
    <button id="btnRetake" class="btn">Znova</button>
    <div style="height:10px"></div>
    <button id="btnNextScan" class="btn">Skenova≈• nov√©</button>
  </div>

  <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />

  <dialog id="dlg">
    <div style="font-weight:900;margin-bottom:10px">Zada≈• k√≥d (pre fotenie)</div>
    <input id="manualText" placeholder="napr. 8544 alebo 558774C" />
    <div style="margin-top:10px">
      <button id="dlgOk" class="btn">OK</button>
      <div style="height:10px"></div>
      <button id="dlgCancel" class="btn">Zru≈°i≈•</button>
    </div>
    <div class="tiny">Tip: m√¥≈æe by≈• aj text.</div>
  </dialog>

  <!-- Zisti≈• plag√°ty -->
  <div class="card">
    <div style="font-weight:900;margin-bottom:8px">Zisti≈• plag√°ty (AG‚ÄìAM)</div>
    <input id="lookupCode" placeholder="K√≥d plochy (AP) ‚Äì sem zadaj" />
    <div style="height:10px"></div>
    <button id="btnLookup" class="btn">Zobrazi≈• plag√°ty</button>
    <div id="posters" style="margin-top:10px"></div>
  </div>

  <!-- Report -->
  <div class="card">
    <div style="font-weight:900;margin-bottom:8px">Denn√Ω report</div>

    <div class="row2">
      <div>
        <div class="tiny">D√°tum</div>
        <input id="repDate" type="date" />
      </div>
      <div>
        <div class="tiny">Kto fotil (reprezentant)</div>
        <input id="repName" placeholder="napr. Jano" />
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="row2">
      <button id="btnShowReport" class="btn">Zobrazi≈•</button>
      <button id="btnExportCsv" class="btn">Export CSV</button>
    </div>

    <div style="height:10px"></div>
    <div class="row2">
      <button id="btnClearDay" class="btn danger">Vymaza≈• de≈à</button>
      <button id="btnClearAll" class="btn danger">Vymaza≈• v≈°etko</button>
    </div>

    <div id="reportWrap"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

  // =========================
  // KONFIG ‚Äì tvoje stƒ∫pce
  // =========================
  const COL_MAIN_AP = "AP";
  const CODE_COLUMNS = ["B","C","AO"];

  // report text
  const COL_CITY   = "F";
  const COL_STREET = "G";
  const COL_HOUSE  = "H";
  const COL_FIRST  = "J";
  const COL_LAST   = "K";
  const COL_PHARM  = "L";

  // plag√°ty
  const COL_POSTER_FROM = "AG";
  const COL_POSTER_TO   = "AM";

  // √ölohy
  const COL_STAND_FROM = "AG";
  const COL_STAND_TO   = "AJ";
  const COL_B1         = "AK";
  const COL_STATIC     = "AM";

  // Express v DB
  const COL_EXPRESS = "AL";
  // =========================

  const codeOut = document.getElementById('codeOut');
  const dbOut = document.getElementById('dbOut');

  const apInput = document.getElementById('apInput');
  const btnLoadTasks = document.getElementById('btnLoadTasks');
  const tasksWrap = document.getElementById('tasksWrap');

  const btnScan = document.getElementById('btnScan');
  const btnManual = document.getElementById('btnManual');
  const btnPhoto = document.getElementById('btnPhoto');

  const scanWrap = document.getElementById('scanWrap');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const btnStop = document.getElementById('btnStop');

  const photoInput = document.getElementById('photoInput');
  const preview = document.getElementById('preview');
  const afterPhoto = document.getElementById('afterPhoto');
  const btnSave = document.getElementById('btnSave');
  const btnRetake = document.getElementById('btnRetake');
  const btnNextScan = document.getElementById('btnNextScan');
  const noteInput = document.getElementById('noteInput');

  const expressWrap = document.getElementById('expressWrap');
  const exGrid = document.getElementById('exGrid');
  const allDoneToast = document.getElementById('allDoneToast');

  const dlg = document.getElementById('dlg');
  const manualText = document.getElementById('manualText');
  const dlgOk = document.getElementById('dlgOk');
  const dlgCancel = document.getElementById('dlgCancel');

  const lookupCode = document.getElementById('lookupCode');
  const btnLookup = document.getElementById('btnLookup');
  const postersEl = document.getElementById('posters');

  const repDate = document.getElementById('repDate');
  const repName = document.getElementById('repName');
  const btnShowReport = document.getElementById('btnShowReport');
  const btnExportCsv = document.getElementById('btnExportCsv');
  const btnClearDay = document.getElementById('btnClearDay');
  const btnClearAll = document.getElementById('btnClearAll');
  const reportWrap = document.getElementById('reportWrap');

  let currentCode = "";
  let stream = null;
  let scanning = false;
  let lastBlob = null;

  // posledne naƒç√≠tan√° plocha (AP) + jej √∫lohy
  let currentAP = "";
  let currentTasks = null; // {needStand, needB1, needStatic, needExpress, standCode, b1Code, staticCodeBase, row}

  // express state
  let expressPref = new Set();  // ƒço je v DB AL
  let expressPick = new Set();  // ƒço user vyklik√°

  // ===== DB =====
  let dbRows = null;
  let idx = null;

  function colToIndex(letter){
    let s = String(letter).toUpperCase().replace(/[^A-Z]/g,"");
    let n = 0;
    for (let i=0;i<s.length;i++) n = n*26 + (s.charCodeAt(i)-64);
    return n-1;
  }

  const IDX_MAIN_AP = colToIndex(COL_MAIN_AP);
  const IDX_CODE_COLS = CODE_COLUMNS.map(c => colToIndex(c));

  const IDX_CITY = colToIndex(COL_CITY);
  const IDX_STREET = colToIndex(COL_STREET);
  const IDX_HOUSE = colToIndex(COL_HOUSE);
  const IDX_FIRST = colToIndex(COL_FIRST);
  const IDX_LAST = colToIndex(COL_LAST);
  const IDX_PHARM = colToIndex(COL_PHARM);

  const IDX_P_FROM = colToIndex(COL_POSTER_FROM);
  const IDX_P_TO   = colToIndex(COL_POSTER_TO);

  const IDX_STAND_FROM = colToIndex(COL_STAND_FROM);
  const IDX_STAND_TO   = colToIndex(COL_STAND_TO);
  const IDX_B1         = colToIndex(COL_B1);
  const IDX_STATIC     = colToIndex(COL_STATIC);
  const IDX_EXPRESS    = colToIndex(COL_EXPRESS);

  function normCode(v){ return String(v ?? "").trim().toUpperCase(); }

  function stripSuffixABC(code){
    const s = normCode(code);
    if(!s) return "";
    if(/[A-Z]$/.test(s)) return s.slice(0, -1);
    return s;
  }

  function tokenizeCodes(cell){
    const raw = normCode(cell);
    if(!raw) return [];
    return raw.split(/[\s,;\/]+/).map(x=>x.trim()).filter(Boolean);
  }

  function buildIndex(){
    idx = {
      byAP: new Map(),
      byAny: new Map()
    };
    if(!dbRows) return;

    for(let r=0; r<dbRows.length; r++){
      const row = dbRows[r];
      if(!row) continue;

      const ap = normCode(row[IDX_MAIN_AP]);
      if(ap) idx.byAP.set(ap, row);

      for(const ci of IDX_CODE_COLS){
        const codes = tokenizeCodes(row[ci]);
        for(const c of codes){
          const cc = normCode(c);
          if(!cc) continue;
          idx.byAny.set(cc, row);
          const base = stripSuffixABC(cc);
          if(base) idx.byAny.set(base, row);
        }
      }
    }
  }

  async function loadDbXlsx(){
    try{
      const res = await fetch("./db.xlsx", { cache: "no-cache" });
      if(!res.ok) throw new Error("db.xlsx not found");
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      dbRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
      buildIndex();
      dbOut.textContent = "DB: OK";
    }catch(e){
      dbRows = null;
      idx = null;
      dbOut.textContent = "DB: ‚Äî";
    }
  }

  function getRowForPhotoCode(photoCode){
    if(!idx) return null;
    const c = normCode(photoCode);
    if(!c) return null;
    if(idx.byAP.has(c)) return { ap: c, row: idx.byAP.get(c) };
    if(idx.byAny.has(c)){
      const row = idx.byAny.get(c);
      return { ap: normCode(row[IDX_MAIN_AP]), row };
    }
    const base = stripSuffixABC(c);
    if(base && idx.byAny.has(base)){
      const row = idx.byAny.get(base);
      return { ap: normCode(row[IDX_MAIN_AP]), row };
    }
    return null;
  }

  function getPostersFromRow(row){
    if(!row) return [];
    const set = new Set();
    for(let i=IDX_P_FROM;i<=IDX_P_TO;i++){
      const v = String(row[i] ?? "").trim();
      if(!v) continue;
      v.split(/[\s,;\/]+/).map(x=>x.trim()).filter(Boolean).forEach(x=>set.add(x));
    }
    return Array.from(set);
  }

  function makeJoinedText(row){
    if(!row) return "";
    const city = String(row[IDX_CITY] ?? "").trim();
    const street = String(row[IDX_STREET] ?? "").trim();
    const house = String(row[IDX_HOUSE] ?? "").trim();
    const first = String(row[IDX_FIRST] ?? "").trim();
    const last  = String(row[IDX_LAST] ?? "").trim();
    const pharm = String(row[IDX_PHARM] ?? "").trim();

    const addr = [city, [street, house].filter(Boolean).join(" ")].filter(Boolean).join(", ");
    const name = [first, last].filter(Boolean).join(" ");
    return [addr, name, pharm].filter(Boolean).join(" | ");
  }

  function rowHasAnyText(row, fromIdx, toIdx){
    for(let i=fromIdx;i<=toIdx;i++){
      if(String(row[i] ?? "").trim() !== "") return true;
    }
    return false;
  }

  // ===== Local report =====
  const LOG_KEY = "ids_foto_log_v5";
  const REP_KEY = "ids_rep_name_v5";

  function loadLog(){
    try { return JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); }
    catch { return []; }
  }
  function saveLog(arr){
    localStorage.setItem(LOG_KEY, JSON.stringify(arr));
  }

  function safeName(s){
    return String(s || "").trim().replace(/[\\/:*?"<>|]+/g, "_");
  }

  function setCode(v){
    currentCode = String(v || "").trim();
    codeOut.textContent = currentCode || "‚Äî";
    const has = !!currentCode;
    btnPhoto.disabled = !has;
    btnPhoto.classList.toggle("enabled", has);
  }

  function isoDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function fmtTime(ts){
    return String(ts||"").split("T")[1]?.slice(0,8) || "";
  }

  // ===== Express UI =====
  function parseExTokens(text){
    const s = normCode(text);
    if(!s) return new Set();
    const toks = s.split(/[\s,;\/]+/).filter(Boolean);
    const out = new Set();
    for(const t of toks){
      if(/^EX[1-9]$/.test(t)) out.add(t);
    }
    return out;
  }

  function renderExpressGrid(){
    exGrid.innerHTML = "";
    for(let i=1;i<=9;i++){
      const token = "EX"+i;
      const div = document.createElement("div");
      div.className = "exBox";

      // "pre" = u≈æ v DB, "on" = user vybral
      if(expressPref.has(token)) div.classList.add("pre");
      if(expressPick.has(token)) div.classList.add("on");

      div.textContent = token;
      div.addEventListener("click", ()=>{
        if(expressPick.has(token)) expressPick.delete(token);
        else expressPick.add(token);
        renderExpressGrid();
        updateAllDoneToast();
      });
      exGrid.appendChild(div);
    }
  }

  function getExpressNotePart(){
    const arr = Array.from(expressPick);
    arr.sort();
    if(arr.length === 0) return "";
    return "EXPRESS: " + arr.join(" ");
  }

  // ===== √ölohy podƒæa AP =====
  function isTaskDoneToday(ap, kind, standCode, b1Code, staticBase){
    const day = repDate.value || isoDate(new Date());
    const log = loadLog().filter(x => x.day === day && String(x.ap||"") === ap);

    if(kind === "stand"){
      return log.some(x => normCode(x.photoCode) === normCode(standCode));
    }
    if(kind === "b1"){
      return log.some(x => normCode(x.photoCode) === normCode(b1Code));
    }
    if(kind === "static"){
      return log.some(x => stripSuffixABC(x.photoCode) === normCode(staticBase));
    }
    return false;
  }

  function computeTasksForAP(ap){
    if(!idx) return null;
    const apN = normCode(ap);
    const row = idx.byAP.get(apN);
    if(!row) return null;

    const needStand  = rowHasAnyText(row, IDX_STAND_FROM, IDX_STAND_TO);
    const needB1     = String(row[IDX_B1] ?? "").trim() !== "";
    const needStatic = String(row[IDX_STATIC] ?? "").trim() !== "";

    const standCode  = String(row[colToIndex("B")] ?? "").trim();
    const b1Code     = String(row[colToIndex("C")] ?? "").trim();
    const staticCode = String(row[colToIndex("AO")] ?? "").trim(); // base

    const expressCell = String(row[IDX_EXPRESS] ?? "").trim();
    const needExpress = expressCell !== "";
    const expressPrefSet = parseExTokens(expressCell);

    return {
      ap: apN,
      row,
      needStand, needB1, needStatic,
      standCode, b1Code, staticCodeBase: staticCode,
      needExpress,
      expressPrefSet
    };
  }

  function updateAllDoneToast(){
    // zobrazuj iba keƒè m√°me naƒç√≠tan√∫ plochu
    if(!currentTasks){ allDoneToast.style.display="none"; return; }

    const t = currentTasks;
    const okStand  = !t.needStand  || isTaskDoneToday(t.ap, "stand",  t.standCode, t.b1Code, t.staticCodeBase);
    const okB1     = !t.needB1     || isTaskDoneToday(t.ap, "b1",     t.standCode, t.b1Code, t.staticCodeBase);
    const okStatic = !t.needStatic || isTaskDoneToday(t.ap, "static", t.standCode, t.b1Code, t.staticCodeBase);

    // express: ak treba express, vy≈æaduj aspo≈à 1 vyklikan√Ω EX (re√°lne odovzdan√©)
    const okExpress = !t.needExpress || expressPick.size > 0;

    const allOk = okStand && okB1 && okStatic && okExpress;

    allDoneToast.style.display = allOk ? "block" : "none";
  }

  function renderTasksForAP(ap){
    tasksWrap.innerHTML = "";
    if(!idx){
      tasksWrap.innerHTML = `<div class="warn">DB nie je naƒç√≠tan√°</div>`;
      return;
    }
    const t = computeTasksForAP(ap);
    if(!t){
      tasksWrap.innerHTML = `<div class="warn">AP nen√°jden√© v DB</div>`;
      return;
    }

    currentAP = t.ap;
    currentTasks = t;

    // express init (prefill z DB)
    expressPref = new Set(t.expressPrefSet);
    expressPick = new Set(); // user zatiaƒæ niƒç nevybral
    expressWrap.style.display = t.needExpress ? "block" : "none";
    if(t.needExpress) renderExpressGrid();

    const makeTask = (kind, label, code, enabled) => {
      const done = enabled ? isTaskDoneToday(t.ap, kind, t.standCode, t.b1Code, t.staticCodeBase) : false;
      const cls = enabled ? (done ? "task done" : "task") : "task muted";
      const status = enabled ? (done ? `‚úì Odfoten√©` : `‚è∫ ƒåak√°`) : `‚Äî`;

      return `
        <div class="${cls}" data-kind="${kind}" data-code="${code}">
          <div class="taskHeader">
            <div>${label}</div>
            <div class="check">${status}</div>
          </div>
          <small>K√≥d: <span class="code">${code || "‚Äî"}</span></small>
        </div>
      `;
    };

    const parts = [];
    parts.push(`<div class="tiny">AP: <b>${t.ap}</b> ‚Äî klikni na √∫lohu a otvor√≠ sa foto</div>`);
    parts.push(`<div class="row3" style="margin-top:10px">`);
    parts.push(makeTask("stand",  "Fot√≠m stojan",          t.standCode,  t.needStand && !!t.standCode));
    parts.push(makeTask("b1",     "Fot√≠m B1 r√°m",          t.b1Code,     t.needB1 && !!t.b1Code));
    parts.push(makeTask("static", "Fot√≠m statick√Ω plag√°t", t.staticCodeBase, t.needStatic && !!t.staticCodeBase));
    parts.push(`</div>`);
    tasksWrap.innerHTML = parts.join("");

    // klik na √∫lohu => nastav k√≥d a HNEƒé otvori≈• fotoapar√°t
    tasksWrap.querySelectorAll(".task").forEach(el=>{
      if(el.classList.contains("muted")) return;
      el.addEventListener("click", ()=>{
        const code = el.getAttribute("data-code") || "";
        if(!code) return;
        setCode(code);
        openCamera(); // üî• turbo
      });
    });

    updateAllDoneToast();
  }

  // ===== Scan =====
  function stopStream(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }
  function stopScan(){
    scanning = false;
    scanWrap.style.display = "none";
    stopStream();
  }

  async function startScan(){
    if (!('BarcodeDetector' in window)) {
      dlg.showModal();
      setTimeout(()=>manualText.focus(), 50);
      return;
    }
    scanning = true;
    scanWrap.style.display = "block";

    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:"environment" } }, audio:false
      });
      video.srcObject = stream;
      await video.play();

      const detector = new BarcodeDetector({ formats:["code_128","ean_13","ean_8","qr_code","code_39","upc_a","upc_e"] });

      const loop = async () => {
        if(!scanning) return;

        const w = video.videoWidth || 640;
        const h = video.videoHeight || 480;
        canvas.width = w; canvas.height = h;
        ctx.drawImage(video, 0, 0, w, h);

        try{
          const codes = await detector.detect(canvas);
          if(codes && codes.length){
            const raw = (codes[0].rawValue || "").trim();
            if(raw){
              setCode(raw);
              stopScan();
              return;
            }
          }
        }catch(e){}
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);

    }catch(e){
      stopScan();
      dlg.showModal();
      setTimeout(()=>manualText.focus(), 50);
    }
  }

  function openCamera(){
    if(!currentCode) return;
    photoInput.value = "";
    photoInput.click();
  }

  function downloadNow(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 4000);
  }

  // ===== Lookup posters =====
  function showPostersFor(apCode){
    postersEl.innerHTML = "";
    if(!idx){
      postersEl.innerHTML = "<span class='pill'>DB nie je naƒç√≠tan√°</span>";
      return;
    }
    const wanted = normCode(apCode);
    if(!wanted){
      postersEl.innerHTML = "<span class='pill'>Zadaj k√≥d</span>";
      return;
    }
    const row = idx.byAP.get(wanted);
    if(!row){
      postersEl.innerHTML = "<span class='pill'>nen√°jden√©</span>";
      return;
    }
    const posters = getPostersFromRow(row);
    if(posters.length === 0){
      postersEl.innerHTML = "<span class='pill'>‚Äî</span>";
      return;
    }
    postersEl.innerHTML = posters.map(x => `<span class="pill">${x}</span>`).join("");
  }

  // ===== Report =====
  function renderReport(){
    const day = repDate.value || isoDate(new Date());
    const log = loadLog().filter(x => x.day === day);

    if(log.length === 0){
      reportWrap.innerHTML = "<div class='tiny' style='margin-top:10px'>≈Ωiadne z√°znamy pre tento de≈à.</div>";
      return;
    }

    const rows = log.slice().sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));

    let html = `<table>
      <thead><tr>
        <th>ƒåas</th><th>Kto</th><th>AP</th><th>Fotil</th><th>Text</th><th>Plag√°ty</th><th>Pozn√°mka</th><th>S√∫bor</th>
      </tr></thead><tbody>`;

    for(const r of rows){
      html += `<tr>
        <td>${fmtTime(r.ts)}</td>
        <td>${r.who || ""}</td>
        <td><b>${r.ap || ""}</b></td>
        <td>${r.photoCode || ""}</td>
        <td>${r.joined || ""}</td>
        <td>${(r.posters && r.posters.length) ? r.posters.join(", ") : "‚Äî"}</td>
        <td>${r.note || ""}</td>
        <td>${r.file || ""}</td>
      </tr>`;
    }
    html += `</tbody></table>
      <div class="tiny" style="margin-top:8px">Spolu: <b>${rows.length}</b></div>`;
    reportWrap.innerHTML = html;
  }

  function escapeCsv(s){
    const v = String(s ?? "");
    if (/[",\n;]/.test(v)) return `"${v.replaceAll('"','""')}"`;
    return v;
  }

  function exportCsv(){
    const day = repDate.value || isoDate(new Date());
    const log = loadLog().filter(x => x.day === day).sort((a,b)=> (a.ts||"").localeCompare(b.ts||""));
    if(log.length === 0){
      alert("Pre tento de≈à nie s√∫ ≈æiadne z√°znamy.");
      return;
    }

    const header = ["day","time","who","ap","photoCode","joinedText","posters","note","file"];
    const lines = [header.join(";")];

    for(const r of log){
      lines.push([
        escapeCsv(r.day),
        escapeCsv(fmtTime(r.ts)),
        escapeCsv(r.who),
        escapeCsv(r.ap),
        escapeCsv(r.photoCode),
        escapeCsv(r.joined),
        escapeCsv((r.posters && r.posters.length) ? r.posters.join(", ") : ""),
        escapeCsv(r.note),
        escapeCsv(r.file)
      ].join(";"));
    }

    const csv = lines.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const filename = `report_${day}_${safeName(repName.value || "repre")}.csv`;
    downloadNow(blob, filename);
  }

  function clearDay(){
    const day = repDate.value || isoDate(new Date());
    if(!confirm("Vymaza≈• z√°znamy pre de≈à " + day + "?")) return;
    const log = loadLog().filter(x => x.day !== day);
    saveLog(log);
    renderReport();
    if(apInput.value.trim()) renderTasksForAP(apInput.value.trim());
  }

  function clearAll(){
    if(!confirm("Vymaza≈• V≈†ETKY z√°znamy reportu v tomto telef√≥ne?")) return;
    saveLog([]);
    renderReport();
    if(apInput.value.trim()) renderTasksForAP(apInput.value.trim());
  }

  // ===== Save photo => log + refresh tasks =====
  function buildFinalNote(){
    const userNote = (noteInput.value || "").trim();
    const exPart = getExpressNotePart();

    if(userNote && exPart) return userNote + " | " + exPart;
    if(exPart) return exPart;
    return userNote;
  }

  // ===== UI events =====
  btnScan.addEventListener('click', startScan);
  btnStop.addEventListener('click', stopScan);

  btnManual.addEventListener('click', ()=>{
    dlg.showModal();
    manualText.value = currentCode;
    setTimeout(()=>manualText.focus(), 50);
  });
  dlgOk.addEventListener('click', ()=>{
    const v = manualText.value.trim();
    if(v) setCode(v);
    dlg.close();
  });
  dlgCancel.addEventListener('click', ()=> dlg.close());
  manualText.addEventListener('keydown', (e)=>{ if(e.key==="Enter") dlgOk.click(); });

  btnPhoto.addEventListener('click', openCamera);

  photoInput.addEventListener('change', ()=>{
    const f = photoInput.files && photoInput.files[0];
    if(!f) return;
    lastBlob = f;
    preview.src = URL.createObjectURL(f);
    preview.style.display = "block";
    afterPhoto.style.display = "block";

    // keƒè fot√≠m mimo ‚ÄûAP √∫loh‚Äú, express sekcia sa skryje
    // keƒè som naƒç√≠tal AP, nech√°me express sekciu podƒæa potreby
    if(currentTasks && currentTasks.needExpress){
      expressWrap.style.display = "block";
      renderExpressGrid();
    }else{
      expressWrap.style.display = "none";
    }

    updateAllDoneToast();
  });

  btnRetake.addEventListener('click', ()=>{
    lastBlob = null;
    preview.style.display = "none";
    preview.src = "";
    afterPhoto.style.display = "none";
    openCamera();
  });

  btnSave.addEventListener('click', ()=>{
    if(!currentCode || !lastBlob) return;

    const filename = safeName(currentCode) + ".jpg";
    downloadNow(lastBlob, filename);

    const who = (repName.value || "").trim();
    const note = buildFinalNote();

    const resolved = getRowForPhotoCode(currentCode);
    const ap = resolved ? resolved.ap : "";
    const row = resolved ? resolved.row : null;

    const posters = row ? getPostersFromRow(row) : [];
    const joined  = row ? makeJoinedText(row) : "";

    const now = new Date();
    const entry = {
      ts: now.toISOString().slice(0,19),
      day: isoDate(now),
      who: who,
      ap: ap,
      photoCode: String(currentCode),
      joined: joined,
      posters: posters,
      note: note,
      file: filename
    };
    const log = loadLog();
    log.push(entry);
    saveLog(log);

    // refresh report + tasks
    renderReport();
    if(apInput.value.trim()) renderTasksForAP(apInput.value.trim());

    // reset photo UI
    lastBlob = null;
    preview.style.display = "none";
    preview.src = "";
    afterPhoto.style.display = "none";
    noteInput.value = "";
    setCode("");

    // express pick nech ostane (aby mohol foti≈• e≈°te ƒèal≈°ie v r√°mci tej istej plochy),
    // ale keƒè d√° "Skenova≈• nov√©", resetneme to.
    updateAllDoneToast();
  });

  btnNextScan.addEventListener('click', ()=>{
    lastBlob = null;
    preview.style.display = "none";
    preview.src = "";
    afterPhoto.style.display = "none";
    noteInput.value = "";
    setCode("");

    // reset express v√Ωber pri novom kole
    expressPick = new Set();
    updateAllDoneToast();

    startScan();
  });

  btnLookup.addEventListener('click', ()=> showPostersFor(lookupCode.value));
  lookupCode.addEventListener('keydown', (e)=>{ if(e.key==="Enter") btnLookup.click(); });

  btnShowReport.addEventListener('click', renderReport);
  btnExportCsv.addEventListener('click', exportCsv);
  btnClearDay.addEventListener('click', clearDay);
  btnClearAll.addEventListener('click', clearAll);

  btnLoadTasks.addEventListener('click', ()=>{
    const ap = apInput.value.trim();
    if(!ap) return;
    renderTasksForAP(ap);
  });
  apInput.addEventListener('keydown', (e)=>{ if(e.key==="Enter") btnLoadTasks.click(); });

  // init
  setCode("");
  loadDbXlsx();

  repDate.value = (new Date()).toISOString().slice(0,10);
  repName.value = localStorage.getItem(REP_KEY) || "";
  repName.addEventListener('change', ()=> localStorage.setItem(REP_KEY, repName.value.trim()));
  renderReport();
</script>
</body>
</html>
